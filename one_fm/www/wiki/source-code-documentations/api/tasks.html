<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.10.0" />
<title>api.tasks API documentation</title>
<meta name="description" content="" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>api.tasks</code></h1>
</header>
<section id="section-intro">
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">import itertools
from datetime import timedelta
from string import Template
from calendar import month, monthrange
from datetime import datetime, timedelta
from frappe import enqueue
import frappe, erpnext
from frappe import _
from frappe.model.workflow import apply_workflow
from frappe.utils import (
        now_datetime,nowtime, cstr, getdate, get_datetime, cint, add_to_date,
        datetime, today, add_days, now
)
from one_fm.api.doc_events import get_employee_user_id
from hrms.payroll.doctype.payroll_entry.payroll_entry import get_end_date
from one_fm.api.doc_methods.payroll_entry import auto_create_payroll_entry
from one_fm.utils import (mark_attendance, get_holiday_today, production_domain, get_today_leaves)
from one_fm.api.v1.roster import get_current_shift
from one_fm.processor import sendemail
from one_fm.api.api import push_notification_for_checkin, push_notification_rest_api_for_checkin
from one_fm.operations.doctype.employee_checkin_issue.employee_checkin_issue import approve_open_employee_checkin_issue

class DeltaTemplate(Template):
        delimiter = &#34;%&#34;

def strfdelta(tdelta, fmt):
        d = {&#34;D&#34;: tdelta.days}
        hours, rem = divmod(tdelta.seconds, 3600)
        minutes, seconds = divmod(rem, 60)
        d[&#34;H&#34;] = &#39;{:02d}&#39;.format(hours)
        d[&#34;M&#34;] = &#39;{:02d}&#39;.format(minutes)
        d[&#34;S&#34;] = &#39;{:02d}&#39;.format(seconds)
        t = DeltaTemplate(fmt)
        return t.substitute(**d)

@frappe.whitelist()
def send_checkin_hourly_reminder():
        now_time = now_datetime().strftime(&#34;%Y-%m-%d %H:%M&#34;)
        shifts_list = get_active_shifts(now_time)

        title = &#34;Hourly Reminder&#34;
        category = &#34;Attendance&#34;
        #Send notifications to employees assigned to a shift for hourly checkin
        for shift in shifts_list:
                if strfdelta(shift.start_time, &#39;%H:%M:%S&#39;) != cstr(get_datetime(now_time).time()) and strfdelta(shift.end_time, &#39;%H:%M:%S&#39;) != cstr(get_datetime(now_time).time()):
                        date = getdate() if shift.start_time &lt; shift.end_time else (getdate() - timedelta(days=1))
                        recipients = frappe.db.sql(&#34;&#34;&#34;
                                SELECT DISTINCT emp.user_id FROM `tabShift Assignment` tSA, `tabEmployee` emp
                                WHERE
                                        tSA.employee = emp.name
                                AND tSA.start_date=&#39;{date}&#39;
                                AND tSA.shift_type=&#39;{shift_type}&#39;
                                AND tSA.docstatus=1
                        &#34;&#34;&#34;.format(date=cstr(date), shift_type=shift.name), as_list=1)
                        recipients = [recipient[0] for recipient in recipients if recipient[0]]

                        subject = _(&#34;Hourly Reminder: Please checkin&#34;)
                        message = _(&#39;&lt;a class=&#34;btn btn-warning&#34; href=&#34;/app/face-recognition&#34;&gt;Hourly Check In&lt;/a&gt;&#39;)
                        send_notification(title, subject, message, category, recipients)

def checkin_checkout_initial_reminder():
        &#34;&#34;&#34;
        This function sends a push notification to users to remind them to checkin/checkout at the start/end time of their shift.
        &#34;&#34;&#34;
        try:
                if not frappe.db.get_single_value(&#39;HR and Payroll Additional Settings&#39;, &#39;remind_employee_checkin_checkout&#39;) and not production_domain():
                        return

                # Get current date and time
                now_time = now_datetime().strftime(&#34;%Y-%m-%d %H:%M&#34;)

                # Get list of active shifts
                shifts_list = get_active_shifts(now_time)

                frappe.enqueue(schedule_initial_reminder, shifts_list=shifts_list, now_time=now_time, is_async=True, queue=&#39;long&#39;)

        except Exception as error:
                frappe.log_error(str(error), &#39;Checkin/checkout initial reminder failed&#39;)

def schedule_initial_reminder(shifts_list, now_time):
        notification_title = _(&#34;Checkin/Checkout reminder&#34;)
        notification_subject_in = _(&#34;Don&#39;t forget to Checkin!&#34;)
        notification_subject_out = _(&#34;Don&#39;t forget to CheckOut!&#34;)

        for shift in shifts_list:
                date = getdate()
                if shift.start_time &lt; shift.end_time and nowtime() &lt; cstr(shift.start_time):
                        date = getdate() - timedelta(days=1)

                # Current time == shift start time =&gt; Checkin
                if strfdelta(shift.start_time, &#39;%H:%M:%S&#39;) == cstr((get_datetime(now_time)).time()):
                        recipients = checkin_checkout_query(date=cstr(date), shift_type=shift.name, log_type=&#34;IN&#34;)
                        if len(recipients) &gt; 0:
                                notify_checkin_checkout_final_reminder(recipients=recipients,log_type=&#34;IN&#34;, notification_title= notification_title, notification_subject=notification_subject_in)

                # current time == shift end time =&gt; Checkout
                if strfdelta(shift.end_time, &#39;%H:%M:%S&#39;) == cstr((get_datetime(now_time)).time()):
                        recipients = checkin_checkout_query(date=cstr(date), shift_type=shift.name, log_type=&#34;OUT&#34;)

                        if len(recipients) &gt; 0:
                                notify_checkin_checkout_final_reminder(recipients=recipients,log_type=&#34;OUT&#34;, notification_title= notification_title, notification_subject=notification_subject_out)

def checkin_checkout_final_reminder():
        &#34;&#34;&#34;
        This function sends a final notification to users to remind them to checkin/checkout.
        &#34;&#34;&#34;
        try:
                if not frappe.db.get_single_value(&#39;HR and Payroll Additional Settings&#39;, &#39;remind_employee_checkin_checkout&#39;) and not production_domain():
                        return

                now_time = now_datetime().strftime(&#34;%Y-%m-%d %H:%M&#34;)
                shifts_list = get_active_shifts(now_time)

                #Send final reminder to checkin or checkout to employees who have not even after shift has ended
                frappe.enqueue(schedule_final_notification, shifts_list=shifts_list, now_time=now_time, is_async=True, queue=&#39;long&#39;)
        except Exception as error:
                frappe.log_error(str(error), &#39;Checkin/checkout final reminder failed&#39;)

def schedule_final_notification(shifts_list, now_time):
        notification_title = _(&#34;Final Reminder&#34;)
        notification_subject_in =  _(&#34;Please checkin within the next 3 hours or you will be marked absent.&#34;)
        notification_subject_out =  _(&#34;Please checkout in the next five minutes.&#34;)


        for shift in shifts_list:
                date = getdate()
                if shift.start_time &lt; shift.end_time and nowtime() &lt; cstr(shift.start_time):
                        date = getdate() - timedelta(days=1)
                # shift_start is equal to now time - notification reminder in mins
                # Employee won&#39;t receive checkin notification when accepted Arrive Late shift permission is present
                if (strfdelta(shift.start_time, &#39;%H:%M:%S&#39;) == cstr((get_datetime(now_time) - timedelta(minutes=cint(shift.notification_reminder_after_shift_start))).time())) or (shift.has_split_shift == 1 and strfdelta(shift.second_shift_start_time, &#39;%H:%M:%S&#39;) == cstr((get_datetime(now_time) - timedelta(minutes=cint(shift.notification_reminder_after_shift_start))).time())):
                        recipients = checkin_checkout_query(date=cstr(date), shift_type=shift.name, log_type=&#34;IN&#34;)

                        if len(recipients) &gt; 0:
                                notify_checkin_checkout_final_reminder(recipients=recipients,log_type=&#34;IN&#34;, notification_title= notification_title, notification_subject=notification_subject_in, is_after_grace_checkin=1)

                # shift_end is equal to now time - notification reminder in mins
                # Employee won&#39;t receive checkout notification when accepted Leave Early shift permission is present
                if (strfdelta(shift.end_time, &#39;%H:%M:%S&#39;) == cstr((get_datetime(now_time)- timedelta(minutes=cint(shift.notification_reminder_after_shift_end))).time())) or (shift.has_split_shift == 1 and strfdelta(shift.first_shift_end_time, &#39;%H:%M:%S&#39;) == cstr((get_datetime(now_time) - timedelta(minutes=cint(shift.notification_reminder_after_shift_end))).time())):
                        recipients = checkin_checkout_query(date=cstr(date), shift_type=shift.name, log_type=&#34;OUT&#34;)

                        if len(recipients) &gt; 0:
                                notify_checkin_checkout_final_reminder(recipients=recipients, log_type=&#34;OUT&#34;, notification_title=notification_title, notification_subject=notification_subject_out)

#This function is the combination of two types of notification, email/log notifcation and push notification
@frappe.whitelist()
def notify_checkin_checkout_final_reminder(recipients, log_type, notification_title, notification_subject,  is_after_grace_checkin=0):
        &#34;&#34;&#34;
        params:
        recipients: Dictionary consist of user ID and Emplloyee ID eg: [{&#39;user_id&#39;: &#39;s.shaikh@armor-services.com&#39;, &#39;name&#39;: &#39;HR-EMP-00001&#39;}]
        log_type: In or Out
        &#34;&#34;&#34;
        #defining the subject and message
        notification_category = &#34;Attendance&#34;

        checkin_message_body = &#34;&#34;&#34;
                                        &lt;a class=&#34;btn btn-success&#34; href=&#34;/app/face-recognition&#34;&gt;Check In&lt;/a&gt;&amp;nbsp;
                                        &lt;br/&gt;
                                        Submit a Shift Permission if you are planing to arrive late or forgot to checkin
                                        &lt;a class=&#34;btn btn-primary&#34; href=&#34;/app/shift-permission/new-shift-permission-1?log_type=IN&amp;&amp;permission_type=Arrive Late&#34;&gt;Submit Shift Permission&lt;/a&gt;&amp;nbsp;
                                        &lt;br/&gt;
                                        Submit a Employee Checkin Issue if there are issues in checkin
                                        &lt;a class=&#34;btn btn-secondary&#34; href=&#34;/app/employee-checkin-issue/new-employee-checkin-issue-1?log_type=IN&#34;&gt;Submit Employee Checkin Issue&lt;/a&gt;&amp;nbsp;
                                        &lt;br/&gt;
                                        &lt;h3&gt;{0}&lt;/h3&gt;
                                        &#34;&#34;&#34;
        checkin_message = _(checkin_message_body.format(&#34;DON&#39;T FORGET TO CHECKIN&#34;))

        if is_after_grace_checkin:
                checkin_message = _(checkin_message_body.format(&#34;IF YOU DO NOT CHECK-IN WITHIN THE NEXT 3 HOURS, YOU WOULD BE MARKED AS ABSENT&#34;))

        checkout_message = _(&#34;&#34;&#34;
                &lt;a class=&#34;btn btn-danger&#34; href=&#34;/app/face-recognition&#34;&gt;Check Out&lt;/a&gt;
                &lt;br/&gt;
                Submit a Shift Permission if you are planing to leave early or forget to checkout
                &lt;a class=&#34;btn btn-primary&#34; href=&#34;/app/shift-permission/new-shift-permission-1?log_type=OUT&amp;&amp;permission_type=Leave Early&#34;&#34;&gt;Submit Shift Permission&lt;/a&gt;&amp;nbsp;
                &lt;br/&gt;
                Submit a Employee Checkin Issue if there are issues in checkout
                &lt;a class=&#34;btn btn-secondary&#34; href=&#34;/app/employee-checkin-issue/new-employee-checkin-issue-1?log_type=OUT&#34;&gt;Submit Employee Checkin Issue&lt;/a&gt;&amp;nbsp;
                &#34;&#34;&#34;)

        user_id_list = []

        #eg: recipient: {&#39;user_id&#39;: &#39;s.shaikh@armor-services.com&#39;, &#39;name&#39;: &#39;HR-EMP-00001&#39;}
        for recipient in recipients:
                # Append the list of user ID to send notification through email.
                user_id_list.append(recipient.user_id)

                # Get Employee ID and User Role for the given recipient
                employee_id = recipient.name
                user_roles = frappe.get_roles(recipient.user_id)

                #cutomizing buttons according to log type.
                # check if employee yet to have record for attendance
                if log_type==&#34;IN&#34;:
                        #arrive late button is true only if the employee has the user role &#34;Head Office Employee&#34;.
                        if &#34;Head Office Employee&#34; in user_roles:
                                push_notification_rest_api_for_checkin(employee_id, notification_title, notification_subject, checkin=True,arriveLate=True,checkout=False)
                        else:
                                push_notification_rest_api_for_checkin(employee_id, notification_title, notification_subject, checkin=True,arriveLate=False,checkout=False)
                if log_type==&#34;OUT&#34;:
                        push_notification_rest_api_for_checkin(employee_id, notification_title, notification_subject, checkin=False,arriveLate=False,checkout=True)


        # send notification mail to list of employee using user_id
        if log_type == &#34;IN&#34;:
                send_notification(notification_title, notification_subject, checkin_message,notification_category,user_id_list)
        elif log_type == &#34;OUT&#34;:
                send_notification(notification_title, notification_subject, checkout_message, notification_category, user_id_list)

@frappe.whitelist()
def checkin_checkout_supervisor_reminder():
        if not frappe.db.get_single_value(&#39;HR and Payroll Additional Settings&#39;, &#39;remind_employee_checkin_checkout&#39;) and not production_domain():
                return

        now_time = now_datetime().strftime(&#34;%Y-%m-%d %H:%M&#34;)
        today_datetime = today()
        shifts_list = get_active_shifts(now_time)

        for shift in shifts_list:
                &#34;&#34;&#34;
                        Send notification to supervisor of those who haven&#39;t checked in and don&#39;t have accepted shift permission
                        with permission type Arrive Late/Forget to Checkin/Checkin Issue
                &#34;&#34;&#34;
                frappe.enqueue(supervisor_reminder,shift = shift,today_datetime = today_datetime ,now_time=now_time, is_async=True, queue=&#39;long&#39;)

def supervisor_reminder(shift, today_datetime, now_time):
        title = &#34;Checkin Report&#34;
        category = &#34;Attendance&#34;
        date = getdate()
        if shift.start_time &lt; shift.end_time and nowtime() &lt; cstr(shift.start_time):
                date = getdate() - timedelta(days=1)

        if (strfdelta(shift.start_time, &#39;%H:%M:%S&#39;) == cstr((get_datetime(now_time) - timedelta(minutes=cint(shift.supervisor_reminder_shift_start))).time())) or (shift.has_split_shift == 1 and strfdelta(shift.second_shift_start_time, &#39;%H:%M:%S&#39;) == cstr((get_datetime(now_time) - timedelta(minutes=cint(shift.supervisor_reminder_shift_start))).time())):
                checkin_time = today_datetime + &#34; &#34; + strfdelta(shift.start_time, &#39;%H:%M:%S&#39;)
                recipients = checkin_checkout_query(date=cstr(date), shift_type=shift.name, log_type=&#34;IN&#34;)

                if len(recipients) &gt; 0:
                        for recipient in recipients:
                                action_user, Role = get_action_user(recipient.name,recipient.shift)
                                #for_user = get_employee_user_id(recipient.reports_to) if get_employee_user_id(recipient.reports_to) else get_notification_user(op_shift)
                                subject = _(&#34;{employee} has not checked in yet.&#34;.format(employee=recipient.employee_name))
                                action_message = _(&#34;&#34;&#34;
                                Submit a Shift Permission for the employee to give an excuse and not need to penalize
                                &lt;a class=&#34;btn btn-primary&#34; href=&#34;/app/shift-permission/new-shift-permission-1&#34;&gt;Submit Shift Permission&lt;/a&gt;&amp;nbsp;
                                &lt;br/&gt;&lt;br/&gt;
                                Issue penalty for the employee
                                &lt;a class=&#39;btn btn-primary btn-danger no-punch-in&#39; id=&#39;{employee}_{date}_{shift}&#39; href=&#34;/app/penalty-issuance/new-penalty-issuance-1&#34;&gt;Issue Penalty&lt;/a&gt;
                                &#34;&#34;&#34;).format(shift=recipient.shift, date=cstr(now_time), employee=recipient.name, time=checkin_time)
                                if action_user is not None:
                                        send_notification(title, subject, action_message, category, [action_user])

                                notify_message = _(&#34;&#34;&#34;Note that {employee} from Shift {shift} has Not Checked in yet.&#34;&#34;&#34;).format(employee=recipient.employee_name, shift=recipient.shift)
                                if Role:
                                        notify_user = get_notification_user(recipient.name,recipient.shift, Role)
                                        if notify_user is not None:
                                                send_notification(title, subject, notify_message, category, notify_user)

        &#34;&#34;&#34;
                Send notification to supervisor of those who haven&#39;t checked in and don&#39;t have accepted shift permission
                with permission type Leave Early/Forget to Checkout/Checkout Issue
        &#34;&#34;&#34;
        if (strfdelta(shift.end_time, &#39;%H:%M:%S&#39;) == cstr((get_datetime(now_time) - timedelta(minutes=cint(shift.supervisor_reminder_start_ends))).time())) or (shift.has_split_shift == 1 and strfdelta(shift.first_shift_end_time, &#39;%H:%M:%S&#39;) == cstr((get_datetime(now_time) - timedelta(minutes=cint(shift.supervisor_reminder_end_start))).time())):
                checkout_time = today_datetime + &#34; &#34; + strfdelta(shift.end_time, &#39;%H:%M:%S&#39;)

                recipients = recipients = checkin_checkout_query(date=cstr(date), shift_type=shift.name, log_type=&#34;OUT&#34;)

                if len(recipients) &gt; 0:
                        for recipient in recipients:
                                action_user, Role = get_action_user(recipient.name,recipient.shift)
                                #for_user = get_employee_user_id(recipient.reports_to) if get_employee_user_id(recipient.reports_to) else get_notification_user(op_shift)
                                subject = _(&#39;{employee} has not checked out yet.&#39;.format(employee=recipient.employee_name))
                                action_message = _(&#34;&#34;&#34;
                                        Submit a Shift Permission for the employee to give an excuse and not need to penalize
                                        &lt;a class=&#34;btn btn-primary&#34; href=&#34;/app/shift-permission/new-shift-permission-1&#34;&gt;Submit Shift Permission&lt;/a&gt;&amp;nbsp;
                                        &lt;br/&gt;&lt;br/&gt;
                                        Issue penalty for the employee
                                        &lt;a class=&#39;btn btn-primary btn-danger no-punch-in&#39; id=&#39;{employee}_{date}_{shift}&#39; href=&#34;/app/penalty-issuance/new-penalty-issuance-1&#34;&gt;Issue Penalty&lt;/a&gt;
                                        &#34;&#34;&#34;).format(shift=recipient.shift, date=cstr(now_time), employee=recipient.name, time=checkout_time)
                                if action_user is not None:
                                                send_notification(title, subject, action_message, category, [action_user])

                                notify_message = _(&#34;&#34;&#34;Note that {employee} from Shift {shift} has Not Checked Out yet.&#34;&#34;&#34;).format(employee=recipient.employee_name, shift=recipient.shift)
                                if Role:
                                                notify_user = get_notification_user(recipient.name,recipient.shift, Role)
                                                if notify_user is not None:
                                                        send_notification(title, subject, notify_message, category, notify_user)
@frappe.whitelist()
def send_notification(title, subject, message, category, recipients):
        for user in recipients:
                notification = frappe.new_doc(&#34;Notification Log&#34;)
                notification.title = title
                notification.subject = subject
                notification.email_content = message
                notification.document_type = &#34;Notification Log&#34;
                notification.for_user = user
                notification.document_name = &#34; &#34;
                notification.category = category
                notification.one_fm_mobile_app = 1
                notification.save(ignore_permissions=True)
                notification.document_name = notification.name
                notification.save(ignore_permissions=True)
                frappe.db.commit()

def get_active_shifts(now_time):
        return frappe.db.sql(&#34;&#34;&#34;
                SELECT
                        name, start_time, end_time,
                        has_split_shift, first_shift_end_time, second_shift_start_time,
                        notification_reminder_after_shift_start, late_entry_grace_period,
                        notification_reminder_after_shift_end, allow_check_out_after_shift_end_time,
                        supervisor_reminder_shift_start, supervisor_reminder_start_ends, deadline
                FROM `tabShift Type`
                WHERE
                        CAST(&#39;{current_time}&#39; as date)
                        BETWEEN
                                CAST(start_time as date)
                        AND
                                IF(end_time &lt; start_time, DATE_ADD(CAST(end_time as date), INTERVAL 1 DAY), CAST(end_time as date))
        &#34;&#34;&#34;.format(current_time=now_time), as_dict=1)

def checkin_checkout_query(date, shift_type, log_type):
        if log_type == &#34;IN&#34;:
                permission_type = (&#34;Arrive Late&#34;, &#34;Forget to Checkin&#34;, &#34;Checkin Issue&#34;)
        else:
                permission_type = (&#34;Leave Early&#34;, &#34;Forget to Checkout&#34;, &#34;Checkout Issue&#34;)

        query = frappe.db.sql(&#34;&#34;&#34;SELECT DISTINCT emp.user_id, emp.name , emp.employee_name, emp.holiday_list, tSA.shift
                                        FROM `tabShift Assignment` tSA, `tabEmployee` emp
                                        WHERE
                                                tSA.employee=emp.name
                                        AND tSA.start_date=&#39;{date}&#39;
                                        AND tSA.shift_type=&#39;{shift_type}&#39;
                                        AND tSA.docstatus=1
                                        AND tSA.start_date NOT IN
                                        (SELECT holiday_date from `tabHoliday` h
                                        WHERE
                                                h.parent = emp.holiday_list
                                        AND h.holiday_date = &#39;{date}&#39;)
                                        AND emp.name NOT IN
                                        (SELECT employee FROM `tabShift Permission` emp_sp
                                                WHERE
                                                        emp_sp.workflow_state=&#39;Approved&#39;
                                                AND emp_sp.shift_type=&#39;{shift_type}&#39;
                                                AND emp_sp.date=&#39;{date}&#39;
                                                AND emp_sp.permission_type IN {permission_type}
                                        UNION ALL
                                        SELECT employee FROM `tabAttendance Request` att_req
                                                WHERE
                                                        att_req.workflow_state=&#39;Approved&#39;
                                                AND att_req.reason=&#39;Work From Home&#39;
                                                AND CAST(&#39;{date} &#39; as date) BETWEEN att_req.from_date AND att_req.to_date
                                        UNION ALL
                                        SELECT employee FROM `tabLeave Application` LA
                                                WHERE
                                                        LA.workflow_state=&#39;Approved&#39;
                                                AND CAST(&#39;{date} &#39; as date) BETWEEN LA.from_date AND LA.to_date
                                        UNION ALL
                                        SELECT employee FROM `tabEmployee Checkin` empChkin
                                                WHERE
                                                        empChkin.log_type=&#39;{log_type}&#39;
                                                AND empChkin.skip_auto_attendance=0
                                                AND date(empChkin.time)=&#39;{date}&#39;
                                                AND empChkin.shift_type=&#39;{shift_type}&#39;)
                                        &#34;&#34;&#34;.format(date=cstr(date), shift_type=shift_type, log_type=log_type, permission_type=permission_type), as_dict=1)
        return query

@frappe.whitelist()
def get_action_user(employee, shift):
        &#34;&#34;&#34;
                        Shift &gt; Site &gt; Project &gt; Reports to
        &#34;&#34;&#34;
        action_user = None
        Role = None

        operations_shift = frappe.get_doc(&#34;Operations Shift&#34;, shift)
        operations_site = frappe.get_doc(&#34;Operations Site&#34;, operations_shift.site)
        project = frappe.get_doc(&#34;Project&#34;, operations_site.project)
        report_to = frappe.get_value(&#34;Employee&#34;, {&#34;name&#34;:employee},[&#34;reports_to&#34;])
        current_user = frappe.get_value(&#34;Employee&#34;, {&#34;name&#34;:employee},[&#34;user_id&#34;])

        if report_to:
                action_user = get_employee_user_id(report_to)
                Role = &#34;Report To&#34;
        else:
                if operations_shift.supervisor:
                        shift_supervisor = get_employee_user_id(operations_shift.supervisor)
                        if shift_supervisor != operations_shift.owner and shift_supervisor != current_user:
                                action_user = shift_supervisor
                                Role = &#34;Shift Supervisor&#34;

                elif operations_site.account_supervisor:
                        site_supervisor = get_employee_user_id(operations_site.account_supervisor)
                        if site_supervisor != operations_shift.owner and site_supervisor != current_user:
                                action_user = site_supervisor
                                Role = &#34;Site Supervisor&#34;

                elif operations_site.project:
                        if project.account_manager:
                                project_manager = get_employee_user_id(project.account_manager)
                                if project_manager != operations_shift.owner and project_manager != current_user:
                                        action_user = project_manager
                                        Role = &#34;Project Manager&#34;

        return action_user, Role

def issue_penalties():
        &#34;&#34;&#34;This function to issue penalty to employee if employee checkin late without Shift Permission to Arrive Late.
        Also, if employee check out early withou Shift Permission to Leave Early
        &#34;&#34;&#34;
        # check if issue_penalty is enabled in the setting
        if not frappe.db.get_single_value(&#39;HR and Payroll Additional Settings&#39;, &#39;issue_penalty&#39;):
                return

        #Define the constant
        penalty_code_late_checkin = &#34;102&#34;
        penalty_code_early_checkout=&#34;103&#34;
        date = cstr(getdate())

        #Fetch the day&#39;s attendance
        attendance_list = frappe.get_list(&#34;Attendance&#34;,{&#34;attendance_date&#34;:date},[&#34;*&#34;])

        for attendance in attendance_list:
                #fetch location of the shift.
                location = get_location(attendance.operations_shift)

                if location:
                        penalty_location = str(location[0].latitude)+&#34;,&#34;+str(location[0].longitude)
                else:
                        penalty_location =&#34;0,0&#34;

                #Fetch Supervisor
                action_user, Role = get_action_user(attendance.employee,attendance.operations_shift)
                if Role:
                        issuing_user = get_notification_user(attendance.employee,attendance.operations_shift,Role) if get_notification_user(attendance.employee,attendance.operations_shift,Role) else get_employee_user_id(frappe.get_value(&#34;Employee&#34;,{&#34;name&#34;:attendance.employee},[&#39;reports_to&#39;]))
                else:
                        issuing_user= get_employee_user_id(frappe.get_value(&#34;Employee&#34;,{&#34;name&#34;:attendance.employee},[&#39;reports_to&#39;]))

                #Check if Shift Permission exists.
                shift_permission_late_entry = frappe.db.exists(&#34;Shift Permission&#34;,{&#39;employee&#39;:attendance.employee,&#34;date&#34;:date, &#34;permission_type&#34;:&#34;Arrive Late&#34;})
                shift_permission_early_exit = frappe.db.exists(&#34;Shift Permission&#34;,{&#39;employee&#39;:attendance.employee,&#34;date&#34;:date, &#34;permission_type&#34;:&#34;Leave Early&#34;})

                if attendance.late_entry == 1 and not shift_permission_late_entry:
                        issue_penalty(attendance.employee, now_datetime(), penalty_code_late_checkin, attendance.operations_shift, issuing_user, penalty_location)

                if attendance.early_exit == 1 and not shift_permission_early_exit:
                        issue_penalty(attendance.employee, now_datetime(), penalty_code_early_checkout, attendance.operations_shift, issuing_user, penalty_location)

@frappe.whitelist()
def get_notification_user(employee, shift, Role):
        &#34;&#34;&#34;
                        Shift &gt; Site &gt; Project &gt; Reports to
        &#34;&#34;&#34;
        operations_shift = frappe.get_doc(&#34;Operations Shift&#34;, shift)
        operations_site = frappe.get_doc(&#34;Operations Site&#34;, operations_shift.site)
        project = frappe.get_doc(&#34;Project&#34;, operations_site.project)
        project_manager = site_supervisor = shift_supervisor = None

        reports_to = frappe.get_value(&#34;Employee&#34;, {&#34;name&#34;:employee},[&#34;reports_to&#34;])

        if operations_site.project and project.account_manager and get_employee_user_id(project.account_manager) != operations_shift.owner:
                project_manager = get_employee_user_id(project.account_manager)
        if operations_site.account_supervisor and get_employee_user_id(operations_site.account_supervisor) != operations_shift.owner:
                site_supervisor = get_employee_user_id(operations_site.account_supervisor)
        elif operations_shift.supervisor and get_employee_user_id(operations_shift.supervisor) != operations_shift.owner:
                shift_supervisor = get_employee_user_id(operations_shift.supervisor)

        if Role == &#34;Report To&#34; and reports_to:
                notify_user = [get_employee_user_id(reports_to)]
        elif Role == &#34;Shift Supervisor&#34; and site_supervisor and project_manager:
                notify_user = [site_supervisor,project_manager]
        elif Role == &#34;Site Supervisor&#34; and project_manager:
                notify_user = [project_manager]
        else:
                notify_user = []

        return notify_user

def get_location(shift):
        site = frappe.get_value(&#34;Operations Shift&#34;, {&#34;shift_type&#34;:shift}, &#34;site&#34;)
        location= frappe.db.sql(&#34;&#34;&#34;
                        SELECT loc.latitude, loc.longitude, loc.geofence_radius
                        FROM `tabLocation` as loc
                        WHERE
                                loc.name in (SELECT site_location FROM `tabOperations Site` where name=%s)
                        &#34;&#34;&#34;,site, as_dict=1)
        return location

def checkin_deadline():

        if not frappe.db.get_single_value(&#39;HR and Payroll Additional Settings&#39;, &#39;checkin_deadline&#39;):
                return

        now_time = now_datetime().strftime(&#34;%Y-%m-%d %H:%M&#34;)
        shifts_list = get_active_shifts(now_time)

        frappe.enqueue(mark_deadline_attendance, shifts_list=shifts_list, now_time = now_time, is_async=True, queue=&#39;long&#39;)

def mark_deadline_attendance(shifts_list, now_time):
        for shift in shifts_list:
                date = getdate()
                if shift.start_time &lt; shift.end_time and nowtime() &lt; cstr(shift.start_time):
                        date = getdate() - timedelta(days=1)

                if shift.deadline==1:
                        recipients = []
                        if shift.has_split_shift == 1 and (now_time == shift.start_time + ((shift.first_shift_end_time - shift.start_time)/2) or now_time == shift.second_shift_start_time + ((shift.end_time -shift.second_shift_start_time)/2)):
                                start_time_1 = datetime.datetime.strptime(cstr(date)+&#34; &#34;+cstr(shift.start_time - timedelta(minutes=cint(shift.begin_check_in_before_shift_start_time))), &#39;%Y-%m-%d %H:%M:%S&#39;)
                                start_time_2 = datetime.datetime.strptime(cstr(date)+&#34; &#34;+cstr(shift.second_shift_start_time - timedelta(minutes=cint(shift.begin_check_in_before_shift_start_time))), &#39;%Y-%m-%d %H:%M:%S&#39;)
                                recipients = frappe.db.sql(&#34;&#34;&#34;
                                        SELECT DISTINCT emp.name FROM `tabShift Assignment` tSA, `tabEmployee` emp
                                        WHERE
                                                tSA.employee = emp.name
                                        AND tSA.start_date=&#39;{date}&#39;
                                        AND tSA.shift_type=&#39;{shift_type}&#39;
                                        AND tSA.docstatus=1
                                        AND tSA.employee
                                        NOT IN(SELECT employee FROM `tabShift Permission` emp_sp
                                        WHERE
                                                emp_sp.employee=emp.name
                                        AND emp_sp.workflow_state=&#34;Approved&#34;
                                        AND emp_sp.shift_type=&#39;{shift_type}&#39;
                                        AND emp_sp.date=&#39;{date}&#39;
                                        AND emp_sp.permission_type=&#34;Arrive Late&#34;)
                                        AND tSA.employee
                                        NOT IN(SELECT employee FROM `tabAttendance Request` att_req
                                        WHERE
                                                att_req.employee=emp.name
                                        AND att_req.workflow_state=&#39;Approved&#39;
                                        AND att_req.reason=&#39;Work From Home&#39;
                                        AND CAST(&#39;{date} &#39; as date) BETWEEN att_req.from_date AND att_req.to_date)
                                        AND tSA.employee
                                        NOT IN(SELECT employee FROM `tabLeave Application` LA
                                        WHERE
                                                LA.employee=emp.name
                                        AND LA.workflow_state=&#39;Approved&#39;
                                        AND CAST(&#39;{date} &#39; as date) BETWEEN LA.from_date AND LA.to_date)
                                        AND tSA.employee
                                        NOT IN(SELECT employee FROM `tabEmployee Checkin` empChkin
                                        WHERE
                                                empChkin.log_type=&#34;IN&#34;
                                        AND empChkin.skip_auto_attendance=0
                                        AND date(empChkin.time)=&#39;{date}&#39;
                                        AND empChkin.time BETWEEN &#39;{start_time_1}&#39; and &#39;{now_time}&#39;
                                        OR empChkin.time BETWEEN &#39;{start_time_2}&#39; and &#39;{now_time}&#39;
                                        AND empChkin.shift_type=&#39;{shift_type}&#39;)
                                        AND tSA.start_date
                                        NOT IN(SELECT holiday_date from `tabHoliday` h
                                        WHERE
                                                h.parent = emp.holiday_list
                                        AND h.holiday_date = &#39;{date}&#39;)
                                &#34;&#34;&#34;.format(date=cstr(date), shift_type=shift.name, start_time_1 = start_time_1, start_time_2 = start_time_2, now_time = now_time), as_list=1)

                        elif now_time == shift.start_time + ((shift.end_time - shift.start_time)/2):
                                recipients = frappe.db.sql(&#34;&#34;&#34;
                                        SELECT DISTINCT emp.name FROM `tabShift Assignment` tSA, `tabEmployee` emp
                                        WHERE
                                                tSA.employee = emp.name
                                        AND tSA.start_date=&#39;{date}&#39;
                                        AND tSA.shift_type=&#39;{shift_type}&#39;
                                        AND tSA.docstatus=1
                                        AND tSA.employee
                                        NOT IN(SELECT employee FROM `tabShift Permission` emp_sp
                                        WHERE
                                                emp_sp.employee=emp.name
                                        AND emp_sp.workflow_state=&#34;Approved&#34;
                                        AND emp_sp.shift_type=&#39;{shift_type}&#39;
                                        AND emp_sp.date=&#39;{date}&#39;
                                        AND emp_sp.permission_type=&#34;Arrive Late&#34;)
                                        AND tSA.employee
                                        NOT IN(SELECT employee FROM `tabAttendance Request` att_req
                                        WHERE
                                                att_req.employee=emp.name
                                        AND att_req.workflow_state=&#39;Approved&#39;
                                        AND att_req.reason=&#39;Work From Home&#39;
                                        AND CAST(&#39;{date} &#39; as date) BETWEEN att_req.from_date AND att_req.to_date)
                                        AND tSA.employee
                                        NOT IN(SELECT employee FROM `tabLeave Application` LA
                                        WHERE
                                                LA.employee=emp.name
                                        AND LA.workflow_state=&#39;Approved&#39;
                                        AND CAST(&#39;{date} &#39; as date) BETWEEN LA.from_date AND LA.to_date)
                                        AND tSA.employee
                                        NOT IN(SELECT employee FROM `tabEmployee Checkin` empChkin
                                        WHERE
                                                empChkin.log_type=&#34;IN&#34;
                                        AND empChkin.skip_auto_attendance=0
                                        AND date(empChkin.time)=&#39;{date}&#39;
                                        AND empChkin.shift_type=&#39;{shift_type}&#39;)
                                        AND tSA.start_date
                                        NOT IN(SELECT holiday_date from `tabHoliday` h
                                        WHERE
                                                h.parent = emp.holiday_list
                                        AND h.holiday_date = &#39;{date}&#39;)
                                &#34;&#34;&#34;.format(date=cstr(date), shift_type=shift.name), as_list=1)

                        if len(recipients) &gt; 0:
                                employees = [recipient[0] for recipient in recipients if recipient[0]]

                                for employee in employees:
                                        mark_attendance(employee=employee, attendance_date=date, status=&#39;Absent&#39;, shift=shift.name)

                        frappe.db.commit()

def automatic_checkout():
        now_time = now_datetime().strftime(&#34;%Y-%m-%d %H:%M&#34;)
        shifts_list = get_active_shifts(now_time)
        for shift in shifts_list:
                # shift_end is equal to now time - notification reminder in mins
                if strfdelta(shift.end_time, &#39;%H:%M:%S&#39;) == cstr((get_datetime(now_time) - timedelta(minutes=cint(shift.allow_check_out_after_shift_end_time))).time()):
                        date = getdate() if shift.start_time &lt; shift.end_time else (getdate() - timedelta(days=1))
                        recipients = frappe.db.sql(&#34;&#34;&#34;
                                SELECT DISTINCT emp.name FROM `tabShift Assignment` tSA, `tabEmployee` emp
                                WHERE
                                        tSA.employee = emp.name
                                AND tSA.start_date=&#39;{date}&#39;
                                AND tSA.shift_type=&#39;{shift_type}&#39;
                                AND tSA.docstatus=1
                                AND tSA.employee
                                NOT IN(SELECT employee FROM `tabEmployee Checkin` empChkin
                                WHERE
                                        empChkin.log_type=&#34;OUT&#34;
                                AND empChkin.skip_auto_attendance=0
                                AND date(empChkin.time)=&#39;{date}&#39;
                                AND empChkin.shift_type=&#39;{shift_type}&#39;)
                        &#34;&#34;&#34;.format(date=cstr(date), shift_type=shift.name), as_list=1)
                        if len(recipients) &gt; 0:
                                recipients = [recipient[0] for recipient in recipients if recipient[0]]
                                for recipient in recipients:
                                        checkin = frappe.new_doc(&#34;Employee Checkin&#34;)
                                        checkin.employee = recipient
                                        checkin.log_type = &#34;OUT&#34;
                                        checkin.skip_auto_attendance = 0
                                        checkin.save()

                        frappe.db.commit()

@frappe.whitelist()
def issue_penalty(employee, date, penalty_code, shift, issuing_user, penalty_location):
        issuing_employee = frappe.get_value(&#34;Employee&#34;, {&#34;user_id&#34;: issuing_user})
        penalty = frappe.get_value(&#34;Penalty Type&#34;, {&#34;penalty_code&#34; : penalty_code})
        site, project = frappe.get_value(&#34;Operations Shift&#34;, shift, [&#34;site&#34;, &#34;project&#34;])
        site_location = frappe.get_value(&#34;Operations Site&#34;, site, &#34;site_location&#34;)

        employee_id, employee_name, designation = frappe.get_value(&#34;Employee&#34;, employee, [&#34;name&#34;, &#34;employee_name&#34;, &#34;designation&#34;])

        penalty_issuance = frappe.new_doc(&#34;Penalty Issuance&#34;)
        penalty_issuance.issuing_time = now_datetime()
        penalty_issuance.location = penalty_location
        penalty_issuance.penalty_location = &#34;Head Office&#34;
        penalty_issuance.penalty_occurence_time = date
        penalty_issuance.shift = shift
        penalty_issuance.site = site
        penalty_issuance.project = project
        penalty_issuance.site_location = site_location
        penalty_issuance.append(&#34;employees&#34;, {
                &#34;employee_id&#34;: employee_id,
                &#34;employee_name&#34;: employee_name,
                &#34;designation&#34;: designation,
        })
        penalty_issuance.append(&#34;penalty_issuance_details&#34;,{
                &#34;penalty_type&#34;: penalty,
                &#34;exact_notes&#34;: penalty
        })
        penalty_issuance.issuing_employee = issuing_employee
        # penalty_issuance.employee_name = self.lead_name
        penalty_issuance.flags.ignore_permissions = True
        penalty_issuance.insert()
        penalty_issuance.submit()
        frappe.msgprint(_(&#39;A penalty has been issued against {0}&#39;.format(employee_name)))

def fetch_non_shift(date, s_type):
        if s_type == &#34;AM&#34;:
                roster = frappe.db.sql(&#34;&#34;&#34;SELECT @roster_type := &#39;Basic&#39; as roster_type, @start_datetime := &#34;{date} 08:00:00&#34; as start_datetime, @end_datetime := &#34;{date} 17:00:00&#34; as end_datetime,
                                name as employee, employee_name, department, holiday_list, default_shift as shift_type, checkin_location, shift, site from `tabEmployee` E
                                WHERE E.shift_working = 0 AND E.status=&#39;Active&#39;
                                AND E.default_shift IN(
                                        SELECT name from `tabShift Type` st
                                        WHERE st.start_time &gt;= &#39;01:00:00&#39;
                                        AND  st.start_time &lt; &#39;13:00:00&#39;)
                                AND NOT EXISTS(SELECT * from `tabHoliday` h
                                        WHERE
                                                h.parent = E.holiday_list
                                        AND h.holiday_date = &#39;{date}&#39;)
                &#34;&#34;&#34;.format(date=cstr(date)), as_dict=1)
        else:
                roster = frappe.db.sql(&#34;&#34;&#34;SELECT @roster_type := &#39;Basic&#39; as roster_type, name as employee, employee_name, department, holiday_list, default_shift as shift_type, checkin_location, shift, site from `tabEmployee` E
                                WHERE E.shift_working = 0
                                AND E.default_shift IN(
                                        SELECT name from `tabShift Type` st
                                        WHERE st.start_time &lt; &#39;01:00:00&#39; OR st.start_time &gt;= &#39;13:00:00&#39;
                                        )
                                AND NOT EXISTS(SELECT * from `tabHoliday` h
                                        WHERE
                                                h.parent = E.holiday_list
                                        AND h.holiday_date = &#39;{date}&#39;)
                &#34;&#34;&#34;.format(date=cstr(date)), as_dict=1)

        return roster

def assign_am_shift():
        date = cstr(getdate())
        end_previous_shifts(&#34;AM&#34;)
        roster = frappe.db.sql(&#34;&#34;&#34;
                        SELECT * from `tabEmployee Schedule` ES
                        WHERE
                        ES.date = &#39;{date}&#39;
                        AND ES.employee_availability = &#34;Working&#34;
                        AND ES.roster_type = &#34;Basic&#34;
                        AND ES.shift_type IN(
                                SELECT name from `tabShift Type` st
                                WHERE st.start_time &gt;= &#39;01:00:00&#39;
                                AND  st.start_time &lt; &#39;13:00:00&#39;)
        &#34;&#34;&#34;.format(date=cstr(date)), as_dict=1)

        non_shift = fetch_non_shift(date, &#34;AM&#34;)
        if non_shift:
                roster.extend(non_shift)

        create_shift_assignment(roster, date, &#39;AM&#39;)

def assign_pm_shift():
        date = cstr(getdate())
        end_previous_shifts(&#34;PM&#34;)
        roster = frappe.db.sql(&#34;&#34;&#34;
                        SELECT * from `tabEmployee Schedule` ES
                        WHERE
                        ES.date = &#39;{date}&#39;
                        AND ES.employee_availability = &#34;Working&#34;
                        AND ES.roster_type = &#34;Basic&#34;
                        AND ES.shift_type IN(
                                SELECT name from `tabShift Type` st
                                WHERE st.start_time &lt; &#39;01:00:00&#39; OR st.start_time &gt;= &#39;13:00:00&#39;
                                )
        &#34;&#34;&#34;.format(date=cstr(date)), as_dict=1)

        non_shift = fetch_non_shift(date, &#34;PM&#34;)
        if non_shift:
                roster.extend(non_shift)

        create_shift_assignment(roster, date, &#39;PM&#39;)


def end_previous_shifts(time):
        shift_type = get_shift_type(time)
        query = f&#34;&#34;&#34;
                UPDATE `tabShift Assignment`
                SET end_date=DATE(end_datetime)
                WHERE
                end_date IS NULL AND shift_type IN {tuple(shift_type)} AND docstatus=1 AND roster_type in (&#39;Basic&#39;, &#39;Over-Time&#39;)
        ;&#34;&#34;&#34;
        shift_assignments = frappe.db.sql(query, values=[], as_dict=1)
        frappe.db.commit()

def get_shift_type(time):
        if time == &#34;AM&#34;:
                shift_type = frappe.get_list(&#34;Shift Type&#34;, {&#34;start_time&#34;: [&#34;&gt;=&#34;, &#34;00:00&#34;], &#34;start_time&#34;: [&#34;&lt;&#34;, &#34;12:00&#34;]},[&#39;name&#39;], pluck=&#39;name&#39;)
        else:
                shift_type = frappe.get_list(&#34;Shift Type&#34;, {&#34;start_time&#34;: [&#34;&gt;=&#34;, &#34;12:00&#34;]},[&#39;name&#39;], pluck=&#39;name&#39;)
        return shift_type

def create_shift_assignment(roster, date, time):
        try:
                owner = frappe.session.user
                creation = now()
                shift_type = get_shift_type(time)
                shift_types = frappe.db.get_list(&#34;Shift Type&#34;, filters={&#39;name&#39;:[&#39;IN&#39;, shift_type]},
                        fields=[&#39;name&#39;, &#39;shift_type&#39;, &#39;start_time&#39;, &#39;end_time&#39;])
                shift_types_dict = {}
                for i in shift_types:
                        i.start_datetime = f&#34;{date} {(datetime.datetime.min + i.start_time).time()}&#34;
                        if i.end_time.total_seconds() &lt; i.start_time.total_seconds():
                                i.end_datetime = f&#34;{add_days(date, 1)} {(datetime.datetime.min + i.end_time).time()}&#34;
                        else:
                                i.end_datetime = f&#34;{date} {(datetime.datetime.min + i.end_time).time()}&#34;
                        shift_types_dict[i.name] = i
                default_shift = frappe.get_doc(&#34;Shift Type&#34;, &#39;&#34;Standard|Morning|08:00:00-17:00:00|9 hours&#34;&#39;).as_dict()


                existing_shift = frappe.db.get_list(&#34;Shift Assignment&#34;, filters={
                        &#39;start_date&#39;: date,
                        &#39;shift_type&#39;: [&#39;IN&#39;, shift_type],
                        &#39;docstatus&#39;: 1,
                        &#39;roster_type&#39;: [&#39;IN&#39;, [&#39;Basic&#39;]],
                        &#39;status&#39;:&#39;Active&#39;,
                        },
                        fields=[&#39;employee&#39;]
                )

                existing_shift_list = [i.employee for i in existing_shift]
                shift_request = frappe.db.get_list(&#34;Shift Request&#34;, filters={
                        &#39;employee&#39;: [&#39;IN&#39;, [i.employee for i in roster]],
                        &#39;from_date&#39;: [&#39;&lt;=&#39;, date],
                        &#39;to_date&#39;: [&#39;&gt;=&#39;, date],
                        &#39;workflow_state&#39;: &#39;Approved&#39;
                        },
                        fields=[&#39;name&#39;, &#39;employee&#39;, &#39;check_in_site&#39;, &#39;check_out_site&#39;]
                )
                shift_request_dict = {}
                for i in shift_request:
                        shift_request_dict[i.employee] = i

                sites = []
                for i in roster:
                        if not i.site in sites:
                                sites.append(i.site)
                sites_list = frappe.db.get_list(&#34;Operations Site&#34;, filters={&#39;name&#39;: [&#39;IN&#39;, sites]}, fields=[&#39;name&#39;, &#39;site_location&#39;])
                sites_list_dict = {}
                for i in sites_list:
                        sites_list_dict[i.name] = i.site_location

                # remove employees with approved leaves
                todays_leaves = get_today_leaves(str(date))
                roster = [i for i in roster if not i.employee in todays_leaves]
                if roster:
                        query = &#34;&#34;&#34;
                                INSERT INTO `tabShift Assignment` (`name`, `company`, `docstatus`, `employee`, `employee_name`, `shift_type`, `site`, `project`, `status`,
                                `shift_classification`, `site_location`, `start_date`, `start_datetime`, `end_datetime`, `department`,
                                `shift`, `operations_role`, `post_abbrv`, `roster_type`, `owner`, `modified_by`, `creation`, `modified`,
                                `shift_request`, `check_in_site`, `check_out_site`)
                                VALUES
                        &#34;&#34;&#34;
                        # check if all roster has been done
                        has_rostered = []
                        for r in roster:
                                if not r.employee in existing_shift_list:
                                        _shift_type = shift_types_dict.get(r.shift_type) or default_shift

                                        query += f&#34;&#34;&#34;
                                        (
                                                &#34;HR-SHA-{date}-{r.employee}&#34;, &#34;{frappe.defaults.get_user_default(&#39;company&#39;)}&#34;, 1, &#34;{r.employee}&#34;, &#34;{r.employee_name}&#34;, &#39;{r.shift_type}&#39;,
                                                &#34;{r.site or &#39;&#39;}&#34;, &#34;{r.project or &#39;&#39;}&#34;, &#39;Active&#39;, &#34;{_shift_type.shift_type}&#34;, &#34;{sites_list_dict.get(r.site) or &#39;&#39;}&#34;, &#34;{date}&#34;,
                                                &#34;{_shift_type.start_datetime or str(date)+&#39; 08:00:00&#39;}&#34;,
                                                &#34;{_shift_type.end_datetime or str(date)+&#39; 17:00:00&#39;}&#34;, &#34;{r.department}&#34;, &#34;{r.shift or &#39;&#39;}&#34;, &#34;{r.operations_role or &#39;&#39;}&#34;, &#34;{r.post_abbrv or &#39;&#39;}&#34;, &#34;{r.roster_type}&#34;,
                                                &#34;{owner}&#34;, &#34;{owner}&#34;, &#34;{creation}&#34;, &#34;{creation}&#34; &#34;&#34;&#34;
                                        if shift_request_dict.get(r.employee):
                                                _shift_request = shift_request_dict.get(r.employee)
                                                query += f&#34;&#34;&#34;, &#34;{_shift_request.name}&#34;, &#34;{_shift_request.check_in_site}&#34;, &#34;{_shift_request.check_out_site}&#34;), &#34;&#34;&#34;
                                        else:
                                                query += &#34;&#34;&#34;, &#39;&#39;, &#39;&#39;, &#39;&#39;),&#34;&#34;&#34;
                                else:
                                        has_rostered.append(r.employee_name)
                        query = query[:-1]
                        query += f&#34;&#34;&#34;
                                ON DUPLICATE KEY UPDATE
                                modified_by = VALUES(modified_by),
                                docstatus = VALUES(docstatus),
                                modified = &#34;{creation}&#34;,
                                operations_role = VALUES(operations_role),
                                post_abbrv = VALUES(post_abbrv),
                                roster_type = VALUES(roster_type),
                                shift = VALUES(shift),
                                project = VALUES(project),
                                site = VALUES(site),
                                shift_type = VALUES(shift_type),
                                employee = VALUES(employee),
                                employee_name = VALUES(employee_name),
                                site_location = VALUES(site_location),
                                start_datetime = VALUES(start_datetime),
                                end_datetime = VALUES(end_datetime),
                                department = VALUES(department),
                                shift_request = VALUES(shift_request),
                                check_in_site = VALUES(check_in_site),
                                check_out_site = VALUES(check_out_site),
                                shift_classification = VALUES(shift_classification),
                                status = VALUES(status)
                        &#34;&#34;&#34;
                        frappe.db.sql(query, values=[], as_dict=1)
                        frappe.db.commit()

                        if has_rostered:
                                frappe.log_error(str(has_rostered), &#39;Duplicate Shift Assignment&#39;)
        except Exception as e:
                sender = frappe.get_value(&#34;Email Account&#34;, filters = {&#34;default_outgoing&#34;: 1}, fieldname = &#34;email_id&#34;) or None
                recipient = frappe.get_value(&#34;Email Account&#34;, {&#34;name&#34;:&#34;Support&#34;}, [&#34;email_id&#34;])
                msg = frappe.render_template(&#39;one_fm/templates/emails/missing_shift_assignment.html&#39;, context={&#34;rosters&#34;: roster})
                sendemail(sender=sender, recipients= recipient, content=msg, subject=&#34;Shift Assignment Failed&#34;, delay=False)

def validate_am_shift_assignment():
        date = cstr(getdate())
        end_previous_shifts(&#34;PM&#34;)
        roster = frappe.db.sql(&#34;&#34;&#34;
                        SELECT * from `tabEmployee Schedule` ES
                        WHERE
                        ES.date = &#39;{date}&#39;
                        AND ES.employee_availability = &#34;Working&#34;
                        AND ES.roster_type = &#34;Basic&#34;
                        AND ES.shift_type IN(
                                SELECT name from `tabShift Type` st
                                WHERE st.start_time &gt;= &#39;01:00:00&#39;
                                AND  st.start_time &lt; &#39;13:00:00&#39;)
                        AND ES.employee
                        NOT IN (Select employee from `tabShift Assignment` tSA
                        WHERE
                                tSA.employee = ES.employee
                                AND tSA.start_date=&#39;{date}&#39;
                                AND tSA.roster_type = &#34;Basic&#34;
                                AND tSA.shift_type IN(
                                        SELECT name from `tabShift Type` st
                                        WHERE st.start_time &gt;= &#39;01:00:00&#39;
                                        AND  st.start_time &lt; &#39;13:00:00&#39; ))
                        AND ES.employee
                        NOT IN (Select employee from `tabEmployee` E
                        WHERE
                                E.name = ES.employee
                                AND E.status = &#34;Left&#34;)
        &#34;&#34;&#34;.format(date=cstr(date)), as_dict=1)

        non_shift = fetch_non_shift(date, &#34;PM&#34;)
        if non_shift:
                roster.extend(non_shift)

        # remove approved leaves for today
        todays_leaves = get_today_leaves(str(date))
        roster = [i for i in roster if not i.employee in todays_leaves]

        if len(roster)&gt;0:
                sender = frappe.get_value(&#34;Email Account&#34;, filters = {&#34;default_outgoing&#34;: 1}, fieldname = &#34;email_id&#34;) or None
                recipient = frappe.get_value(&#34;Email Account&#34;, {&#34;name&#34;:&#34;Support&#34;}, [&#34;email_id&#34;])
                msg = frappe.render_template(&#39;one_fm/templates/emails/missing_shift_assignment.html&#39;, context={&#34;rosters&#34;: roster})
                sendemail(sender=sender, recipients= recipient, content=msg, subject=&#34;Missed Shift Assignments List&#34;, delay=False)
                frappe.enqueue(create_shift_assignment, roster = roster, date = date, time=&#39;AM&#39;, is_async=True, queue=&#39;long&#39;)

def validate_pm_shift_assignment():
        date = cstr(getdate())
        end_previous_shifts(&#34;PM&#34;)
        roster = frappe.db.sql(&#34;&#34;&#34;
                        SELECT * from `tabEmployee Schedule` ES
                        WHERE
                        ES.date = &#39;{date}&#39;
                        AND ES.employee_availability = &#34;Working&#34;
                        AND ES.roster_type = &#34;Basic&#34;
                        AND ES.shift_type IN(
                                SELECT name from `tabShift Type` st
                                WHERE st.start_time &lt; &#39;01:00:00&#39; OR st.start_time &gt;= &#39;13:00:00&#39;
                                )
                        AND ES.employee
                        NOT IN (Select employee from `tabShift Assignment` tSA
                        WHERE
                                tSA.employee = ES.employee
                                AND tSA.start_date=&#39;{date}&#39;
                                AND tSA.roster_type = &#34;Basic&#34;
                                AND tSA.shift_type IN(
                                        SELECT name from `tabShift Type` st
                                        WHERE st.start_time &lt; &#39;01:00:00&#39; OR st.start_time &gt;= &#39;13:00:00&#39;))
                        AND ES.employee
                        NOT IN (Select employee from `tabEmployee` E
                        WHERE
                                E.name = ES.employee
                                AND E.status = &#34;Left&#34;)
        &#34;&#34;&#34;.format(date=cstr(date)), as_dict=1)
        non_shift = fetch_non_shift(date, &#34;PM&#34;)
        if non_shift:
                roster.extend(non_shift)

        # remove approved leaves for today
        todays_leaves = get_today_leaves(str(date))
        roster = [i for i in roster if not i.employee in todays_leaves]

        if len(roster)&gt;0:
                sender = frappe.get_value(&#34;Email Account&#34;, filters = {&#34;default_outgoing&#34;: 1}, fieldname = &#34;email_id&#34;) or None
                recipient = frappe.get_value(&#34;Email Account&#34;, {&#34;name&#34;:&#34;Support&#34;}, [&#34;email_id&#34;])
                msg = frappe.render_template(&#39;one_fm/templates/emails/missing_shift_assignment.html&#39;, context={&#34;rosters&#34;: roster})
                sendemail(sender=sender, recipients= recipient, content=msg, subject=&#34;Missed Shift Assignments List&#34;, delay=False)
                frappe.enqueue(create_shift_assignment, roster = roster, date = date, time=&#39;PM&#39;, is_async=True, queue=&#39;long&#39;)


def overtime_shift_assignment():
        &#34;&#34;&#34;
        This method is to generate Shift Assignment for Employee Scheduling
        with roster type &#39;Over_Time&#39;. It first looks up for Shift Assignment
        of the employee for the day if he has any. Change the Status to &#34;Inactive&#34;
        and proceeds with creating New shift Assignments with Roster Type OverTime.
        &#34;&#34;&#34;
        date = cstr(getdate())
        now_time = now_datetime().strftime(&#34;%H:%M:00&#34;)
        roster = frappe.get_all(&#34;Employee Schedule&#34;, {&#34;date&#34;: date, &#34;employee_availability&#34;: &#34;Working&#34; , &#34;roster_type&#34;: &#34;Over-Time&#34;}, [&#34;*&#34;])
        frappe.enqueue(process_overtime_shift,roster=roster, date=date, time=now_time, is_async=True, queue=&#39;long&#39;)

def process_overtime_shift(roster, date, time):
        for schedule in roster:
                #Check for employee&#39;s shift assignment of the day, if he has any.
                try:
                        shift_assignment = frappe.get_doc(&#34;Shift Assignment&#34;, {&#34;employee&#34;:schedule.employee, &#34;start_date&#34;: date},[&#34;name&#34;,&#34;shift_type&#34;])
                        if shift_assignment:
                                shift_end_time = frappe.get_value(&#34;Shift Type&#34;,shift_assignment.shift_type, &#34;end_time&#34;)
                                #check if the given shift has ended
                                # Set status inactive before creating new shift
                                if str(shift_end_time) == str(time):
                                        frappe.set_value(&#34;Shift Assignment&#34;, shift_assignment.name,&#39;status&#39;, &#34;Inactive&#34;)
                                        create_overtime_shift_assignment(schedule, date)
                        else:
                                create_overtime_shift_assignment(schedule, date)
                except Exception as e:
                        pass

def create_overtime_shift_assignment(schedule, date):
        if (not frappe.db.exists(&#34;Shift Assignment&#34;,{&#34;employee&#34;:schedule.employee, &#34;start_date&#34;:getdate(date), &#34;status&#34;:&#34;Active&#34;}) and
                        frappe.db.exists(&#39;Employee&#39;, {&#39;employee&#39;:schedule.employee, &#39;status&#39;:&#39;Active&#39;})):
                try:
                        shift_assignment = frappe.new_doc(&#34;Shift Assignment&#34;)
                        shift_assignment.start_date = date
                        shift_assignment.employee = schedule.employee
                        shift_assignment.employee_name = schedule.employee_name
                        shift_assignment.department = schedule.department
                        shift_assignment.operations_role = schedule.operations_role
                        shift_assignment.shift = schedule.shift
                        shift_assignment.site = schedule.site
                        shift_assignment.project = schedule.project
                        shift_assignment.shift_type = schedule.shift_type
                        shift_assignment.operations_role = schedule.operations_role
                        shift_assignment.post_abbrv = schedule.post_abbrv
                        shift_assignment.roster_type = schedule.roster_type
                        shift_assignment.site_location = schedule.checkin_location
                        if frappe.db.exists(&#34;Shift Request&#34;, {&#39;employee&#39;:schedule.employee, &#39;from_date&#39;:[&#39;&lt;=&#39;,date],&#39;to_date&#39;:[&#39;&gt;=&#39;,date]}):
                                shift_request, check_in_site, check_out_site = frappe.get_value(&#34;Shift Request&#34;, {&#39;employee&#39;:schedule.employee, &#39;from_date&#39;:[&#39;&lt;=&#39;,date],&#39;to_date&#39;:[&#39;&gt;=&#39;,date]},[&#34;name&#34;,&#34;check_in_site&#34;,&#34;check_out_site&#34;])
                                shift_assignment.shift_request = shift_request
                                shift_assignment.check_in_site = check_in_site
                                shift_assignment.check_out_site = check_out_site
                        shift_assignment.submit()
                except Exception:
                        frappe.log_error(frappe.get_traceback(), &#34;Create Shift Assignment&#34;)


def update_shift_type():
        today_datetime = now_datetime()
        minute = today_datetime.strftime(&#34;%M&#34;)
        if 0 &lt;= int(minute)-15 &lt; 15:
                now_time = today_datetime.strftime(&#34;%H:15:00&#34;)
        elif 0 &lt;= int(minute)-30 &lt; 15:
                now_time = today_datetime.strftime(&#34;%H:30:00&#34;)
        elif 0 &lt;= int(minute)-45 &lt; 15:
                now_time = today_datetime.strftime(&#34;%H:45:00&#34;)
        else:
                now_time = today_datetime.strftime(&#34;%H:00:00&#34;)
        shift_types = frappe.get_all(&#34;Shift Type&#34;, {&#34;end_time&#34;: now_time},[&#34;name&#34;, &#34;allow_check_out_after_shift_end_time&#34;])
        for shift_type in shift_types:
                last_sync_of_checkin = add_to_date(today_datetime, minutes=cint(shift_type.allow_check_out_after_shift_end_time)+15, as_datetime=True)
                doc = frappe.get_doc(&#34;Shift Type&#34;, shift_type.name)
                doc.last_sync_of_checkin = last_sync_of_checkin
                doc.save()
                frappe.db.commit()

@frappe.whitelist()
def process_attendance():
        now_time = now_datetime().strftime(&#34;%y-%m-%d %H:%M:00&#34;)
        shift_types = frappe.get_all(&#34;Shift Type&#34;, {&#34;last_sync_of_checkin&#34;: now_time})
        for shift_type in shift_types:
                frappe.enqueue(mark_auto_attendance, shift_type, worker=&#39;long&#39;)

def mark_auto_attendance(shift_type):
        doc = frappe.get_doc(&#34;Shift Type&#34;, shift_type.name)
        doc.process_auto_attendance()


def generate_payroll():
        &#39;&#39;&#39;
                Method to generate payroll on 24th of each month(method calling form cron job for 24th in hooks.py)
        &#39;&#39;&#39;
        try:
                auto_create_payroll_entry()
        except Exception:
                frappe.log_error(frappe.get_traceback())

def generate_penalties():
        # start_date = add_to_date(getdate(), months=-1)
        # end_date = get_end_date(start_date, &#39;monthly&#39;)[&#39;end_date&#39;]

        #fetch Payroll date&#39;s day
        date = frappe.db.get_single_value(&#39;HR and Payroll Additional Settings&#39;, &#39;payroll_date&#39;)
        year = getdate().year - 1 if getdate().day &lt; cint(date) and  getdate().month == 1 else getdate().year
        month = getdate().month if getdate().day &gt;= cint(date) else getdate().month - 1

        #calculate Payroll date, start and end date.

        payroll_date = datetime.datetime(year, month, cint(date)).strftime(&#34;%Y-%m-%d&#34;)
        start_date = add_to_date(payroll_date, months=-1)
        end_date = add_to_date(payroll_date, days=-1)

        filters = {
                &#39;penalty_issuance_time&#39;: [&#39;between&#39;, (start_date, end_date)],
                &#39;workflow_state&#39;: &#39;Penalty Accepted&#39;
        }
        logs = frappe.db.get_list(&#39;Penalty&#39;, filters=filters, fields=&#34;*&#34;, order_by=&#34;recipient_employee,penalty_issuance_time&#34;)
        for key, group in itertools.groupby(logs, key=lambda x: (x[&#39;recipient_employee&#39;])):
                employee_penalties = list(group)
                calculate_penalty_amount(key, start_date, end_date, employee_penalties)

def calculate_penalty_amount(employee, start_date, end_date, logs):
        &#34;&#34;&#34;This Funtion Calculates the Penalty Amount based on the occurance and employees basic salary.

        Args:
                employee (String): employee ID
                start_date (date): Start Date of the payroll
                end_date (date): Start Date of the payroll
                logs ([type]): Employee&#39;s Penalty Log
        &#34;&#34;&#34;
        filters = {
                &#39;docstatus&#39;: 1,
                &#39;employee&#39;: employee
        }
        if frappe.db.exists(&#39;Employee&#39;, {&#39;employee&#39;:employee, &#39;status&#39;:&#39;Left&#39;}):
                return

        if frappe.db.get_single_value(&#39;HR and Payroll Additional Settings&#39;, &#39;basic_salary_component&#39;):
                basic_salary_component = frappe.db.get_single_value(&#39;HR and Payroll Additional Settings&#39;, &#39;basic_salary_component&#39;)
        else:
                frappe.throw(&#34;Please Add Basic Salary Component in HR and Payroll Additional Settings.&#34;)

        salary_structure, base = frappe.get_value(&#34;Salary Structure Assignment&#34;, filters, [&#34;salary_structure&#34;,&#34;base&#34;], order_by=&#34;from_date desc&#34;)

        if salary_structure:
                basic = frappe.db.sql(&#34;&#34;&#34;
                SELECT amount,amount_based_on_formula,formula FROM `tabSalary Detail`
                WHERE parenttype=&#34;Salary Structure&#34;
                AND parent=%s
                AND salary_component=%s
                &#34;&#34;&#34;,(salary_structure, basic_salary_component), as_dict=1)
                if basic[0].amount_based_on_formula == 1:
                        formula = basic[0].formula
                        percent = formula.replace(&#39;base*&#39;,&#39;&#39;)
                        basic_salary = int(base)*float(percent)
                else:
                        basic_salary = basic[0].amount

        #Single day salary of employee = Basic Salary(WP salary) divided by 26 days
        single_day_salary = basic_salary / 26

        #Existing balance amount
        existing_balance = 0.00
        if frappe.db.exists(&#34;Penalty Deduction&#34;, {&#39;employee&#39;: employee}):
                existing_balance = frappe.get_value(&#34;Penalty Deduction&#34;, {&#39;employee&#39;: employee}, &#34;balance_amount&#34;, order_by=&#39;posting_time desc&#39;)

        #Calculate new amount
        references =  &#39;, &#39;.join([&#39;&#34;{}&#34;&#39;.format(log.name) for log in logs])

        # references = &#39;&#34;HR-EMP-00002-006&#34;, &#34;HR-EMP-00002-004&#34;&#39;
        damages_amount = frappe.db.sql(&#34;&#34;&#34;
                SELECT sum(py.damage_amount) as damages_amount, py.name
                FROM `tabPenalty` as py
                WHERE py.name in ({refs})
        &#34;&#34;&#34;.format(refs=references), as_dict=1)

        days_deduction = frappe.db.sql(&#34;&#34;&#34;
                SELECT sum(pd.deduction) as days_deduction, pd.name
                FROM `tabPenalty Issuance Details` as pd
                WHERE
                        pd.parenttype=&#34;Penalty&#34;
                AND pd.parent in ({refs})
        &#34;&#34;&#34;.format(refs=references), as_dict=1)

        # Days deduction
        days_deduction_amount = days_deduction[0].days_deduction * single_day_salary

        # Damages amount
        damages_amount = damages_amount[0].damages_amount

        # Sum of previous balance amount, days deduction amount and damages amount
        total_penalty_amount = existing_balance + days_deduction_amount + damages_amount

        # Maxmimum allowed deductible salary according to Kuwaiti law (5 days for penalties)
        max_amount = single_day_salary * 5

        #Amount to be deducted this time
        if total_penalty_amount &gt; max_amount:
                deducted_amount = max_amount
                balance_amount = total_penalty_amount - max_amount
        else:
                deducted_amount = total_penalty_amount
                balance_amount = 0

        #Create Penalty Deduction Doc that in return creates Addition Salary with penalty component.
        create_penalty_deduction(start_date, end_date, employee, total_penalty_amount, single_day_salary, max_amount, deducted_amount, balance_amount)


def create_penalty_deduction(start_date, end_date, employee, total_penalty_amount, single_day_amount, max_amount, deducted_amount, balance_amount):
        penalty_deduction = frappe.new_doc(&#34;Penalty Deduction&#34;)
        penalty_deduction.posting_time = get_datetime()
        penalty_deduction.employee = employee
        penalty_deduction.from_date = start_date
        penalty_deduction.to_date = end_date
        penalty_deduction.total_penalty_amount = total_penalty_amount
        penalty_deduction.single_day_amount = single_day_amount
        penalty_deduction.maximum_amount = max_amount
        penalty_deduction.deducted_amount = deducted_amount
        penalty_deduction.balance_amount = balance_amount
        penalty_deduction.insert()
        penalty_deduction.submit()
        frappe.db.commit()

#this function is to generate Site Allowance as Earing Component in Salary Slip. It is monthly calculated based on employees attendance
def generate_site_allowance():
        #get list of all site that includes Site Allowance.
        operations_site = frappe.get_all(&#34;Operations Site&#34;, {&#34;include_site_allowance&#34;:&#34;1&#34;},[&#34;name&#34;,&#34;allowance_amount&#34;])

        #Gather the required Date details such as start date, and respective end date. Get current year and month to get the no. of days in the current month.
        start_date = add_to_date(getdate(), months=-1)
        end_date = get_end_date(start_date, &#39;monthly&#39;)[&#39;end_date&#39;]
        currentMonth = datetime.datetime.now().month
        currentYear = datetime.datetime.now().year
        no_of_days = monthrange(currentYear, currentMonth)[1]

        #generate site allowance for each site. Gets the employee and his/her respective no. of days in a given site.
        if operations_site:
                        for site in operations_site:
                                employee_det = frappe.db.sql(&#34;&#34;&#34;
                                                        SELECT employee,count(attendance_date) FROM `tabAttendance`
                                                        WHERE
                                                                site = &#39;{site}&#39;
                                                        AND attendance_date between &#39;{start_date}&#39; and &#39;{end_date}&#39;
                                                        And status = &#34;Present&#34;
                                                        GROUP BY employee
                                                &#34;&#34;&#34;.format(site=site.name,start_date = cstr(start_date), end_date = cstr(end_date)), as_list=1)

                                if employee_det:
                                        for employee in employee_det:
                                                #calculate Monthly_site_allowance with the rate of allowance per day.
                                                Monthly_site_allowance =  round(int(site.allowance_amount)/no_of_days, 3)*int(employee[1])
                                                create_additional_salary(employee[0], Monthly_site_allowance, &#34;Site Allowance&#34;, end_date)

#this function creates additional salary for a given component.
def create_additional_salary(employee, amount, component, end_date):
        additional_salary = frappe.new_doc(&#34;Additional Salary&#34;)
        additional_salary.employee = employee
        additional_salary.salary_component = component
        additional_salary.amount = amount
        additional_salary.payroll_date = end_date
        additional_salary.company = erpnext.get_default_company()
        additional_salary.overwrite_salary_structure_amount = 1
        additional_salary.notes = &#34;Site Allowance&#34;
        additional_salary.insert()
        additional_salary.submit()



def mark_day_attendance():
        from one_fm.operations.doctype.shift_permission.shift_permission import approve_open_shift_permission
        start_date, end_date = add_days(getdate(), -1), add_days(getdate(), -1)
        approve_open_shift_permission(str(start_date), str(end_date))
        approve_open_employee_checkin_issue(str(start_date), str(end_date))
        frappe.enqueue(mark_daily_attendance, start_date=start_date, end_date=end_date, timeout=4000, queue=&#39;long&#39;)


def mark_night_attendance():
        from one_fm.operations.doctype.shift_permission.shift_permission import approve_open_shift_permission
        start_date = add_days(getdate(), -1)
        end_date =  getdate()
        approve_open_shift_permission(str(start_date), str(end_date))
        approve_open_employee_checkin_issue(str(start_date), str(end_date))
        frappe.enqueue(mark_daily_attendance, start_date=start_date, end_date=end_date, timeout=4000, queue=&#39;long&#39;)

# mark daily attendance
def mark_daily_attendance(start_date, end_date):
        &#34;&#34;&#34;
                This method marks attendance for all employees
        &#34;&#34;&#34;
        try:
                errors = []
                absent_list = []
                owner = frappe.session.user
                creation = now()
                # get holiday for today
                holiday_today = get_holiday_today(start_date)
                # Get shift type and make hashmap
                shift_types = frappe.get_list(&#34;Shift Type&#34;, fields=&#34;*&#34;)
                shift_types_dict = {}
                for i in shift_types:
                        shift_types_dict[i.name] = i

                # get employee schedule
                employee_schedules = frappe.db.get_list(&#34;Employee Schedule&#34;, filters={&#39;date&#39;:start_date, &#39;employee_availability&#39;:&#39;Day Off&#39;}, fields=&#34;*&#34;)
                employee_schedule_dict = {}
                for i in employee_schedules:
                        employee_schedule_dict[i.employee] = i

                employees = frappe.get_list(&#34;Employee&#34;, fields=&#34;*&#34;)
                employees_data = {}
                for i in employees:
                        employees_data[i.name] = i

                employees_dict = {}

                # get open leaves
                open_leaves = frappe.db.sql(f&#34;&#34;&#34;
                        SELECT name, employee FROM `tabLeave Application`
                        WHERE &#39;{start_date}&#39; BETWEEN from_date AND to_date AND status=&#39;Open&#39;;
                &#34;&#34;&#34;, as_dict=1)
                # get attendance for the day
                attendance_list = frappe.get_list(&#34;Attendance&#34;, filters={&#34;attendance_date&#34;:start_date, &#39;status&#39;: [&#39;NOT IN&#39;, [&#39;On Leave&#39;, &#39;Work From Home&#39;, &#39;Day Off&#39;, &#39;Holiday&#39;, &#39;Present&#39;]]})
                attendance_dict = {}
                for i in attendance_list:
                        attendance_dict[i.employee] = i
                # present attendance
                present_attendance_list = frappe.get_list(&#34;Attendance&#34;, filters={&#34;attendance_date&#34;:start_date, &#39;status&#39;: [&#39;IN&#39;, [&#39;On Leave&#39;, &#39;Work From Home&#39;, &#39;Day Off&#39;, &#39;Holiday&#39;, &#39;Present&#39;]]})
                present_attendance_dict = {}
                for i in present_attendance_list:
                        present_attendance_dict[i.employee] = i
                # exempt leave applicants from attendance
                for i in open_leaves:
                        present_attendance_dict[i.employee] = i
                # Get shift assignment and make hashmap
                shift_assignments = frappe.db.sql(f&#34;&#34;&#34;
                        SELECT * FROM `tabShift Assignment` WHERE start_date=&#34;{start_date}&#34; AND end_date=&#34;{end_date}&#34; AND roster_type=&#39;Basic&#39;
                        AND docstatus=1 AND status=&#39;Active&#39;
                &#34;&#34;&#34;, as_dict=1)
                shift_assignments_dict = {}
                shift_assignments_list = [i.name for i in shift_assignments]

                for row in shift_assignments:
                        shift_assignments_dict[row.name] = row
                        if row.employee in employees:
                                if employees_dict.get(row.employee):
                                        employees_dict[row.employee][&#39;shift_assignments&#39;].append(row)
                                else:
                                        employees_dict[row.employee] = {&#39;shift_assignments&#39;:[row]}

                shift_assignments_tuple = str(tuple(shift_assignments_list)) #[:-2]+&#39;)&#39;

                # Get checkins and make hashmap
                in_checkins = frappe.get_list(&#34;Employee Checkin&#34;, filters={&#34;shift_assignment&#34;: [&#34;IN&#34;, shift_assignments_list], &#39;log_type&#39;: &#39;IN&#39;},
                        fields=&#34;name, owner, creation, modified, modified_by, docstatus, idx, employee, employee_name, log_type, late_entry, early_exit, time, date, skip_auto_attendance, shift_actual_start, shift_actual_end, shift_assignment, operations_shift, shift_type, shift_permission, actual_time, MIN(time) as time&#34;,
                        order_by=&#34;employee ASC&#34;, group_by=&#34;shift_assignment&#34;)
                out_checkins = frappe.get_list(&#34;Employee Checkin&#34;, filters={&#34;shift_assignment&#34;: [&#34;IN&#34;, shift_assignments_list], &#39;log_type&#39;: &#39;OUT&#39;},
                        fields=&#34;name, owner, creation, modified, modified_by, docstatus, idx, employee, employee_name, log_type, late_entry, early_exit, time, date, skip_auto_attendance, shift_actual_start, shift_actual_end, shift_assignment, operations_shift, shift_type, shift_permission, actual_time, MAX(time) as time&#34;,
                        order_by=&#34;employee DESC&#34;, group_by=&#34;shift_assignment&#34;)

                in_checkins_dict = {}
                for i in in_checkins:
                        in_checkins_dict[i.shift_assignment] = i

                out_checkins_dict = {}
                for i in out_checkins:
                        out_checkins_dict[i.shift_assignment] = i


                # create attendance object
                employee_checkin = []
                employee_attendance = {}
                checkin_no_out = []
                for k, v in in_checkins_dict.items():
                        try:
                                emp = employees_data.get(v.employee)
                                if attendance_dict.get(v.employee):
                                        name = attendance_dict.get(v.employee).name
                                else:
                                        name = f&#34;HR-ATT-{start_date}-{v.employee}&#34;
                                shift_type = shift_types_dict.get(v.shift_type)
                                shift_assignment = shift_assignments_dict.get(v.shift_assignment)
                                in_time = v.time

                                # check if late entry &gt; 4hrs
                                if ((in_time - shift_assignment.start_datetime).total_seconds() / (60*60)) &gt; 4:
                                        working_hours = 0
                                        employee_attendance[i.employee] = frappe._dict({
                                                &#39;name&#39;:f&#34;HR-ATT-{start_date}-{i.employee}&#34;, &#39;employee&#39;:i.employee, &#39;employee_name&#39;:emp.employee_name, &#39;working_hours&#39;:0, &#39;status&#39;:&#39;Absent&#39;,
                                                &#39;shift&#39;:i.shift_type, &#39;in_time&#39;:&#39;00:00:00&#39;, &#39;out_time&#39;:&#39;00:00:00&#39;, &#39;shift_assignment&#39;:v.shift_assignment, &#39;operations_shift&#39;:v.operations_shift,
                                                &#39;site&#39;:i.site, &#39;project&#39;:i.project, &#39;attendance_date&#39;: start_date, &#39;company&#39;:emp.company,
                                                &#39;department&#39;: emp.department, &#39;late_entry&#39;:0, &#39;early_exit&#39;:0, &#39;operations_role&#39;:i.operations_role, &#39;post_abbrv&#39;:i.post_abbrv,
                                                &#39;roster_type&#39;:i.roster_type, &#39;docstatus&#39;:1, &#39;owner&#39;:owner, &#39;modified_by&#39;:owner, &#39;creation&#39;:creation, &#39;modified&#39;:creation, &#34;comment&#34;:f&#34;Checked in 4hrs late at {in_time}&#34;
                                        })
                                        if not i.employee in absent_list:absent_list.append(i.employee)
                                # check if checkout exists
                                elif out_checkins_dict.get(k):
                                        check_out = out_checkins_dict.get(k)
                                        out_time = check_out.time
                                        working_hours = (out_time - in_time).total_seconds() / (60 * 60)
                                        employee_checkin.append({name:{&#39;in&#39;:v.name, &#39;out&#39;:check_out.name}}) # add checkin for update
                                        employee_attendance[v.employee] = frappe._dict({
                                                &#39;name&#39;:name, &#39;employee&#39;:v.employee, &#39;employee_name&#39;:emp.employee_name, &#39;working_hours&#39;:working_hours, &#39;status&#39;:&#39;Present&#39;,
                                                &#39;shift&#39;:v.shift_type, &#39;in_time&#39;:in_time, &#39;out_time&#39;:out_time, &#39;shift_assignment&#39;:v.shift_assignment, &#39;operations_shift&#39;:v.operations_shift,
                                                &#39;site&#39;:shift_assignment.site, &#39;project&#39;:shift_assignment.project, &#39;attendance_date&#39;: start_date, &#39;company&#39;:shift_assignment.company,
                                                &#39;department&#39;: emp.department, &#39;late_entry&#39;:v.late_entry, &#39;early_exit&#39;:check_out.early_exit, &#39;operations_role&#39;:shift_assignment.operations_role,
                                                &#39;post_abbrv&#39;:shift_assignment.post_abbrv,
                                                &#39;roster_type&#39;:shift_assignment.roster_type, &#39;docstatus&#39;:1, &#39;owner&#39;:owner, &#39;modified_by&#39;:owner, &#39;creation&#39;:creation, &#39;modified&#39;:creation, &#39;comment&#39;:&#34;&#34;
                                        })
                                else: # no checkout record found
                                        working_hours = (shift_assignment.end_datetime - in_time).total_seconds() / (60 * 60)
                                        employee_checkin.append({name:{&#39;in&#39;:v.name, &#39;out&#39;:v.name}}) # add checkin for update
                                        employee_attendance[v.employee] = frappe._dict({
                                                &#39;name&#39;:name, &#39;employee&#39;:v.employee, &#39;employee_name&#39;:emp.employee_name, &#39;working_hours&#39;:working_hours, &#39;status&#39;:&#39;Present&#39;,
                                                &#39;shift&#39;:v.shift_type, &#39;in_time&#39;:in_time, &#39;out_time&#39;:shift_assignment.end_datetime, &#39;shift_assignment&#39;:v.shift_assignment, &#39;operations_shift&#39;:v.operations_shift,
                                                &#39;site&#39;:shift_assignment.site, &#39;project&#39;:shift_assignment.project, &#39;attendance_date&#39;: start_date, &#39;company&#39;:shift_assignment.company,
                                                &#39;department&#39;: emp.department, &#39;late_entry&#39;:v.late_entry, &#39;early_exit&#39;:0, &#39;operations_role&#39;:shift_assignment.operations_role,
                                                &#39;post_abbrv&#39;:shift_assignment.post_abbrv,
                                                &#39;roster_type&#39;:shift_assignment.roster_type, &#39;docstatus&#39;:1, &#39;owner&#39;:owner, &#39;modified_by&#39;:owner, &#39;creation&#39;:creation, &#39;modified&#39;:creation, &#39;comment&#39;:&#34;Checkin but no checkout record found&#34;
                                        })
                                        # add employee to no checkout record found
                                        checkin_no_out.append({&#39;employee&#39;:v.employee, &#39;in&#39;:v.name, &#39;shift_assignment&#39;:v.shift_assignment})
                        except Exception as e:
                                errors.append(str(frappe.get_traceback()))
                # add absent, day off and holiday in shift assignment
                for i in shift_assignments:
                        try:
                                if not employee_attendance.get(i.employee):
                                        # check for day off
                                        comment = &#34;&#34;
                                        if employee_schedule_dict.get(i.employee):
                                                availability = &#39;Day Off&#39;
                                        elif holiday_today and holiday_today.get(employees_data[i.employee].holiday_list):
                                                availability = &#39;Holiday&#39;
                                                comment = str(holiday_today.get(employees_data[i.employee].holiday_list))
                                        else:
                                                availability = &#39;Absent&#39;

                                        emp = employees_data.get(i.employee)
                                        if not emp:
                                                emp = frappe._dict({&#39;department&#39;: &#39;&#39;, &#39;employee_name&#39;: &#39;&#39;})
                                        employee_attendance[i.employee] = frappe._dict({
                                                &#39;name&#39;:f&#34;HR-ATT-{start_date}-{i.employee}&#34;, &#39;employee&#39;:i.employee, &#39;employee_name&#39;:emp.employee_name, &#39;working_hours&#39;:0, &#39;status&#39;:availability,
                                                &#39;shift&#39;:i.shift_type, &#39;in_time&#39;:&#39;00:00:00&#39;, &#39;out_time&#39;:&#39;00:00:00&#39;, &#39;shift_assignment&#39;:i.name, &#39;operations_shift&#39;:i.shift,
                                                &#39;site&#39;:i.site, &#39;project&#39;:i.project, &#39;attendance_date&#39;: start_date, &#39;company&#39;:i.company,
                                                &#39;department&#39;: emp.department, &#39;late_entry&#39;:0, &#39;early_exit&#39;:0, &#39;operations_role&#39;:i.operations_role, &#39;post_abbrv&#39;:i.post_abbrv,
                                                &#39;roster_type&#39;:i.roster_type, &#39;docstatus&#39;:1, &#39;owner&#39;:owner, &#39;modified_by&#39;:owner, &#39;creation&#39;:creation, &#39;modified&#39;:creation,
                                                &#39;comment&#39;:comment
                                        })
                                        if (availability == &#39;Absent&#39;) and (not i.employee in absent_list):absent_list.append(i.employee)
                        except Exception as e:
                                errors.append(str(frappe.get_traceback()))

                # mark day off if non above is met
                for i in employee_schedules:
                        try:
                                if not employee_attendance.get(i.employee):
                                        emp = employees_data.get(i.employee)
                                        employee_attendance[i.employee] = frappe._dict({
                                                &#39;name&#39;:f&#34;HR-ATT-{start_date}-{i.employee}&#34;, &#39;employee&#39;:i.employee, &#39;employee_name&#39;:emp.employee_name, &#39;working_hours&#39;:0, &#39;status&#39;:&#39;Day Off&#39;,
                                                &#39;shift&#39;:i.shift_type, &#39;in_time&#39;:&#39;00:00:00&#39;, &#39;out_time&#39;:&#39;00:00:00&#39;, &#39;shift_assignment&#39;:&#39;&#39;, &#39;operations_shift&#39;:i.shift,
                                                &#39;site&#39;:i.site, &#39;project&#39;:i.project, &#39;attendance_date&#39;: start_date, &#39;company&#39;:emp.company,
                                                &#39;department&#39;: emp.department, &#39;late_entry&#39;:0, &#39;early_exit&#39;:0, &#39;operations_role&#39;:i.operations_role, &#39;post_abbrv&#39;:i.post_abbrv,
                                                &#39;roster_type&#39;:i.roster_type, &#39;docstatus&#39;:1, &#39;owner&#39;:owner, &#39;modified_by&#39;:owner, &#39;creation&#39;:creation, &#39;modified&#39;:creation, &#39;comment&#39;:f&#34;Employee Schedule - {i.name}&#34;
                                        })
                        except Exception as e:
                                errors.append(str(frappe.get_traceback()))


                # create attendance with sql injection
                if employee_attendance:
                        query = &#34;&#34;&#34;
                                INSERT INTO `tabAttendance` (`name`, `employee`, `employee_name`, `working_hours`, `status`, `shift`, `in_time`, `out_time`,
                                `shift_assignment`, `operations_shift`, `site`, `project`, `attendance_date`, `company`,
                                `department`, `late_entry`, `early_exit`, `operations_role`, `post_abbrv`, `roster_type`, `docstatus`, `modified_by`, `owner`,
                                `creation`, `modified`, `comment`)
                                VALUES

                        &#34;&#34;&#34;

                        for k, v in employee_attendance.items():
                                if not present_attendance_dict.get(v.employee):
                                        query+= f&#34;&#34;&#34;
                                        (
                                                &#34;{v.name}&#34;, &#34;{v.employee}&#34;, &#34;{v.employee_name}&#34;, {v.working_hours}, &#34;{v.status}&#34;, &#39;{v.shift}&#39;, &#39;{v.in_time}&#39;,
                                                &#39;{v.out_time}&#39;, &#34;{v.shift_assignment}&#34;, &#34;{v.operations_shift}&#34;, &#34;{v.site}&#34;, &#34;{v.project}&#34;, &#34;{v.attendance_date}&#34;, &#34;{v.company}&#34;,
                                                &#34;{v.department}&#34;, {v.late_entry}, {v.early_exit}, &#34;{v.operations_role}&#34;, &#34;{v.post_abbrv}&#34;, &#34;{v.roster_type}&#34;, {v.docstatus}, &#34;{v.owner}&#34;,
                                                &#34;{v.owner}&#34;, &#34;{v.creation}&#34;, &#34;{v.modified}&#34;, &#34;{v.comment}&#34;
                                        ),&#34;&#34;&#34;

                        query = query[:-1]
                        query += f&#34;&#34;&#34;
                                        ON DUPLICATE KEY UPDATE
                                        employee = VALUES(employee),
                                        employee_name = VALUES(employee_name),
                                        working_hours = VALUES(working_hours),
                                        status = VALUES(status),
                                        shift = VALUES(shift),
                                        in_time = VALUES(in_time),
                                        out_time = VALUES(out_time),
                                        shift_assignment = VALUES(shift_assignment),
                                        operations_shift = VALUES(operations_shift),
                                        site = VALUES(site),
                                        project = VALUES(project),
                                        attendance_date = VALUES(attendance_date),
                                        company = VALUES(company),
                                        department = VALUES(department),
                                        late_entry = VALUES(late_entry),
                                        early_exit = VALUES(early_exit),
                                        operations_role = VALUES(operations_role),
                                        roster_type = VALUES(roster_type),
                                        docstatus = VALUES(docstatus),
                                        modified_by = VALUES(modified_by),
                                        modified = VALUES(modified)
                                &#34;&#34;&#34;
                        try:
                                frappe.db.sql(query, values=[], as_dict=1)
                                frappe.db.commit()
                                # update checkin links
                                if employee_checkin:
                                        query = &#34;&#34;&#34;
                                                INSERT INTO `tabEmployee Checkin`
                                                (`name`, `attendance`)
                                                VALUES
                                        &#34;&#34;&#34;
                                        for i in employee_checkin:
                                                k = list(i.keys())[0]
                                                v = i[k]
                                                query += f&#34;&#34;&#34;
                                                        (&#34;{v[&#39;in&#39;]}&#34;, &#34;{k}&#34;),
                                                        (&#34;{v[&#39;out&#39;]}&#34;, &#34;{k}&#34;),&#34;&#34;&#34;
                                        query = query[:-1]
                                        query += f&#34;&#34;&#34;
                                                ON DUPLICATE KEY UPDATE
                                                attendance = VALUES(attendance)
                                        &#34;&#34;&#34;
                                        frappe.db.sql(query, values=[], as_dict=1)
                                        frappe.db.commit()
                        except Exception as e:
                                errors.append(frappe.get_traceback())

                # check for error
                if len(errors):
                        frappe.log_error(str(errors), &#34;Mark Attendance&#34;)
                #
                # remark absent attendance and holiday list
                if (start_date==end_date):
                        holiday_list_today = [k for k,v in get_holiday_today(start_date).items()]
                        holidays = []
                        for i in holiday_list_today:
                                holidays += frappe.db.sql(f&#34;&#34;&#34;
                                        SELECT name FROM `tabEmployee`
                                        WHERE status=&#39;Active&#39; AND holiday_list=&#34;{i}&#34;
                                        AND name not in (
                                                SELECT employee FROM `tabShift Assignment`
                                                WHERE start_date=&#39;{start_date}&#39;)
                                &#34;&#34;&#34;, as_dict=1)
                        if holidays:
                                absent_list = [i.name for i in holidays]+absent_list

                frappe.enqueue(&#34;one_fm.overrides.attendance.remark_absent_for_employees&#34;,
                        employees=absent_list, date=str(start_date), queue=&#39;long&#39;, timeout=6000)
                frappe.enqueue(&#34;one_fm.overrides.attendance.mark_overtime_attendance&#34;,
                        from_date=start_date, to_date=end_date, queue=&#39;long&#39;, timeout=6000)
        except Exception as e:
                frappe.log_error(frappe.get_traceback(), &#39;Mark Attendance&#39;)



def get_current_schedules(employee, log_type=None):
        # check if employee has logs in
        # Employee Checkin, Shift Request, Shift Permission
        # Attendance Request, Leaves
        employee_doc = frappe.db.get_value(&#34;Employee&#34;, employee, [&#39;name&#39;, &#39;holiday_list&#39;])
        start_date = str(getdate())
        curr_shift = get_current_shift(employee)
        # check day off
        if frappe.db.exists(&#39;Employee Schedule&#39;, {
                        &#39;employee&#39;:employee,
                        &#39;date&#39;:start_date,
                        &#39;employee_availability&#39;:&#39;Day Off&#39;
                        }
                ):
                return False

        # check holiday
        if get_holiday_today(start_date).get(employee_doc.holiday_list):
                return False

        if curr_shift:
                # check for leaves
                if frappe.db.sql(f&#34;&#34;&#34;
                                SELECT name, employee FROM `tabLeave Application`
                                WHERE employee=&#39;{employee}&#39; AND status IN (&#39;Open&#39;, &#39;Approved&#39;)
                                AND &#39;{start_date}&#39; BETWEEN from_date AND to_date;
                        &#34;&#34;&#34;, as_dict=1):
                        return False
                # check for shift permission:
                if frappe.db.exists(&#39;Shift Permission&#39;, {
                        &#39;employee&#39;:employee,
                        &#39;assigned_shift&#39;: curr_shift.name,
                        &#39;log_type&#39;:log_type
                        }):
                        return False

                # check for shift request:
                if frappe.db.sql(f&#34;&#34;&#34;
                                SELECT name, employee FROM `tabShift Request`
                                WHERE employee=&#39;{employee}&#39; AND docstatus=1
                                AND &#39;{start_date}&#39; BETWEEN from_date AND to_date;
                        &#34;&#34;&#34;, as_dict=1):
                        return False
                # check attendance request
                if frappe.db.sql(f&#34;&#34;&#34;
                                SELECT name, employee FROM `tabAttendance Request`
                                WHERE employee=&#39;{employee}&#39; AND docstatus=1
                                AND &#39;{start_date}&#39; BETWEEN from_date AND to_date;
                        &#34;&#34;&#34;, as_dict=1):
                        return False
                # check employee checkin
                if frappe.db.exists(&#39;Employee Checkin&#39;, {
                        &#39;employee&#39;:employee,
                        &#39;shift_assignment&#39;: curr_shift.name,
                        &#39;log_type&#39;:log_type
                        }):
                        return False
                return True
        else:
                return False




# Notifications reminder
def fetch_employees_not_in_checkin():
        &#34;&#34;&#34;
        This method fetch list of employees yet to checkin or have shift permission,
        attendance request, shift request, leave application based on log_type and
        if their shift start or end falls withing the current hour
        &#34;&#34;&#34;
        if not production_domain():
                return
        # if not frappe.db.get_single_value(&#39;HR and Payroll Additional Settings&#39;, &#39;remind_employee_checkin_checkout&#39;) and not production_domain():
        #       return

        shift_start_time = f&#34;{now_datetime().time().hour}:00:00&#34;
        minute = now_datetime().time().minute
        hour = now_datetime().time().hour
        cur_date = str(getdate())
        return_data = []
        log_types = [&#39;IN&#39;, &#39;OUT&#39;]
        for log_type in log_types:
                # capture current minute
                if log_type==&#39;IN&#39;:
                        reminder_minutes = [i.minute for i in frappe.db.sql(&#34;&#34;&#34;
                                SELECT notification_reminder_after_shift_start as minute FROM `tabShift Type`
                                WHERE notification_reminder_after_shift_start&gt;0
                                GROUP BY notification_reminder_after_shift_start;
                        &#34;&#34;&#34;, as_dict=1)]
                        supervisor_reminder_minutes = [i.minute for i in frappe.db.sql(&#34;&#34;&#34;
                                SELECT supervisor_reminder_shift_start as minute FROM `tabShift Type`
                                WHERE supervisor_reminder_shift_start&gt;0
                                GROUP BY supervisor_reminder_shift_start;
                        &#34;&#34;&#34;, as_dict=1)]
                else:
                        reminder_minutes = [i.minute for i in frappe.db.sql(&#34;&#34;&#34;
                                SELECT notification_reminder_after_shift_end as minute FROM `tabShift Type`
                                WHERE notification_reminder_after_shift_end&gt;0
                                GROUP BY notification_reminder_after_shift_end;
                        &#34;&#34;&#34;, as_dict=1)]
                        supervisor_reminder_minutes = [i.minute for i in frappe.db.sql(&#34;&#34;&#34;
                                SELECT supervisor_reminder_start_ends as minute FROM `tabShift Type`
                                WHERE supervisor_reminder_start_ends&gt;0
                                GROUP BY supervisor_reminder_start_ends;
                        &#34;&#34;&#34;, as_dict=1)]


                # get employees from shift assignment, check them in checkins and substract
                shift_assignments_employees_list = frappe.db.sql(f&#34;&#34;&#34;
                        SELECT DISTINCT sa.employee, sa.shift_type, sa.start_datetime, sa.end_datetime,
                        sa.shift as operations_shift, st.notification_reminder_after_shift_start,
                        st.notification_reminder_after_shift_end, st.supervisor_reminder_shift_start,
                        st.supervisor_reminder_start_ends, os.supervisor as shift_supervisor,
                        osi.account_supervisor as site_supervisor

                        FROM `tabShift Assignment` sa RIGHT JOIN `tabShift Type` st ON sa.shift_type=st.name
                        RIGHT JOIN `tabOperations Shift` os ON sa.shift=os.name RIGHT JOIN `tabOperations Site` osi
                        ON sa.site=osi.name

                        WHERE {&#39;sa.start_datetime&#39; if log_type==&#39;IN&#39; else &#39;sa.end_datetime&#39;}=&#39;{cur_date} {shift_start_time}&#39;
                        AND sa.status=&#39;Active&#39; AND sa.docstatus=1
                        GROUP BY sa.employee
                &#34;&#34;&#34;, as_dict=1)
                if not shift_assignments_employees_list:
                        return
                shift_assignments_employees = [i.employee for i in shift_assignments_employees_list]
                # make map of employee against shift type
                shift_assignments_employees_dict = {}
                for i in shift_assignments_employees_list:
                        shift_assignments_employees_dict[i.employee] = i

                shift_assignments_employees_tuple = str(tuple(shift_assignments_employees)).replace(&#39;,)&#39;, &#39;)&#39;)
                # fetch checkins
                checkins = [i.employee for i in frappe.db.sql(f&#34;&#34;&#34;
                        SELECT employee FROM `tabEmployee Checkin`
                        WHERE date=&#39;{cur_date}&#39; AND employee IN {shift_assignments_employees_tuple}
                        AND log_type=&#39;{log_type}&#39;
                        GROUP BY employee
                &#34;&#34;&#34;, as_dict=1)]
                employees_yet_to_checkin = [i for i in shift_assignments_employees if not i in checkins]

                # check shift permissions, attendance request, leave application
                shift_permissions = [i.employee for i in frappe.db.sql(f&#34;&#34;&#34;
                        SELECT employee FROM `tabShift Permission`
                        WHERE date=&#39;{cur_date}&#39; AND employee IN {shift_assignments_employees_tuple}
                        AND log_type=&#39;{log_type}&#39;
                        GROUP BY employee
                &#34;&#34;&#34;, as_dict=1)]
                employees_yet_to_checkin = [i for i in employees_yet_to_checkin if not i in shift_permissions]
                # attendance request
                attendance_request = [i.employee for i in frappe.db.sql(f&#34;&#34;&#34;
                        SELECT employee FROM `tabAttendance Request`
                        WHERE  docstatus=1
                        AND &#39;{cur_date}&#39; BETWEEN from_date AND to_date
                        AND employee IN {shift_assignments_employees_tuple}
                        GROUP BY employee
                &#34;&#34;&#34;, as_dict=1)]
                employees_yet_to_checkin = [i for i in employees_yet_to_checkin if not i in attendance_request]
                # leave application
                leave_application = [i.employee for i in frappe.db.sql(f&#34;&#34;&#34;
                        SELECT employee FROM `tabLeave Application`
                        WHERE status IN (&#39;Open&#39;, &#39;Approved&#39;)
                        AND &#39;{cur_date}&#39; BETWEEN from_date AND to_date
                        AND employee IN {shift_assignments_employees_tuple}
                &#34;&#34;&#34;, as_dict=1)]
                employees_yet_to_checkin = [i for i in employees_yet_to_checkin if not i in leave_application]

                # shift request
                shift_request = [i.employee for i in frappe.db.sql(f&#34;&#34;&#34;
                        SELECT employee FROM `tabShift Request`
                        WHERE  docstatus=1 AND &#39;{cur_date}&#39; BETWEEN from_date AND to_date
                        AND employee IN {shift_assignments_employees_tuple}
                &#34;&#34;&#34;, as_dict=1)]
                employees_yet_to_checkin = [i for i in employees_yet_to_checkin if not i in shift_request]

                # holiday list
                holiday_list = [i for i,j in get_holiday_today(cur_date).items()]
                holiday_list_employees = [i.name for i in frappe.db.get_list(&#34;Employee&#34;, filters={
                        &#39;name&#39;: [&#39;IN&#39;, employees_yet_to_checkin],
                        &#39;status&#39;:&#39;Active&#39;,
                        &#39;holiday_list&#39;: [&#39;IN&#39;, employees_yet_to_checkin]
                })]
                employees_yet_to_checkin = [i for i in employees_yet_to_checkin if not i in holiday_list_employees]

                employee_details = frappe.db.get_list(&#34;Employee&#34;, filters={
                        &#39;name&#39;: [&#39;IN&#39;, employees_yet_to_checkin]},
                        fields=[&#39;name&#39;, &#39;employee_id&#39;, &#39;employee_name&#39;, &#39;user_id&#39;, &#39;prefered_contact_email&#39;,
                        &#39;prefered_email&#39;, &#39;reports_to&#39;]
                )

                if log_type==&#39;IN&#39;:
                        for i in employee_details:
                                if shift_assignments_employees_dict.get(i.name):
                                        i = {**i, **shift_assignments_employees_dict.get(i.name), **{&#39;log_type&#39;:&#39;IN&#39;}}
                                        del i[&#39;name&#39;]
                                        # check if is_after_grace_period
                                        if minute in reminder_minutes:i[&#39;is_after_grace_checkin&#39;] = True
                                        else:i[&#39;is_after_grace_checkin&#39;] = False
                                        # check if supervisor reminder
                                        if minute in supervisor_reminder_minutes:i[&#39;is_supervisor_checkin_reminder&#39;] = True
                                        else:i[&#39;is_supervisor_checkin_reminder&#39;] = False
                                        # check initial
                                        if (minute==i[&#39;start_datetime&#39;].minute and hour==i[&#39;start_datetime&#39;].hour):i[&#39;initial_checkin_reminder&#39;]=True
                                        else:i[&#39;initial_checkin_reminder&#39;]=False
                                        return_data.append(frappe._dict(i))
                else:
                        for i in employee_details:
                                if shift_assignments_employees_dict.get(i.name):
                                        i = {**i, **shift_assignments_employees_dict.get(i.name), **{&#39;log_type&#39;:&#39;OUT&#39;}}
                                        del i[&#39;name&#39;]
                                        # check if is_after_grace_period
                                        if minute in reminder_minutes:i[&#39;is_after_grace_checkout&#39;] = True
                                        else:i[&#39;is_after_grace_checkout&#39;] = False
                                        # check if supervisor reminder
                                        if minute in supervisor_reminder_minutes:i[&#39;is_supervisor_checkout_reminder&#39;] = True
                                        else:i[&#39;is_supervisor_checkout_reminder&#39;] = False
                                        # check initial
                                        if (minute==i[&#39;end_datetime&#39;].minute and hour==i[&#39;end_datetime&#39;].hour):i[&#39;initial_checkout_reminder&#39;]=True
                                        else:i[&#39;initial_checkout_reminder&#39;]=False
                                        return_data.append(frappe._dict(i))

        return frappe._dict({
                &#39;employees&#39;:return_data,
                # &#39;reminder_minutes&#39;:reminder_minutes,
                # &#39;supervisor_reminder_minutes&#39;: supervisor_reminder_minutes,
                &#39;minute&#39;:minute, &#39;date&#39;:cur_date, &#39;total&#39;:len(return_data)
        })

def has_checkin_record(employee, log_type, date):
        if frappe.db.exists(&#39;Employee Checkin&#39;, {
                &#39;employee&#39;:employee,
                &#39;date&#39;: date,
                &#39;log_type&#39;:log_type
                }):return True
        return False


def initiate_checkin_notification(res):
        &#34;&#34;&#34;
        params:
        recipients: Dictionary consist of user ID and Emplloyee ID eg: [{&#39;user_id&#39;: &#39;s.shaikh@armor-services.com&#39;, &#39;name&#39;: &#39;HR-EMP-00001&#39;}]
        log_type: In or Out
        &#34;&#34;&#34;
        now_time = now()
        checkin_message = _(f&#34;&#34;&#34;
                &lt;a class=&#34;btn btn-success&#34; href=&#34;/app/face-recognition&#34;&gt;Check In&lt;/a&gt;&amp;nbsp;
                &lt;br&gt;
                Submit a Shift Permission if you are planing to arrive late
                &lt;a class=&#34;btn btn-primary&#34; href=&#34;/app/shift-permission/new-shift-permission-1&#34;&gt;Submit Shift Permission&lt;/a&gt;&amp;nbsp;
                &lt;br&gt;
                Submit an Attendance Request if there are issues in checkin or you forgot to checkin
                &lt;a class=&#34;btn btn-secondary&#34; href=&#34;/app/attendance-request/new-attendance-request-1&#34;&gt;Submit Attendance Request&lt;/a&gt;&amp;nbsp;
                &lt;br&gt;
                Submit a Shift Request if you are trying to checkin from another site location
                &lt;a class=&#34;btn btn-info&#34; href=&#34;/app/shift-request/new-shift-request-1&#34;&gt;Submit Shift Request&lt;/a&gt;&amp;nbsp;
                &lt;h3&gt;DON&#39;T FORGET TO CHECKIN&lt;/h3&gt;
        &#34;&#34;&#34;)

        checkin_message_after_grace = _(&#34;&#34;&#34;
                &lt;a class=&#34;btn btn-success&#34; href=&#34;/app/face-recognition&#34;&gt;Check In&lt;/a&gt;&amp;nbsp;
                &lt;br&gt;
                Submit a Shift Permission if you are planing to arrive late
                &lt;a class=&#34;btn btn-primary&#34; href=&#34;/app/shift-permission/new-shift-permission-1&#34;&gt;Submit Shift Permission&lt;/a&gt;&amp;nbsp;
                &lt;br&gt;
                Submit an Attendance Request if there are issues in checkin or you forgot to checkin
                &lt;a class=&#34;btn btn-secondary&#34; href=&#34;/app/attendance-request/new-attendance-request-1&#34;&gt;Submit Attendance Request&lt;/a&gt;&amp;nbsp;
                &lt;br&gt;
                Submit a Shift Request if you are trying to checkin from another site location
                &lt;a class=&#34;btn btn-info&#34; href=&#34;/app/shift-request/new-shift-request-1&#34;&gt;Submit Shift Request&lt;/a&gt;&amp;nbsp;
                &lt;h3&gt;IF YOU DO NOT CHECK-IN WITHIN THE NEXT 3 HOURS, YOU WOULD BE MARKED AS ABSENT&lt;/h3&gt;
        &#34;&#34;&#34;)


        checkout_message = _(&#34;&#34;&#34;
                &lt;a class=&#34;btn btn-danger&#34; href=&#34;/app/face-recognition&#34;&gt;Check Out&lt;/a&gt;
                Submit a Shift Permission if you are planing to leave early or is there any issue in checkout or forget to checkout
                &lt;a class=&#34;btn btn-primary&#34; href=&#34;/app/shift-permission/new-shift-permission-1&#34;&gt;Submit Shift Permission&lt;/a&gt;&amp;nbsp;
                &#34;&#34;&#34;)

        user_id_list = []
        checkin_reminders = []
        checkout_reminders = []
        after_grace_checkin_reminder = []
        after_grace_checkout_reminder = []
        supervisor_checkin_reminder = []
        supervisor_checkout_reminder = []

        #eg: recipient: {&#39;user_id&#39;: &#39;s.shaikh@armor-services.com&#39;, &#39;name&#39;: &#39;HR-EMP-00001&#39;}
        for recipient in res.employees:
                # split employees into lists
                if recipient.initial_checkin_reminder:
                        checkin_reminders.append(recipient)
                elif recipient.is_after_grace_checkin:
                        after_grace_checkin_reminder.append(recipient)
                elif recipient.is_supervisor_checkin_reminder:
                        supervisor_checkin_reminder.append(recipient)
                elif recipient.initial_checkout_reminder:
                        checkout_reminders.append(recipient)
                elif recipient.is_after_grace_checkout:
                        after_grace_checkout_reminder.append(recipient)
                elif recipient.is_supervisor_checkout_reminder:
                        supervisor_checkout_reminder.append(recipient)

        # process initial checkins
        if checkin_reminders:
                checkin_reminder_id_list = []
                notification_category = &#39;Attendance&#39;
                notification_title = _(&#34;Checkin reminder&#34;)
                notification_subject = _(&#34;Checkin in the next 5 minutes!&#34;)
                for recipient in checkin_reminders:
                        # if not has_checkin_record(recipient.employee, recipient.log_type, res.date):
                        # Append the list of user ID to send notification through email.
                        checkin_reminder_id_list.append(recipient.user_id)
                        #arrive late button is true only if the employee has the user role &#34;Head Office Employee&#34;.
                        user_roles = frappe.get_roles(recipient.user_id)
                        if &#34;Head Office Employee&#34; in user_roles:
                                push_notification_rest_api_for_checkin(
                                        recipient.employee, notification_title, notification_subject,
                                        checkin=True, arriveLate=True, checkout=False)
                        else:
                                push_notification_rest_api_for_checkin(
                                        recipient.employee, notification_title, notification_subject,
                                        checkin=True,arriveLate=False,checkout=False)
                send_notification(
                        notification_title, notification_subject, checkin_message,
                        notification_category, checkin_reminder_id_list
                )

        # # process checkins after grace period
        if after_grace_checkin_reminder:
                checkin_reminder_id_list = []
                notification_category = &#39;Attendance&#39;
                notification_title = _(&#34;Checkin reminder&#34;)
                notification_subject = _(&#34;Don&#39;t forget to Checkin!&#34;)
                for recipient in after_grace_checkin_reminder:
                        # if not has_checkin_record(recipient.employee, recipient.log_type, res.date):
                        # Append the list of user ID to send notification through email.
                        checkin_reminder_id_list.append(recipient.user_id)
                        #arrive late button is true only if the employee has the user role &#34;Head Office Employee&#34;.
                        user_roles = frappe.get_roles(recipient.user_id)
                        if &#34;Head Office Employee&#34; in user_roles:
                                push_notification_rest_api_for_checkin(
                                        recipient.employee, notification_title, notification_subject,
                                        checkin=True, arriveLate=True, checkout=False)
                        else:
                                push_notification_rest_api_for_checkin(
                                        recipient.employee, notification_title, notification_subject,
                                        checkin=True,arriveLate=False,checkout=False)
                send_notification(
                        notification_title, notification_subject, checkin_message_after_grace,
                        notification_category, checkin_reminder_id_list
                )


        # # process supervisor checkin reminder
        if supervisor_checkin_reminder:
                title = &#34;Checkin Report&#34;
                category = &#34;Attendance&#34;
                date = getdate()
                for recipient in supervisor_checkin_reminder:
                        action_user, Role = get_action_user(recipient.employee,recipient.operations_shift)
                        subject = _(&#34;{employee} has not checked in yet.&#34;.format(employee=recipient.employee_name))
                        action_message = _(&#34;&#34;&#34;
                                Submit a Shift Permission for the employee to give an excuse and not need to penalize
                                &lt;a class=&#34;btn btn-primary&#34; href=&#34;/app/shift-permission/new-shift-permission-1?employee={recipient.employee}&amp;log_type=IN&#34;&gt;Submit Shift Permission&lt;/a&gt;&amp;nbsp;
                                &lt;br/&gt;&lt;br/&gt;
                                Issue penalty for the employee
                                &lt;a class=&#39;btn btn-primary btn-danger no-punch-in&#39; id=&#39;{employee}_{date}_{shift}&#39; href=&#34;/app/penalty-issuance/new-penalty-issuance-1&#34;&gt;Issue Penalty&lt;/a&gt;
                        &#34;&#34;&#34;).format(recipient=recipient, shift=recipient.operations_shift, date=cstr(now_time), employee=recipient.employee, time=str(recipient.start_datetime))
                        if action_user is not None: #and not has_checkin_record(recipient.employee, recipient.log_type, res.date):
                                send_notification(title, subject, action_message, category, [action_user])

                        # notify_message = _(&#34;&#34;&#34;Note that {employee} from Shift {shift} has Not Checked in yet.&#34;&#34;&#34;).format(employee=recipient.employee_name, shift=recipient.operations_shift)
                        # if Role:
                        #       notify_user = get_notification_user(recipient.employee,recipient.operations_shift, Role)
                        #       if notify_user is not None: #and not has_checkin_record(recipient.employee, recipient.log_type, res.date):
                        #               send_notification(title, subject, notify_message, category, notify_user)

        # # process initial checkout
        if checkout_reminders:
                checkout_reminder_id_list = []
                notification_category = &#39;Attendance&#39;
                notification_title = _(&#34;Checkout reminder&#34;)
                notification_subject = _(&#34;Don&#39;t forget to Checkout!&#34;)
                for recipient in checkout_reminders:
                        # if not has_checkin_record(recipient.employee, recipient.log_type, res.date):
                        # Append the list of user ID to send notification through email.
                        checkout_reminder_id_list.append(recipient.user_id)
                        #arrive late button is true only if the employee has the user role &#34;Head Office Employee&#34;.
                        user_roles = frappe.get_roles(recipient.user_id)
                        if &#34;Head Office Employee&#34; in user_roles:
                                push_notification_rest_api_for_checkin(
                                        recipient.employee, notification_title, notification_subject,
                                        checkin=False, arriveLate=False, checkout=True)
                        else:
                                push_notification_rest_api_for_checkin(
                                        recipient.employee, notification_title, notification_subject,
                                        checkin=False,arriveLate=False,checkout=True)
                send_notification(
                        notification_title, notification_subject, checkout_message,
                        notification_category, checkout_reminder_id_list
                )


        # # process supervisor checkout reminder
        if supervisor_checkout_reminder:
                title = &#34;Checkout Report&#34;
                category = &#34;Attendance&#34;
                date = getdate()
                for recipient in supervisor_checkout_reminder:
                        action_user, Role = get_action_user(recipient.employee,recipient.operations_shift)
                        subject = _(&#34;{employee} has not checked out yet.&#34;.format(employee=recipient.employee_name))
                        action_message = _(&#34;&#34;&#34;
                                Submit a Shift Permission for the employee to give an excuse and not need to penalize
                                &lt;a class=&#34;btn btn-primary&#34; href=&#34;/app/shift-permission/new-shift-permission-1?employee={recipient.employee}&amp;log_type=OUT&#34;&gt;Submit Shift Permission&lt;/a&gt;&amp;nbsp;
                                &lt;br/&gt;&lt;br/&gt;
                                Issue penalty for the employee
                                &lt;a class=&#39;btn btn-primary btn-danger no-punch-in&#39; id=&#39;{employee}_{date}_{shift}&#39; href=&#34;/app/penalty-issuance/new-penalty-issuance-1&#34;&gt;Issue Penalty&lt;/a&gt;

                        &#34;&#34;&#34;).format(recipient=recipient, shift=recipient.operations_shift, date=cstr(now_time), employee=recipient.employee, time=str(recipient.start_datetime))
                        if action_user is not None:# and not has_checkin_record(recipient.employee, recipient.log_type, res.date):
                                send_notification(title, subject, action_message, category, [action_user])

                        # notify_message = _(&#34;&#34;&#34;Note that {employee} from Shift {shift} has Not Checked out yet.&#34;&#34;&#34;).format(employee=recipient.employee_name, shift=recipient.operations_shift)
                        # if Role:
                        #       notify_user = get_notification_user(recipient.employee,recipient.operations_shift, Role)
                        #       if notify_user is not None:# and not has_checkin_record(recipient.employee, recipient.log_type, res.date):
                        #               send_notification(title, subject, notify_message, category, notify_user)


def run_checkin_reminder():
        # execute first checkin reminder

        try:
                res = fetch_employees_not_in_checkin()
                if res:
                        initiate_checkin_notification(res)
        except Exception as e:
                frappe.log_error(frappe.get_traceback(), &#39;Checkin Notification&#39;)</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="api.tasks.assign_am_shift"><code class="name flex">
<span>def <span class="ident">assign_am_shift</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def assign_am_shift():
        date = cstr(getdate())
        end_previous_shifts(&#34;AM&#34;)
        roster = frappe.db.sql(&#34;&#34;&#34;
                        SELECT * from `tabEmployee Schedule` ES
                        WHERE
                        ES.date = &#39;{date}&#39;
                        AND ES.employee_availability = &#34;Working&#34;
                        AND ES.roster_type = &#34;Basic&#34;
                        AND ES.shift_type IN(
                                SELECT name from `tabShift Type` st
                                WHERE st.start_time &gt;= &#39;01:00:00&#39;
                                AND  st.start_time &lt; &#39;13:00:00&#39;)
        &#34;&#34;&#34;.format(date=cstr(date)), as_dict=1)

        non_shift = fetch_non_shift(date, &#34;AM&#34;)
        if non_shift:
                roster.extend(non_shift)

        create_shift_assignment(roster, date, &#39;AM&#39;)</code></pre>
</details>
</dd>
<dt id="api.tasks.assign_pm_shift"><code class="name flex">
<span>def <span class="ident">assign_pm_shift</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def assign_pm_shift():
        date = cstr(getdate())
        end_previous_shifts(&#34;PM&#34;)
        roster = frappe.db.sql(&#34;&#34;&#34;
                        SELECT * from `tabEmployee Schedule` ES
                        WHERE
                        ES.date = &#39;{date}&#39;
                        AND ES.employee_availability = &#34;Working&#34;
                        AND ES.roster_type = &#34;Basic&#34;
                        AND ES.shift_type IN(
                                SELECT name from `tabShift Type` st
                                WHERE st.start_time &lt; &#39;01:00:00&#39; OR st.start_time &gt;= &#39;13:00:00&#39;
                                )
        &#34;&#34;&#34;.format(date=cstr(date)), as_dict=1)

        non_shift = fetch_non_shift(date, &#34;PM&#34;)
        if non_shift:
                roster.extend(non_shift)

        create_shift_assignment(roster, date, &#39;PM&#39;)</code></pre>
</details>
</dd>
<dt id="api.tasks.automatic_checkout"><code class="name flex">
<span>def <span class="ident">automatic_checkout</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def automatic_checkout():
        now_time = now_datetime().strftime(&#34;%Y-%m-%d %H:%M&#34;)
        shifts_list = get_active_shifts(now_time)
        for shift in shifts_list:
                # shift_end is equal to now time - notification reminder in mins
                if strfdelta(shift.end_time, &#39;%H:%M:%S&#39;) == cstr((get_datetime(now_time) - timedelta(minutes=cint(shift.allow_check_out_after_shift_end_time))).time()):
                        date = getdate() if shift.start_time &lt; shift.end_time else (getdate() - timedelta(days=1))
                        recipients = frappe.db.sql(&#34;&#34;&#34;
                                SELECT DISTINCT emp.name FROM `tabShift Assignment` tSA, `tabEmployee` emp
                                WHERE
                                        tSA.employee = emp.name
                                AND tSA.start_date=&#39;{date}&#39;
                                AND tSA.shift_type=&#39;{shift_type}&#39;
                                AND tSA.docstatus=1
                                AND tSA.employee
                                NOT IN(SELECT employee FROM `tabEmployee Checkin` empChkin
                                WHERE
                                        empChkin.log_type=&#34;OUT&#34;
                                AND empChkin.skip_auto_attendance=0
                                AND date(empChkin.time)=&#39;{date}&#39;
                                AND empChkin.shift_type=&#39;{shift_type}&#39;)
                        &#34;&#34;&#34;.format(date=cstr(date), shift_type=shift.name), as_list=1)
                        if len(recipients) &gt; 0:
                                recipients = [recipient[0] for recipient in recipients if recipient[0]]
                                for recipient in recipients:
                                        checkin = frappe.new_doc(&#34;Employee Checkin&#34;)
                                        checkin.employee = recipient
                                        checkin.log_type = &#34;OUT&#34;
                                        checkin.skip_auto_attendance = 0
                                        checkin.save()

                        frappe.db.commit()</code></pre>
</details>
</dd>
<dt id="api.tasks.calculate_penalty_amount"><code class="name flex">
<span>def <span class="ident">calculate_penalty_amount</span></span>(<span>employee, start_date, end_date, logs)</span>
</code></dt>
<dd>
<div class="desc"><p>This Funtion Calculates the Penalty Amount based on the occurance and employees basic salary.</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>employee</code></strong> :&ensp;<code>String</code></dt>
<dd>employee ID</dd>
<dt><strong><code>start_date</code></strong> :&ensp;<code>date</code></dt>
<dd>Start Date of the payroll</dd>
<dt><strong><code>end_date</code></strong> :&ensp;<code>date</code></dt>
<dd>Start Date of the payroll</dd>
<dt><strong><code>logs</code></strong> :&ensp;<code>[type]</code></dt>
<dd>Employee's Penalty Log</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def calculate_penalty_amount(employee, start_date, end_date, logs):
        &#34;&#34;&#34;This Funtion Calculates the Penalty Amount based on the occurance and employees basic salary.

        Args:
                employee (String): employee ID
                start_date (date): Start Date of the payroll
                end_date (date): Start Date of the payroll
                logs ([type]): Employee&#39;s Penalty Log
        &#34;&#34;&#34;
        filters = {
                &#39;docstatus&#39;: 1,
                &#39;employee&#39;: employee
        }
        if frappe.db.exists(&#39;Employee&#39;, {&#39;employee&#39;:employee, &#39;status&#39;:&#39;Left&#39;}):
                return

        if frappe.db.get_single_value(&#39;HR and Payroll Additional Settings&#39;, &#39;basic_salary_component&#39;):
                basic_salary_component = frappe.db.get_single_value(&#39;HR and Payroll Additional Settings&#39;, &#39;basic_salary_component&#39;)
        else:
                frappe.throw(&#34;Please Add Basic Salary Component in HR and Payroll Additional Settings.&#34;)

        salary_structure, base = frappe.get_value(&#34;Salary Structure Assignment&#34;, filters, [&#34;salary_structure&#34;,&#34;base&#34;], order_by=&#34;from_date desc&#34;)

        if salary_structure:
                basic = frappe.db.sql(&#34;&#34;&#34;
                SELECT amount,amount_based_on_formula,formula FROM `tabSalary Detail`
                WHERE parenttype=&#34;Salary Structure&#34;
                AND parent=%s
                AND salary_component=%s
                &#34;&#34;&#34;,(salary_structure, basic_salary_component), as_dict=1)
                if basic[0].amount_based_on_formula == 1:
                        formula = basic[0].formula
                        percent = formula.replace(&#39;base*&#39;,&#39;&#39;)
                        basic_salary = int(base)*float(percent)
                else:
                        basic_salary = basic[0].amount

        #Single day salary of employee = Basic Salary(WP salary) divided by 26 days
        single_day_salary = basic_salary / 26

        #Existing balance amount
        existing_balance = 0.00
        if frappe.db.exists(&#34;Penalty Deduction&#34;, {&#39;employee&#39;: employee}):
                existing_balance = frappe.get_value(&#34;Penalty Deduction&#34;, {&#39;employee&#39;: employee}, &#34;balance_amount&#34;, order_by=&#39;posting_time desc&#39;)

        #Calculate new amount
        references =  &#39;, &#39;.join([&#39;&#34;{}&#34;&#39;.format(log.name) for log in logs])

        # references = &#39;&#34;HR-EMP-00002-006&#34;, &#34;HR-EMP-00002-004&#34;&#39;
        damages_amount = frappe.db.sql(&#34;&#34;&#34;
                SELECT sum(py.damage_amount) as damages_amount, py.name
                FROM `tabPenalty` as py
                WHERE py.name in ({refs})
        &#34;&#34;&#34;.format(refs=references), as_dict=1)

        days_deduction = frappe.db.sql(&#34;&#34;&#34;
                SELECT sum(pd.deduction) as days_deduction, pd.name
                FROM `tabPenalty Issuance Details` as pd
                WHERE
                        pd.parenttype=&#34;Penalty&#34;
                AND pd.parent in ({refs})
        &#34;&#34;&#34;.format(refs=references), as_dict=1)

        # Days deduction
        days_deduction_amount = days_deduction[0].days_deduction * single_day_salary

        # Damages amount
        damages_amount = damages_amount[0].damages_amount

        # Sum of previous balance amount, days deduction amount and damages amount
        total_penalty_amount = existing_balance + days_deduction_amount + damages_amount

        # Maxmimum allowed deductible salary according to Kuwaiti law (5 days for penalties)
        max_amount = single_day_salary * 5

        #Amount to be deducted this time
        if total_penalty_amount &gt; max_amount:
                deducted_amount = max_amount
                balance_amount = total_penalty_amount - max_amount
        else:
                deducted_amount = total_penalty_amount
                balance_amount = 0

        #Create Penalty Deduction Doc that in return creates Addition Salary with penalty component.
        create_penalty_deduction(start_date, end_date, employee, total_penalty_amount, single_day_salary, max_amount, deducted_amount, balance_amount)</code></pre>
</details>
</dd>
<dt id="api.tasks.checkin_checkout_final_reminder"><code class="name flex">
<span>def <span class="ident">checkin_checkout_final_reminder</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"><p>This function sends a final notification to users to remind them to checkin/checkout.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def checkin_checkout_final_reminder():
        &#34;&#34;&#34;
        This function sends a final notification to users to remind them to checkin/checkout.
        &#34;&#34;&#34;
        try:
                if not frappe.db.get_single_value(&#39;HR and Payroll Additional Settings&#39;, &#39;remind_employee_checkin_checkout&#39;) and not production_domain():
                        return

                now_time = now_datetime().strftime(&#34;%Y-%m-%d %H:%M&#34;)
                shifts_list = get_active_shifts(now_time)

                #Send final reminder to checkin or checkout to employees who have not even after shift has ended
                frappe.enqueue(schedule_final_notification, shifts_list=shifts_list, now_time=now_time, is_async=True, queue=&#39;long&#39;)
        except Exception as error:
                frappe.log_error(str(error), &#39;Checkin/checkout final reminder failed&#39;)</code></pre>
</details>
</dd>
<dt id="api.tasks.checkin_checkout_initial_reminder"><code class="name flex">
<span>def <span class="ident">checkin_checkout_initial_reminder</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"><p>This function sends a push notification to users to remind them to checkin/checkout at the start/end time of their shift.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def checkin_checkout_initial_reminder():
        &#34;&#34;&#34;
        This function sends a push notification to users to remind them to checkin/checkout at the start/end time of their shift.
        &#34;&#34;&#34;
        try:
                if not frappe.db.get_single_value(&#39;HR and Payroll Additional Settings&#39;, &#39;remind_employee_checkin_checkout&#39;) and not production_domain():
                        return

                # Get current date and time
                now_time = now_datetime().strftime(&#34;%Y-%m-%d %H:%M&#34;)

                # Get list of active shifts
                shifts_list = get_active_shifts(now_time)

                frappe.enqueue(schedule_initial_reminder, shifts_list=shifts_list, now_time=now_time, is_async=True, queue=&#39;long&#39;)

        except Exception as error:
                frappe.log_error(str(error), &#39;Checkin/checkout initial reminder failed&#39;)</code></pre>
</details>
</dd>
<dt id="api.tasks.checkin_checkout_query"><code class="name flex">
<span>def <span class="ident">checkin_checkout_query</span></span>(<span>date, shift_type, log_type)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def checkin_checkout_query(date, shift_type, log_type):
        if log_type == &#34;IN&#34;:
                permission_type = (&#34;Arrive Late&#34;, &#34;Forget to Checkin&#34;, &#34;Checkin Issue&#34;)
        else:
                permission_type = (&#34;Leave Early&#34;, &#34;Forget to Checkout&#34;, &#34;Checkout Issue&#34;)

        query = frappe.db.sql(&#34;&#34;&#34;SELECT DISTINCT emp.user_id, emp.name , emp.employee_name, emp.holiday_list, tSA.shift
                                        FROM `tabShift Assignment` tSA, `tabEmployee` emp
                                        WHERE
                                                tSA.employee=emp.name
                                        AND tSA.start_date=&#39;{date}&#39;
                                        AND tSA.shift_type=&#39;{shift_type}&#39;
                                        AND tSA.docstatus=1
                                        AND tSA.start_date NOT IN
                                        (SELECT holiday_date from `tabHoliday` h
                                        WHERE
                                                h.parent = emp.holiday_list
                                        AND h.holiday_date = &#39;{date}&#39;)
                                        AND emp.name NOT IN
                                        (SELECT employee FROM `tabShift Permission` emp_sp
                                                WHERE
                                                        emp_sp.workflow_state=&#39;Approved&#39;
                                                AND emp_sp.shift_type=&#39;{shift_type}&#39;
                                                AND emp_sp.date=&#39;{date}&#39;
                                                AND emp_sp.permission_type IN {permission_type}
                                        UNION ALL
                                        SELECT employee FROM `tabAttendance Request` att_req
                                                WHERE
                                                        att_req.workflow_state=&#39;Approved&#39;
                                                AND att_req.reason=&#39;Work From Home&#39;
                                                AND CAST(&#39;{date} &#39; as date) BETWEEN att_req.from_date AND att_req.to_date
                                        UNION ALL
                                        SELECT employee FROM `tabLeave Application` LA
                                                WHERE
                                                        LA.workflow_state=&#39;Approved&#39;
                                                AND CAST(&#39;{date} &#39; as date) BETWEEN LA.from_date AND LA.to_date
                                        UNION ALL
                                        SELECT employee FROM `tabEmployee Checkin` empChkin
                                                WHERE
                                                        empChkin.log_type=&#39;{log_type}&#39;
                                                AND empChkin.skip_auto_attendance=0
                                                AND date(empChkin.time)=&#39;{date}&#39;
                                                AND empChkin.shift_type=&#39;{shift_type}&#39;)
                                        &#34;&#34;&#34;.format(date=cstr(date), shift_type=shift_type, log_type=log_type, permission_type=permission_type), as_dict=1)
        return query</code></pre>
</details>
</dd>
<dt id="api.tasks.checkin_checkout_supervisor_reminder"><code class="name flex">
<span>def <span class="ident">checkin_checkout_supervisor_reminder</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@frappe.whitelist()
def checkin_checkout_supervisor_reminder():
        if not frappe.db.get_single_value(&#39;HR and Payroll Additional Settings&#39;, &#39;remind_employee_checkin_checkout&#39;) and not production_domain():
                return

        now_time = now_datetime().strftime(&#34;%Y-%m-%d %H:%M&#34;)
        today_datetime = today()
        shifts_list = get_active_shifts(now_time)

        for shift in shifts_list:
                &#34;&#34;&#34;
                        Send notification to supervisor of those who haven&#39;t checked in and don&#39;t have accepted shift permission
                        with permission type Arrive Late/Forget to Checkin/Checkin Issue
                &#34;&#34;&#34;
                frappe.enqueue(supervisor_reminder,shift = shift,today_datetime = today_datetime ,now_time=now_time, is_async=True, queue=&#39;long&#39;)</code></pre>
</details>
</dd>
<dt id="api.tasks.checkin_deadline"><code class="name flex">
<span>def <span class="ident">checkin_deadline</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def checkin_deadline():

        if not frappe.db.get_single_value(&#39;HR and Payroll Additional Settings&#39;, &#39;checkin_deadline&#39;):
                return

        now_time = now_datetime().strftime(&#34;%Y-%m-%d %H:%M&#34;)
        shifts_list = get_active_shifts(now_time)

        frappe.enqueue(mark_deadline_attendance, shifts_list=shifts_list, now_time = now_time, is_async=True, queue=&#39;long&#39;)</code></pre>
</details>
</dd>
<dt id="api.tasks.create_additional_salary"><code class="name flex">
<span>def <span class="ident">create_additional_salary</span></span>(<span>employee, amount, component, end_date)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def create_additional_salary(employee, amount, component, end_date):
        additional_salary = frappe.new_doc(&#34;Additional Salary&#34;)
        additional_salary.employee = employee
        additional_salary.salary_component = component
        additional_salary.amount = amount
        additional_salary.payroll_date = end_date
        additional_salary.company = erpnext.get_default_company()
        additional_salary.overwrite_salary_structure_amount = 1
        additional_salary.notes = &#34;Site Allowance&#34;
        additional_salary.insert()
        additional_salary.submit()</code></pre>
</details>
</dd>
<dt id="api.tasks.create_overtime_shift_assignment"><code class="name flex">
<span>def <span class="ident">create_overtime_shift_assignment</span></span>(<span>schedule, date)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def create_overtime_shift_assignment(schedule, date):
        if (not frappe.db.exists(&#34;Shift Assignment&#34;,{&#34;employee&#34;:schedule.employee, &#34;start_date&#34;:getdate(date), &#34;status&#34;:&#34;Active&#34;}) and
                        frappe.db.exists(&#39;Employee&#39;, {&#39;employee&#39;:schedule.employee, &#39;status&#39;:&#39;Active&#39;})):
                try:
                        shift_assignment = frappe.new_doc(&#34;Shift Assignment&#34;)
                        shift_assignment.start_date = date
                        shift_assignment.employee = schedule.employee
                        shift_assignment.employee_name = schedule.employee_name
                        shift_assignment.department = schedule.department
                        shift_assignment.operations_role = schedule.operations_role
                        shift_assignment.shift = schedule.shift
                        shift_assignment.site = schedule.site
                        shift_assignment.project = schedule.project
                        shift_assignment.shift_type = schedule.shift_type
                        shift_assignment.operations_role = schedule.operations_role
                        shift_assignment.post_abbrv = schedule.post_abbrv
                        shift_assignment.roster_type = schedule.roster_type
                        shift_assignment.site_location = schedule.checkin_location
                        if frappe.db.exists(&#34;Shift Request&#34;, {&#39;employee&#39;:schedule.employee, &#39;from_date&#39;:[&#39;&lt;=&#39;,date],&#39;to_date&#39;:[&#39;&gt;=&#39;,date]}):
                                shift_request, check_in_site, check_out_site = frappe.get_value(&#34;Shift Request&#34;, {&#39;employee&#39;:schedule.employee, &#39;from_date&#39;:[&#39;&lt;=&#39;,date],&#39;to_date&#39;:[&#39;&gt;=&#39;,date]},[&#34;name&#34;,&#34;check_in_site&#34;,&#34;check_out_site&#34;])
                                shift_assignment.shift_request = shift_request
                                shift_assignment.check_in_site = check_in_site
                                shift_assignment.check_out_site = check_out_site
                        shift_assignment.submit()
                except Exception:
                        frappe.log_error(frappe.get_traceback(), &#34;Create Shift Assignment&#34;)</code></pre>
</details>
</dd>
<dt id="api.tasks.create_penalty_deduction"><code class="name flex">
<span>def <span class="ident">create_penalty_deduction</span></span>(<span>start_date, end_date, employee, total_penalty_amount, single_day_amount, max_amount, deducted_amount, balance_amount)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def create_penalty_deduction(start_date, end_date, employee, total_penalty_amount, single_day_amount, max_amount, deducted_amount, balance_amount):
        penalty_deduction = frappe.new_doc(&#34;Penalty Deduction&#34;)
        penalty_deduction.posting_time = get_datetime()
        penalty_deduction.employee = employee
        penalty_deduction.from_date = start_date
        penalty_deduction.to_date = end_date
        penalty_deduction.total_penalty_amount = total_penalty_amount
        penalty_deduction.single_day_amount = single_day_amount
        penalty_deduction.maximum_amount = max_amount
        penalty_deduction.deducted_amount = deducted_amount
        penalty_deduction.balance_amount = balance_amount
        penalty_deduction.insert()
        penalty_deduction.submit()
        frappe.db.commit()</code></pre>
</details>
</dd>
<dt id="api.tasks.create_shift_assignment"><code class="name flex">
<span>def <span class="ident">create_shift_assignment</span></span>(<span>roster, date, time)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def create_shift_assignment(roster, date, time):
        try:
                owner = frappe.session.user
                creation = now()
                shift_type = get_shift_type(time)
                shift_types = frappe.db.get_list(&#34;Shift Type&#34;, filters={&#39;name&#39;:[&#39;IN&#39;, shift_type]},
                        fields=[&#39;name&#39;, &#39;shift_type&#39;, &#39;start_time&#39;, &#39;end_time&#39;])
                shift_types_dict = {}
                for i in shift_types:
                        i.start_datetime = f&#34;{date} {(datetime.datetime.min + i.start_time).time()}&#34;
                        if i.end_time.total_seconds() &lt; i.start_time.total_seconds():
                                i.end_datetime = f&#34;{add_days(date, 1)} {(datetime.datetime.min + i.end_time).time()}&#34;
                        else:
                                i.end_datetime = f&#34;{date} {(datetime.datetime.min + i.end_time).time()}&#34;
                        shift_types_dict[i.name] = i
                default_shift = frappe.get_doc(&#34;Shift Type&#34;, &#39;&#34;Standard|Morning|08:00:00-17:00:00|9 hours&#34;&#39;).as_dict()


                existing_shift = frappe.db.get_list(&#34;Shift Assignment&#34;, filters={
                        &#39;start_date&#39;: date,
                        &#39;shift_type&#39;: [&#39;IN&#39;, shift_type],
                        &#39;docstatus&#39;: 1,
                        &#39;roster_type&#39;: [&#39;IN&#39;, [&#39;Basic&#39;]],
                        &#39;status&#39;:&#39;Active&#39;,
                        },
                        fields=[&#39;employee&#39;]
                )

                existing_shift_list = [i.employee for i in existing_shift]
                shift_request = frappe.db.get_list(&#34;Shift Request&#34;, filters={
                        &#39;employee&#39;: [&#39;IN&#39;, [i.employee for i in roster]],
                        &#39;from_date&#39;: [&#39;&lt;=&#39;, date],
                        &#39;to_date&#39;: [&#39;&gt;=&#39;, date],
                        &#39;workflow_state&#39;: &#39;Approved&#39;
                        },
                        fields=[&#39;name&#39;, &#39;employee&#39;, &#39;check_in_site&#39;, &#39;check_out_site&#39;]
                )
                shift_request_dict = {}
                for i in shift_request:
                        shift_request_dict[i.employee] = i

                sites = []
                for i in roster:
                        if not i.site in sites:
                                sites.append(i.site)
                sites_list = frappe.db.get_list(&#34;Operations Site&#34;, filters={&#39;name&#39;: [&#39;IN&#39;, sites]}, fields=[&#39;name&#39;, &#39;site_location&#39;])
                sites_list_dict = {}
                for i in sites_list:
                        sites_list_dict[i.name] = i.site_location

                # remove employees with approved leaves
                todays_leaves = get_today_leaves(str(date))
                roster = [i for i in roster if not i.employee in todays_leaves]
                if roster:
                        query = &#34;&#34;&#34;
                                INSERT INTO `tabShift Assignment` (`name`, `company`, `docstatus`, `employee`, `employee_name`, `shift_type`, `site`, `project`, `status`,
                                `shift_classification`, `site_location`, `start_date`, `start_datetime`, `end_datetime`, `department`,
                                `shift`, `operations_role`, `post_abbrv`, `roster_type`, `owner`, `modified_by`, `creation`, `modified`,
                                `shift_request`, `check_in_site`, `check_out_site`)
                                VALUES
                        &#34;&#34;&#34;
                        # check if all roster has been done
                        has_rostered = []
                        for r in roster:
                                if not r.employee in existing_shift_list:
                                        _shift_type = shift_types_dict.get(r.shift_type) or default_shift

                                        query += f&#34;&#34;&#34;
                                        (
                                                &#34;HR-SHA-{date}-{r.employee}&#34;, &#34;{frappe.defaults.get_user_default(&#39;company&#39;)}&#34;, 1, &#34;{r.employee}&#34;, &#34;{r.employee_name}&#34;, &#39;{r.shift_type}&#39;,
                                                &#34;{r.site or &#39;&#39;}&#34;, &#34;{r.project or &#39;&#39;}&#34;, &#39;Active&#39;, &#34;{_shift_type.shift_type}&#34;, &#34;{sites_list_dict.get(r.site) or &#39;&#39;}&#34;, &#34;{date}&#34;,
                                                &#34;{_shift_type.start_datetime or str(date)+&#39; 08:00:00&#39;}&#34;,
                                                &#34;{_shift_type.end_datetime or str(date)+&#39; 17:00:00&#39;}&#34;, &#34;{r.department}&#34;, &#34;{r.shift or &#39;&#39;}&#34;, &#34;{r.operations_role or &#39;&#39;}&#34;, &#34;{r.post_abbrv or &#39;&#39;}&#34;, &#34;{r.roster_type}&#34;,
                                                &#34;{owner}&#34;, &#34;{owner}&#34;, &#34;{creation}&#34;, &#34;{creation}&#34; &#34;&#34;&#34;
                                        if shift_request_dict.get(r.employee):
                                                _shift_request = shift_request_dict.get(r.employee)
                                                query += f&#34;&#34;&#34;, &#34;{_shift_request.name}&#34;, &#34;{_shift_request.check_in_site}&#34;, &#34;{_shift_request.check_out_site}&#34;), &#34;&#34;&#34;
                                        else:
                                                query += &#34;&#34;&#34;, &#39;&#39;, &#39;&#39;, &#39;&#39;),&#34;&#34;&#34;
                                else:
                                        has_rostered.append(r.employee_name)
                        query = query[:-1]
                        query += f&#34;&#34;&#34;
                                ON DUPLICATE KEY UPDATE
                                modified_by = VALUES(modified_by),
                                docstatus = VALUES(docstatus),
                                modified = &#34;{creation}&#34;,
                                operations_role = VALUES(operations_role),
                                post_abbrv = VALUES(post_abbrv),
                                roster_type = VALUES(roster_type),
                                shift = VALUES(shift),
                                project = VALUES(project),
                                site = VALUES(site),
                                shift_type = VALUES(shift_type),
                                employee = VALUES(employee),
                                employee_name = VALUES(employee_name),
                                site_location = VALUES(site_location),
                                start_datetime = VALUES(start_datetime),
                                end_datetime = VALUES(end_datetime),
                                department = VALUES(department),
                                shift_request = VALUES(shift_request),
                                check_in_site = VALUES(check_in_site),
                                check_out_site = VALUES(check_out_site),
                                shift_classification = VALUES(shift_classification),
                                status = VALUES(status)
                        &#34;&#34;&#34;
                        frappe.db.sql(query, values=[], as_dict=1)
                        frappe.db.commit()

                        if has_rostered:
                                frappe.log_error(str(has_rostered), &#39;Duplicate Shift Assignment&#39;)
        except Exception as e:
                sender = frappe.get_value(&#34;Email Account&#34;, filters = {&#34;default_outgoing&#34;: 1}, fieldname = &#34;email_id&#34;) or None
                recipient = frappe.get_value(&#34;Email Account&#34;, {&#34;name&#34;:&#34;Support&#34;}, [&#34;email_id&#34;])
                msg = frappe.render_template(&#39;one_fm/templates/emails/missing_shift_assignment.html&#39;, context={&#34;rosters&#34;: roster})
                sendemail(sender=sender, recipients= recipient, content=msg, subject=&#34;Shift Assignment Failed&#34;, delay=False)</code></pre>
</details>
</dd>
<dt id="api.tasks.end_previous_shifts"><code class="name flex">
<span>def <span class="ident">end_previous_shifts</span></span>(<span>time)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def end_previous_shifts(time):
        shift_type = get_shift_type(time)
        query = f&#34;&#34;&#34;
                UPDATE `tabShift Assignment`
                SET end_date=DATE(end_datetime)
                WHERE
                end_date IS NULL AND shift_type IN {tuple(shift_type)} AND docstatus=1 AND roster_type in (&#39;Basic&#39;, &#39;Over-Time&#39;)
        ;&#34;&#34;&#34;
        shift_assignments = frappe.db.sql(query, values=[], as_dict=1)
        frappe.db.commit()</code></pre>
</details>
</dd>
<dt id="api.tasks.fetch_employees_not_in_checkin"><code class="name flex">
<span>def <span class="ident">fetch_employees_not_in_checkin</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"><p>This method fetch list of employees yet to checkin or have shift permission,
attendance request, shift request, leave application based on log_type and
if their shift start or end falls withing the current hour</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def fetch_employees_not_in_checkin():
        &#34;&#34;&#34;
        This method fetch list of employees yet to checkin or have shift permission,
        attendance request, shift request, leave application based on log_type and
        if their shift start or end falls withing the current hour
        &#34;&#34;&#34;
        if not production_domain():
                return
        # if not frappe.db.get_single_value(&#39;HR and Payroll Additional Settings&#39;, &#39;remind_employee_checkin_checkout&#39;) and not production_domain():
        #       return

        shift_start_time = f&#34;{now_datetime().time().hour}:00:00&#34;
        minute = now_datetime().time().minute
        hour = now_datetime().time().hour
        cur_date = str(getdate())
        return_data = []
        log_types = [&#39;IN&#39;, &#39;OUT&#39;]
        for log_type in log_types:
                # capture current minute
                if log_type==&#39;IN&#39;:
                        reminder_minutes = [i.minute for i in frappe.db.sql(&#34;&#34;&#34;
                                SELECT notification_reminder_after_shift_start as minute FROM `tabShift Type`
                                WHERE notification_reminder_after_shift_start&gt;0
                                GROUP BY notification_reminder_after_shift_start;
                        &#34;&#34;&#34;, as_dict=1)]
                        supervisor_reminder_minutes = [i.minute for i in frappe.db.sql(&#34;&#34;&#34;
                                SELECT supervisor_reminder_shift_start as minute FROM `tabShift Type`
                                WHERE supervisor_reminder_shift_start&gt;0
                                GROUP BY supervisor_reminder_shift_start;
                        &#34;&#34;&#34;, as_dict=1)]
                else:
                        reminder_minutes = [i.minute for i in frappe.db.sql(&#34;&#34;&#34;
                                SELECT notification_reminder_after_shift_end as minute FROM `tabShift Type`
                                WHERE notification_reminder_after_shift_end&gt;0
                                GROUP BY notification_reminder_after_shift_end;
                        &#34;&#34;&#34;, as_dict=1)]
                        supervisor_reminder_minutes = [i.minute for i in frappe.db.sql(&#34;&#34;&#34;
                                SELECT supervisor_reminder_start_ends as minute FROM `tabShift Type`
                                WHERE supervisor_reminder_start_ends&gt;0
                                GROUP BY supervisor_reminder_start_ends;
                        &#34;&#34;&#34;, as_dict=1)]


                # get employees from shift assignment, check them in checkins and substract
                shift_assignments_employees_list = frappe.db.sql(f&#34;&#34;&#34;
                        SELECT DISTINCT sa.employee, sa.shift_type, sa.start_datetime, sa.end_datetime,
                        sa.shift as operations_shift, st.notification_reminder_after_shift_start,
                        st.notification_reminder_after_shift_end, st.supervisor_reminder_shift_start,
                        st.supervisor_reminder_start_ends, os.supervisor as shift_supervisor,
                        osi.account_supervisor as site_supervisor

                        FROM `tabShift Assignment` sa RIGHT JOIN `tabShift Type` st ON sa.shift_type=st.name
                        RIGHT JOIN `tabOperations Shift` os ON sa.shift=os.name RIGHT JOIN `tabOperations Site` osi
                        ON sa.site=osi.name

                        WHERE {&#39;sa.start_datetime&#39; if log_type==&#39;IN&#39; else &#39;sa.end_datetime&#39;}=&#39;{cur_date} {shift_start_time}&#39;
                        AND sa.status=&#39;Active&#39; AND sa.docstatus=1
                        GROUP BY sa.employee
                &#34;&#34;&#34;, as_dict=1)
                if not shift_assignments_employees_list:
                        return
                shift_assignments_employees = [i.employee for i in shift_assignments_employees_list]
                # make map of employee against shift type
                shift_assignments_employees_dict = {}
                for i in shift_assignments_employees_list:
                        shift_assignments_employees_dict[i.employee] = i

                shift_assignments_employees_tuple = str(tuple(shift_assignments_employees)).replace(&#39;,)&#39;, &#39;)&#39;)
                # fetch checkins
                checkins = [i.employee for i in frappe.db.sql(f&#34;&#34;&#34;
                        SELECT employee FROM `tabEmployee Checkin`
                        WHERE date=&#39;{cur_date}&#39; AND employee IN {shift_assignments_employees_tuple}
                        AND log_type=&#39;{log_type}&#39;
                        GROUP BY employee
                &#34;&#34;&#34;, as_dict=1)]
                employees_yet_to_checkin = [i for i in shift_assignments_employees if not i in checkins]

                # check shift permissions, attendance request, leave application
                shift_permissions = [i.employee for i in frappe.db.sql(f&#34;&#34;&#34;
                        SELECT employee FROM `tabShift Permission`
                        WHERE date=&#39;{cur_date}&#39; AND employee IN {shift_assignments_employees_tuple}
                        AND log_type=&#39;{log_type}&#39;
                        GROUP BY employee
                &#34;&#34;&#34;, as_dict=1)]
                employees_yet_to_checkin = [i for i in employees_yet_to_checkin if not i in shift_permissions]
                # attendance request
                attendance_request = [i.employee for i in frappe.db.sql(f&#34;&#34;&#34;
                        SELECT employee FROM `tabAttendance Request`
                        WHERE  docstatus=1
                        AND &#39;{cur_date}&#39; BETWEEN from_date AND to_date
                        AND employee IN {shift_assignments_employees_tuple}
                        GROUP BY employee
                &#34;&#34;&#34;, as_dict=1)]
                employees_yet_to_checkin = [i for i in employees_yet_to_checkin if not i in attendance_request]
                # leave application
                leave_application = [i.employee for i in frappe.db.sql(f&#34;&#34;&#34;
                        SELECT employee FROM `tabLeave Application`
                        WHERE status IN (&#39;Open&#39;, &#39;Approved&#39;)
                        AND &#39;{cur_date}&#39; BETWEEN from_date AND to_date
                        AND employee IN {shift_assignments_employees_tuple}
                &#34;&#34;&#34;, as_dict=1)]
                employees_yet_to_checkin = [i for i in employees_yet_to_checkin if not i in leave_application]

                # shift request
                shift_request = [i.employee for i in frappe.db.sql(f&#34;&#34;&#34;
                        SELECT employee FROM `tabShift Request`
                        WHERE  docstatus=1 AND &#39;{cur_date}&#39; BETWEEN from_date AND to_date
                        AND employee IN {shift_assignments_employees_tuple}
                &#34;&#34;&#34;, as_dict=1)]
                employees_yet_to_checkin = [i for i in employees_yet_to_checkin if not i in shift_request]

                # holiday list
                holiday_list = [i for i,j in get_holiday_today(cur_date).items()]
                holiday_list_employees = [i.name for i in frappe.db.get_list(&#34;Employee&#34;, filters={
                        &#39;name&#39;: [&#39;IN&#39;, employees_yet_to_checkin],
                        &#39;status&#39;:&#39;Active&#39;,
                        &#39;holiday_list&#39;: [&#39;IN&#39;, employees_yet_to_checkin]
                })]
                employees_yet_to_checkin = [i for i in employees_yet_to_checkin if not i in holiday_list_employees]

                employee_details = frappe.db.get_list(&#34;Employee&#34;, filters={
                        &#39;name&#39;: [&#39;IN&#39;, employees_yet_to_checkin]},
                        fields=[&#39;name&#39;, &#39;employee_id&#39;, &#39;employee_name&#39;, &#39;user_id&#39;, &#39;prefered_contact_email&#39;,
                        &#39;prefered_email&#39;, &#39;reports_to&#39;]
                )

                if log_type==&#39;IN&#39;:
                        for i in employee_details:
                                if shift_assignments_employees_dict.get(i.name):
                                        i = {**i, **shift_assignments_employees_dict.get(i.name), **{&#39;log_type&#39;:&#39;IN&#39;}}
                                        del i[&#39;name&#39;]
                                        # check if is_after_grace_period
                                        if minute in reminder_minutes:i[&#39;is_after_grace_checkin&#39;] = True
                                        else:i[&#39;is_after_grace_checkin&#39;] = False
                                        # check if supervisor reminder
                                        if minute in supervisor_reminder_minutes:i[&#39;is_supervisor_checkin_reminder&#39;] = True
                                        else:i[&#39;is_supervisor_checkin_reminder&#39;] = False
                                        # check initial
                                        if (minute==i[&#39;start_datetime&#39;].minute and hour==i[&#39;start_datetime&#39;].hour):i[&#39;initial_checkin_reminder&#39;]=True
                                        else:i[&#39;initial_checkin_reminder&#39;]=False
                                        return_data.append(frappe._dict(i))
                else:
                        for i in employee_details:
                                if shift_assignments_employees_dict.get(i.name):
                                        i = {**i, **shift_assignments_employees_dict.get(i.name), **{&#39;log_type&#39;:&#39;OUT&#39;}}
                                        del i[&#39;name&#39;]
                                        # check if is_after_grace_period
                                        if minute in reminder_minutes:i[&#39;is_after_grace_checkout&#39;] = True
                                        else:i[&#39;is_after_grace_checkout&#39;] = False
                                        # check if supervisor reminder
                                        if minute in supervisor_reminder_minutes:i[&#39;is_supervisor_checkout_reminder&#39;] = True
                                        else:i[&#39;is_supervisor_checkout_reminder&#39;] = False
                                        # check initial
                                        if (minute==i[&#39;end_datetime&#39;].minute and hour==i[&#39;end_datetime&#39;].hour):i[&#39;initial_checkout_reminder&#39;]=True
                                        else:i[&#39;initial_checkout_reminder&#39;]=False
                                        return_data.append(frappe._dict(i))

        return frappe._dict({
                &#39;employees&#39;:return_data,
                # &#39;reminder_minutes&#39;:reminder_minutes,
                # &#39;supervisor_reminder_minutes&#39;: supervisor_reminder_minutes,
                &#39;minute&#39;:minute, &#39;date&#39;:cur_date, &#39;total&#39;:len(return_data)
        })</code></pre>
</details>
</dd>
<dt id="api.tasks.fetch_non_shift"><code class="name flex">
<span>def <span class="ident">fetch_non_shift</span></span>(<span>date, s_type)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def fetch_non_shift(date, s_type):
        if s_type == &#34;AM&#34;:
                roster = frappe.db.sql(&#34;&#34;&#34;SELECT @roster_type := &#39;Basic&#39; as roster_type, @start_datetime := &#34;{date} 08:00:00&#34; as start_datetime, @end_datetime := &#34;{date} 17:00:00&#34; as end_datetime,
                                name as employee, employee_name, department, holiday_list, default_shift as shift_type, checkin_location, shift, site from `tabEmployee` E
                                WHERE E.shift_working = 0 AND E.status=&#39;Active&#39;
                                AND E.default_shift IN(
                                        SELECT name from `tabShift Type` st
                                        WHERE st.start_time &gt;= &#39;01:00:00&#39;
                                        AND  st.start_time &lt; &#39;13:00:00&#39;)
                                AND NOT EXISTS(SELECT * from `tabHoliday` h
                                        WHERE
                                                h.parent = E.holiday_list
                                        AND h.holiday_date = &#39;{date}&#39;)
                &#34;&#34;&#34;.format(date=cstr(date)), as_dict=1)
        else:
                roster = frappe.db.sql(&#34;&#34;&#34;SELECT @roster_type := &#39;Basic&#39; as roster_type, name as employee, employee_name, department, holiday_list, default_shift as shift_type, checkin_location, shift, site from `tabEmployee` E
                                WHERE E.shift_working = 0
                                AND E.default_shift IN(
                                        SELECT name from `tabShift Type` st
                                        WHERE st.start_time &lt; &#39;01:00:00&#39; OR st.start_time &gt;= &#39;13:00:00&#39;
                                        )
                                AND NOT EXISTS(SELECT * from `tabHoliday` h
                                        WHERE
                                                h.parent = E.holiday_list
                                        AND h.holiday_date = &#39;{date}&#39;)
                &#34;&#34;&#34;.format(date=cstr(date)), as_dict=1)

        return roster</code></pre>
</details>
</dd>
<dt id="api.tasks.generate_payroll"><code class="name flex">
<span>def <span class="ident">generate_payroll</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"><p>Method to generate payroll on 24th of each month(method calling form cron job for 24th in hooks.py)</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def generate_payroll():
        &#39;&#39;&#39;
                Method to generate payroll on 24th of each month(method calling form cron job for 24th in hooks.py)
        &#39;&#39;&#39;
        try:
                auto_create_payroll_entry()
        except Exception:
                frappe.log_error(frappe.get_traceback())</code></pre>
</details>
</dd>
<dt id="api.tasks.generate_penalties"><code class="name flex">
<span>def <span class="ident">generate_penalties</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def generate_penalties():
        # start_date = add_to_date(getdate(), months=-1)
        # end_date = get_end_date(start_date, &#39;monthly&#39;)[&#39;end_date&#39;]

        #fetch Payroll date&#39;s day
        date = frappe.db.get_single_value(&#39;HR and Payroll Additional Settings&#39;, &#39;payroll_date&#39;)
        year = getdate().year - 1 if getdate().day &lt; cint(date) and  getdate().month == 1 else getdate().year
        month = getdate().month if getdate().day &gt;= cint(date) else getdate().month - 1

        #calculate Payroll date, start and end date.

        payroll_date = datetime.datetime(year, month, cint(date)).strftime(&#34;%Y-%m-%d&#34;)
        start_date = add_to_date(payroll_date, months=-1)
        end_date = add_to_date(payroll_date, days=-1)

        filters = {
                &#39;penalty_issuance_time&#39;: [&#39;between&#39;, (start_date, end_date)],
                &#39;workflow_state&#39;: &#39;Penalty Accepted&#39;
        }
        logs = frappe.db.get_list(&#39;Penalty&#39;, filters=filters, fields=&#34;*&#34;, order_by=&#34;recipient_employee,penalty_issuance_time&#34;)
        for key, group in itertools.groupby(logs, key=lambda x: (x[&#39;recipient_employee&#39;])):
                employee_penalties = list(group)
                calculate_penalty_amount(key, start_date, end_date, employee_penalties)</code></pre>
</details>
</dd>
<dt id="api.tasks.generate_site_allowance"><code class="name flex">
<span>def <span class="ident">generate_site_allowance</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def generate_site_allowance():
        #get list of all site that includes Site Allowance.
        operations_site = frappe.get_all(&#34;Operations Site&#34;, {&#34;include_site_allowance&#34;:&#34;1&#34;},[&#34;name&#34;,&#34;allowance_amount&#34;])

        #Gather the required Date details such as start date, and respective end date. Get current year and month to get the no. of days in the current month.
        start_date = add_to_date(getdate(), months=-1)
        end_date = get_end_date(start_date, &#39;monthly&#39;)[&#39;end_date&#39;]
        currentMonth = datetime.datetime.now().month
        currentYear = datetime.datetime.now().year
        no_of_days = monthrange(currentYear, currentMonth)[1]

        #generate site allowance for each site. Gets the employee and his/her respective no. of days in a given site.
        if operations_site:
                        for site in operations_site:
                                employee_det = frappe.db.sql(&#34;&#34;&#34;
                                                        SELECT employee,count(attendance_date) FROM `tabAttendance`
                                                        WHERE
                                                                site = &#39;{site}&#39;
                                                        AND attendance_date between &#39;{start_date}&#39; and &#39;{end_date}&#39;
                                                        And status = &#34;Present&#34;
                                                        GROUP BY employee
                                                &#34;&#34;&#34;.format(site=site.name,start_date = cstr(start_date), end_date = cstr(end_date)), as_list=1)

                                if employee_det:
                                        for employee in employee_det:
                                                #calculate Monthly_site_allowance with the rate of allowance per day.
                                                Monthly_site_allowance =  round(int(site.allowance_amount)/no_of_days, 3)*int(employee[1])
                                                create_additional_salary(employee[0], Monthly_site_allowance, &#34;Site Allowance&#34;, end_date)</code></pre>
</details>
</dd>
<dt id="api.tasks.get_action_user"><code class="name flex">
<span>def <span class="ident">get_action_user</span></span>(<span>employee, shift)</span>
</code></dt>
<dd>
<div class="desc"><p>Shift &gt; Site &gt; Project &gt; Reports to</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@frappe.whitelist()
def get_action_user(employee, shift):
        &#34;&#34;&#34;
                        Shift &gt; Site &gt; Project &gt; Reports to
        &#34;&#34;&#34;
        action_user = None
        Role = None

        operations_shift = frappe.get_doc(&#34;Operations Shift&#34;, shift)
        operations_site = frappe.get_doc(&#34;Operations Site&#34;, operations_shift.site)
        project = frappe.get_doc(&#34;Project&#34;, operations_site.project)
        report_to = frappe.get_value(&#34;Employee&#34;, {&#34;name&#34;:employee},[&#34;reports_to&#34;])
        current_user = frappe.get_value(&#34;Employee&#34;, {&#34;name&#34;:employee},[&#34;user_id&#34;])

        if report_to:
                action_user = get_employee_user_id(report_to)
                Role = &#34;Report To&#34;
        else:
                if operations_shift.supervisor:
                        shift_supervisor = get_employee_user_id(operations_shift.supervisor)
                        if shift_supervisor != operations_shift.owner and shift_supervisor != current_user:
                                action_user = shift_supervisor
                                Role = &#34;Shift Supervisor&#34;

                elif operations_site.account_supervisor:
                        site_supervisor = get_employee_user_id(operations_site.account_supervisor)
                        if site_supervisor != operations_shift.owner and site_supervisor != current_user:
                                action_user = site_supervisor
                                Role = &#34;Site Supervisor&#34;

                elif operations_site.project:
                        if project.account_manager:
                                project_manager = get_employee_user_id(project.account_manager)
                                if project_manager != operations_shift.owner and project_manager != current_user:
                                        action_user = project_manager
                                        Role = &#34;Project Manager&#34;

        return action_user, Role</code></pre>
</details>
</dd>
<dt id="api.tasks.get_active_shifts"><code class="name flex">
<span>def <span class="ident">get_active_shifts</span></span>(<span>now_time)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def get_active_shifts(now_time):
        return frappe.db.sql(&#34;&#34;&#34;
                SELECT
                        name, start_time, end_time,
                        has_split_shift, first_shift_end_time, second_shift_start_time,
                        notification_reminder_after_shift_start, late_entry_grace_period,
                        notification_reminder_after_shift_end, allow_check_out_after_shift_end_time,
                        supervisor_reminder_shift_start, supervisor_reminder_start_ends, deadline
                FROM `tabShift Type`
                WHERE
                        CAST(&#39;{current_time}&#39; as date)
                        BETWEEN
                                CAST(start_time as date)
                        AND
                                IF(end_time &lt; start_time, DATE_ADD(CAST(end_time as date), INTERVAL 1 DAY), CAST(end_time as date))
        &#34;&#34;&#34;.format(current_time=now_time), as_dict=1)</code></pre>
</details>
</dd>
<dt id="api.tasks.get_current_schedules"><code class="name flex">
<span>def <span class="ident">get_current_schedules</span></span>(<span>employee, log_type=None)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def get_current_schedules(employee, log_type=None):
        # check if employee has logs in
        # Employee Checkin, Shift Request, Shift Permission
        # Attendance Request, Leaves
        employee_doc = frappe.db.get_value(&#34;Employee&#34;, employee, [&#39;name&#39;, &#39;holiday_list&#39;])
        start_date = str(getdate())
        curr_shift = get_current_shift(employee)
        # check day off
        if frappe.db.exists(&#39;Employee Schedule&#39;, {
                        &#39;employee&#39;:employee,
                        &#39;date&#39;:start_date,
                        &#39;employee_availability&#39;:&#39;Day Off&#39;
                        }
                ):
                return False

        # check holiday
        if get_holiday_today(start_date).get(employee_doc.holiday_list):
                return False

        if curr_shift:
                # check for leaves
                if frappe.db.sql(f&#34;&#34;&#34;
                                SELECT name, employee FROM `tabLeave Application`
                                WHERE employee=&#39;{employee}&#39; AND status IN (&#39;Open&#39;, &#39;Approved&#39;)
                                AND &#39;{start_date}&#39; BETWEEN from_date AND to_date;
                        &#34;&#34;&#34;, as_dict=1):
                        return False
                # check for shift permission:
                if frappe.db.exists(&#39;Shift Permission&#39;, {
                        &#39;employee&#39;:employee,
                        &#39;assigned_shift&#39;: curr_shift.name,
                        &#39;log_type&#39;:log_type
                        }):
                        return False

                # check for shift request:
                if frappe.db.sql(f&#34;&#34;&#34;
                                SELECT name, employee FROM `tabShift Request`
                                WHERE employee=&#39;{employee}&#39; AND docstatus=1
                                AND &#39;{start_date}&#39; BETWEEN from_date AND to_date;
                        &#34;&#34;&#34;, as_dict=1):
                        return False
                # check attendance request
                if frappe.db.sql(f&#34;&#34;&#34;
                                SELECT name, employee FROM `tabAttendance Request`
                                WHERE employee=&#39;{employee}&#39; AND docstatus=1
                                AND &#39;{start_date}&#39; BETWEEN from_date AND to_date;
                        &#34;&#34;&#34;, as_dict=1):
                        return False
                # check employee checkin
                if frappe.db.exists(&#39;Employee Checkin&#39;, {
                        &#39;employee&#39;:employee,
                        &#39;shift_assignment&#39;: curr_shift.name,
                        &#39;log_type&#39;:log_type
                        }):
                        return False
                return True
        else:
                return False</code></pre>
</details>
</dd>
<dt id="api.tasks.get_location"><code class="name flex">
<span>def <span class="ident">get_location</span></span>(<span>shift)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def get_location(shift):
        site = frappe.get_value(&#34;Operations Shift&#34;, {&#34;shift_type&#34;:shift}, &#34;site&#34;)
        location= frappe.db.sql(&#34;&#34;&#34;
                        SELECT loc.latitude, loc.longitude, loc.geofence_radius
                        FROM `tabLocation` as loc
                        WHERE
                                loc.name in (SELECT site_location FROM `tabOperations Site` where name=%s)
                        &#34;&#34;&#34;,site, as_dict=1)
        return location</code></pre>
</details>
</dd>
<dt id="api.tasks.get_notification_user"><code class="name flex">
<span>def <span class="ident">get_notification_user</span></span>(<span>employee, shift, Role)</span>
</code></dt>
<dd>
<div class="desc"><p>Shift &gt; Site &gt; Project &gt; Reports to</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@frappe.whitelist()
def get_notification_user(employee, shift, Role):
        &#34;&#34;&#34;
                        Shift &gt; Site &gt; Project &gt; Reports to
        &#34;&#34;&#34;
        operations_shift = frappe.get_doc(&#34;Operations Shift&#34;, shift)
        operations_site = frappe.get_doc(&#34;Operations Site&#34;, operations_shift.site)
        project = frappe.get_doc(&#34;Project&#34;, operations_site.project)
        project_manager = site_supervisor = shift_supervisor = None

        reports_to = frappe.get_value(&#34;Employee&#34;, {&#34;name&#34;:employee},[&#34;reports_to&#34;])

        if operations_site.project and project.account_manager and get_employee_user_id(project.account_manager) != operations_shift.owner:
                project_manager = get_employee_user_id(project.account_manager)
        if operations_site.account_supervisor and get_employee_user_id(operations_site.account_supervisor) != operations_shift.owner:
                site_supervisor = get_employee_user_id(operations_site.account_supervisor)
        elif operations_shift.supervisor and get_employee_user_id(operations_shift.supervisor) != operations_shift.owner:
                shift_supervisor = get_employee_user_id(operations_shift.supervisor)

        if Role == &#34;Report To&#34; and reports_to:
                notify_user = [get_employee_user_id(reports_to)]
        elif Role == &#34;Shift Supervisor&#34; and site_supervisor and project_manager:
                notify_user = [site_supervisor,project_manager]
        elif Role == &#34;Site Supervisor&#34; and project_manager:
                notify_user = [project_manager]
        else:
                notify_user = []

        return notify_user</code></pre>
</details>
</dd>
<dt id="api.tasks.get_shift_type"><code class="name flex">
<span>def <span class="ident">get_shift_type</span></span>(<span>time)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def get_shift_type(time):
        if time == &#34;AM&#34;:
                shift_type = frappe.get_list(&#34;Shift Type&#34;, {&#34;start_time&#34;: [&#34;&gt;=&#34;, &#34;00:00&#34;], &#34;start_time&#34;: [&#34;&lt;&#34;, &#34;12:00&#34;]},[&#39;name&#39;], pluck=&#39;name&#39;)
        else:
                shift_type = frappe.get_list(&#34;Shift Type&#34;, {&#34;start_time&#34;: [&#34;&gt;=&#34;, &#34;12:00&#34;]},[&#39;name&#39;], pluck=&#39;name&#39;)
        return shift_type</code></pre>
</details>
</dd>
<dt id="api.tasks.has_checkin_record"><code class="name flex">
<span>def <span class="ident">has_checkin_record</span></span>(<span>employee, log_type, date)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def has_checkin_record(employee, log_type, date):
        if frappe.db.exists(&#39;Employee Checkin&#39;, {
                &#39;employee&#39;:employee,
                &#39;date&#39;: date,
                &#39;log_type&#39;:log_type
                }):return True
        return False</code></pre>
</details>
</dd>
<dt id="api.tasks.initiate_checkin_notification"><code class="name flex">
<span>def <span class="ident">initiate_checkin_notification</span></span>(<span>res)</span>
</code></dt>
<dd>
<div class="desc"><p>params:
recipients: Dictionary consist of user ID and Emplloyee ID eg: [{'user_id': 's.shaikh@armor-services.com', 'name': 'HR-EMP-00001'}]
log_type: In or Out</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def initiate_checkin_notification(res):
        &#34;&#34;&#34;
        params:
        recipients: Dictionary consist of user ID and Emplloyee ID eg: [{&#39;user_id&#39;: &#39;s.shaikh@armor-services.com&#39;, &#39;name&#39;: &#39;HR-EMP-00001&#39;}]
        log_type: In or Out
        &#34;&#34;&#34;
        now_time = now()
        checkin_message = _(f&#34;&#34;&#34;
                &lt;a class=&#34;btn btn-success&#34; href=&#34;/app/face-recognition&#34;&gt;Check In&lt;/a&gt;&amp;nbsp;
                &lt;br&gt;
                Submit a Shift Permission if you are planing to arrive late
                &lt;a class=&#34;btn btn-primary&#34; href=&#34;/app/shift-permission/new-shift-permission-1&#34;&gt;Submit Shift Permission&lt;/a&gt;&amp;nbsp;
                &lt;br&gt;
                Submit an Attendance Request if there are issues in checkin or you forgot to checkin
                &lt;a class=&#34;btn btn-secondary&#34; href=&#34;/app/attendance-request/new-attendance-request-1&#34;&gt;Submit Attendance Request&lt;/a&gt;&amp;nbsp;
                &lt;br&gt;
                Submit a Shift Request if you are trying to checkin from another site location
                &lt;a class=&#34;btn btn-info&#34; href=&#34;/app/shift-request/new-shift-request-1&#34;&gt;Submit Shift Request&lt;/a&gt;&amp;nbsp;
                &lt;h3&gt;DON&#39;T FORGET TO CHECKIN&lt;/h3&gt;
        &#34;&#34;&#34;)

        checkin_message_after_grace = _(&#34;&#34;&#34;
                &lt;a class=&#34;btn btn-success&#34; href=&#34;/app/face-recognition&#34;&gt;Check In&lt;/a&gt;&amp;nbsp;
                &lt;br&gt;
                Submit a Shift Permission if you are planing to arrive late
                &lt;a class=&#34;btn btn-primary&#34; href=&#34;/app/shift-permission/new-shift-permission-1&#34;&gt;Submit Shift Permission&lt;/a&gt;&amp;nbsp;
                &lt;br&gt;
                Submit an Attendance Request if there are issues in checkin or you forgot to checkin
                &lt;a class=&#34;btn btn-secondary&#34; href=&#34;/app/attendance-request/new-attendance-request-1&#34;&gt;Submit Attendance Request&lt;/a&gt;&amp;nbsp;
                &lt;br&gt;
                Submit a Shift Request if you are trying to checkin from another site location
                &lt;a class=&#34;btn btn-info&#34; href=&#34;/app/shift-request/new-shift-request-1&#34;&gt;Submit Shift Request&lt;/a&gt;&amp;nbsp;
                &lt;h3&gt;IF YOU DO NOT CHECK-IN WITHIN THE NEXT 3 HOURS, YOU WOULD BE MARKED AS ABSENT&lt;/h3&gt;
        &#34;&#34;&#34;)


        checkout_message = _(&#34;&#34;&#34;
                &lt;a class=&#34;btn btn-danger&#34; href=&#34;/app/face-recognition&#34;&gt;Check Out&lt;/a&gt;
                Submit a Shift Permission if you are planing to leave early or is there any issue in checkout or forget to checkout
                &lt;a class=&#34;btn btn-primary&#34; href=&#34;/app/shift-permission/new-shift-permission-1&#34;&gt;Submit Shift Permission&lt;/a&gt;&amp;nbsp;
                &#34;&#34;&#34;)

        user_id_list = []
        checkin_reminders = []
        checkout_reminders = []
        after_grace_checkin_reminder = []
        after_grace_checkout_reminder = []
        supervisor_checkin_reminder = []
        supervisor_checkout_reminder = []

        #eg: recipient: {&#39;user_id&#39;: &#39;s.shaikh@armor-services.com&#39;, &#39;name&#39;: &#39;HR-EMP-00001&#39;}
        for recipient in res.employees:
                # split employees into lists
                if recipient.initial_checkin_reminder:
                        checkin_reminders.append(recipient)
                elif recipient.is_after_grace_checkin:
                        after_grace_checkin_reminder.append(recipient)
                elif recipient.is_supervisor_checkin_reminder:
                        supervisor_checkin_reminder.append(recipient)
                elif recipient.initial_checkout_reminder:
                        checkout_reminders.append(recipient)
                elif recipient.is_after_grace_checkout:
                        after_grace_checkout_reminder.append(recipient)
                elif recipient.is_supervisor_checkout_reminder:
                        supervisor_checkout_reminder.append(recipient)

        # process initial checkins
        if checkin_reminders:
                checkin_reminder_id_list = []
                notification_category = &#39;Attendance&#39;
                notification_title = _(&#34;Checkin reminder&#34;)
                notification_subject = _(&#34;Checkin in the next 5 minutes!&#34;)
                for recipient in checkin_reminders:
                        # if not has_checkin_record(recipient.employee, recipient.log_type, res.date):
                        # Append the list of user ID to send notification through email.
                        checkin_reminder_id_list.append(recipient.user_id)
                        #arrive late button is true only if the employee has the user role &#34;Head Office Employee&#34;.
                        user_roles = frappe.get_roles(recipient.user_id)
                        if &#34;Head Office Employee&#34; in user_roles:
                                push_notification_rest_api_for_checkin(
                                        recipient.employee, notification_title, notification_subject,
                                        checkin=True, arriveLate=True, checkout=False)
                        else:
                                push_notification_rest_api_for_checkin(
                                        recipient.employee, notification_title, notification_subject,
                                        checkin=True,arriveLate=False,checkout=False)
                send_notification(
                        notification_title, notification_subject, checkin_message,
                        notification_category, checkin_reminder_id_list
                )

        # # process checkins after grace period
        if after_grace_checkin_reminder:
                checkin_reminder_id_list = []
                notification_category = &#39;Attendance&#39;
                notification_title = _(&#34;Checkin reminder&#34;)
                notification_subject = _(&#34;Don&#39;t forget to Checkin!&#34;)
                for recipient in after_grace_checkin_reminder:
                        # if not has_checkin_record(recipient.employee, recipient.log_type, res.date):
                        # Append the list of user ID to send notification through email.
                        checkin_reminder_id_list.append(recipient.user_id)
                        #arrive late button is true only if the employee has the user role &#34;Head Office Employee&#34;.
                        user_roles = frappe.get_roles(recipient.user_id)
                        if &#34;Head Office Employee&#34; in user_roles:
                                push_notification_rest_api_for_checkin(
                                        recipient.employee, notification_title, notification_subject,
                                        checkin=True, arriveLate=True, checkout=False)
                        else:
                                push_notification_rest_api_for_checkin(
                                        recipient.employee, notification_title, notification_subject,
                                        checkin=True,arriveLate=False,checkout=False)
                send_notification(
                        notification_title, notification_subject, checkin_message_after_grace,
                        notification_category, checkin_reminder_id_list
                )


        # # process supervisor checkin reminder
        if supervisor_checkin_reminder:
                title = &#34;Checkin Report&#34;
                category = &#34;Attendance&#34;
                date = getdate()
                for recipient in supervisor_checkin_reminder:
                        action_user, Role = get_action_user(recipient.employee,recipient.operations_shift)
                        subject = _(&#34;{employee} has not checked in yet.&#34;.format(employee=recipient.employee_name))
                        action_message = _(&#34;&#34;&#34;
                                Submit a Shift Permission for the employee to give an excuse and not need to penalize
                                &lt;a class=&#34;btn btn-primary&#34; href=&#34;/app/shift-permission/new-shift-permission-1?employee={recipient.employee}&amp;log_type=IN&#34;&gt;Submit Shift Permission&lt;/a&gt;&amp;nbsp;
                                &lt;br/&gt;&lt;br/&gt;
                                Issue penalty for the employee
                                &lt;a class=&#39;btn btn-primary btn-danger no-punch-in&#39; id=&#39;{employee}_{date}_{shift}&#39; href=&#34;/app/penalty-issuance/new-penalty-issuance-1&#34;&gt;Issue Penalty&lt;/a&gt;
                        &#34;&#34;&#34;).format(recipient=recipient, shift=recipient.operations_shift, date=cstr(now_time), employee=recipient.employee, time=str(recipient.start_datetime))
                        if action_user is not None: #and not has_checkin_record(recipient.employee, recipient.log_type, res.date):
                                send_notification(title, subject, action_message, category, [action_user])

                        # notify_message = _(&#34;&#34;&#34;Note that {employee} from Shift {shift} has Not Checked in yet.&#34;&#34;&#34;).format(employee=recipient.employee_name, shift=recipient.operations_shift)
                        # if Role:
                        #       notify_user = get_notification_user(recipient.employee,recipient.operations_shift, Role)
                        #       if notify_user is not None: #and not has_checkin_record(recipient.employee, recipient.log_type, res.date):
                        #               send_notification(title, subject, notify_message, category, notify_user)

        # # process initial checkout
        if checkout_reminders:
                checkout_reminder_id_list = []
                notification_category = &#39;Attendance&#39;
                notification_title = _(&#34;Checkout reminder&#34;)
                notification_subject = _(&#34;Don&#39;t forget to Checkout!&#34;)
                for recipient in checkout_reminders:
                        # if not has_checkin_record(recipient.employee, recipient.log_type, res.date):
                        # Append the list of user ID to send notification through email.
                        checkout_reminder_id_list.append(recipient.user_id)
                        #arrive late button is true only if the employee has the user role &#34;Head Office Employee&#34;.
                        user_roles = frappe.get_roles(recipient.user_id)
                        if &#34;Head Office Employee&#34; in user_roles:
                                push_notification_rest_api_for_checkin(
                                        recipient.employee, notification_title, notification_subject,
                                        checkin=False, arriveLate=False, checkout=True)
                        else:
                                push_notification_rest_api_for_checkin(
                                        recipient.employee, notification_title, notification_subject,
                                        checkin=False,arriveLate=False,checkout=True)
                send_notification(
                        notification_title, notification_subject, checkout_message,
                        notification_category, checkout_reminder_id_list
                )


        # # process supervisor checkout reminder
        if supervisor_checkout_reminder:
                title = &#34;Checkout Report&#34;
                category = &#34;Attendance&#34;
                date = getdate()
                for recipient in supervisor_checkout_reminder:
                        action_user, Role = get_action_user(recipient.employee,recipient.operations_shift)
                        subject = _(&#34;{employee} has not checked out yet.&#34;.format(employee=recipient.employee_name))
                        action_message = _(&#34;&#34;&#34;
                                Submit a Shift Permission for the employee to give an excuse and not need to penalize
                                &lt;a class=&#34;btn btn-primary&#34; href=&#34;/app/shift-permission/new-shift-permission-1?employee={recipient.employee}&amp;log_type=OUT&#34;&gt;Submit Shift Permission&lt;/a&gt;&amp;nbsp;
                                &lt;br/&gt;&lt;br/&gt;
                                Issue penalty for the employee
                                &lt;a class=&#39;btn btn-primary btn-danger no-punch-in&#39; id=&#39;{employee}_{date}_{shift}&#39; href=&#34;/app/penalty-issuance/new-penalty-issuance-1&#34;&gt;Issue Penalty&lt;/a&gt;

                        &#34;&#34;&#34;).format(recipient=recipient, shift=recipient.operations_shift, date=cstr(now_time), employee=recipient.employee, time=str(recipient.start_datetime))
                        if action_user is not None:# and not has_checkin_record(recipient.employee, recipient.log_type, res.date):
                                send_notification(title, subject, action_message, category, [action_user])

                        # notify_message = _(&#34;&#34;&#34;Note that {employee} from Shift {shift} has Not Checked out yet.&#34;&#34;&#34;).format(employee=recipient.employee_name, shift=recipient.operations_shift)
                        # if Role:
                        #       notify_user = get_notification_user(recipient.employee,recipient.operations_shift, Role)
                        #       if notify_user is not None:# and not has_checkin_record(recipient.employee, recipient.log_type, res.date):
                        #               send_notification(title, subject, notify_message, category, notify_user)</code></pre>
</details>
</dd>
<dt id="api.tasks.issue_penalties"><code class="name flex">
<span>def <span class="ident">issue_penalties</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"><p>This function to issue penalty to employee if employee checkin late without Shift Permission to Arrive Late.
Also, if employee check out early withou Shift Permission to Leave Early</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def issue_penalties():
        &#34;&#34;&#34;This function to issue penalty to employee if employee checkin late without Shift Permission to Arrive Late.
        Also, if employee check out early withou Shift Permission to Leave Early
        &#34;&#34;&#34;
        # check if issue_penalty is enabled in the setting
        if not frappe.db.get_single_value(&#39;HR and Payroll Additional Settings&#39;, &#39;issue_penalty&#39;):
                return

        #Define the constant
        penalty_code_late_checkin = &#34;102&#34;
        penalty_code_early_checkout=&#34;103&#34;
        date = cstr(getdate())

        #Fetch the day&#39;s attendance
        attendance_list = frappe.get_list(&#34;Attendance&#34;,{&#34;attendance_date&#34;:date},[&#34;*&#34;])

        for attendance in attendance_list:
                #fetch location of the shift.
                location = get_location(attendance.operations_shift)

                if location:
                        penalty_location = str(location[0].latitude)+&#34;,&#34;+str(location[0].longitude)
                else:
                        penalty_location =&#34;0,0&#34;

                #Fetch Supervisor
                action_user, Role = get_action_user(attendance.employee,attendance.operations_shift)
                if Role:
                        issuing_user = get_notification_user(attendance.employee,attendance.operations_shift,Role) if get_notification_user(attendance.employee,attendance.operations_shift,Role) else get_employee_user_id(frappe.get_value(&#34;Employee&#34;,{&#34;name&#34;:attendance.employee},[&#39;reports_to&#39;]))
                else:
                        issuing_user= get_employee_user_id(frappe.get_value(&#34;Employee&#34;,{&#34;name&#34;:attendance.employee},[&#39;reports_to&#39;]))

                #Check if Shift Permission exists.
                shift_permission_late_entry = frappe.db.exists(&#34;Shift Permission&#34;,{&#39;employee&#39;:attendance.employee,&#34;date&#34;:date, &#34;permission_type&#34;:&#34;Arrive Late&#34;})
                shift_permission_early_exit = frappe.db.exists(&#34;Shift Permission&#34;,{&#39;employee&#39;:attendance.employee,&#34;date&#34;:date, &#34;permission_type&#34;:&#34;Leave Early&#34;})

                if attendance.late_entry == 1 and not shift_permission_late_entry:
                        issue_penalty(attendance.employee, now_datetime(), penalty_code_late_checkin, attendance.operations_shift, issuing_user, penalty_location)

                if attendance.early_exit == 1 and not shift_permission_early_exit:
                        issue_penalty(attendance.employee, now_datetime(), penalty_code_early_checkout, attendance.operations_shift, issuing_user, penalty_location)</code></pre>
</details>
</dd>
<dt id="api.tasks.issue_penalty"><code class="name flex">
<span>def <span class="ident">issue_penalty</span></span>(<span>employee, date, penalty_code, shift, issuing_user, penalty_location)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@frappe.whitelist()
def issue_penalty(employee, date, penalty_code, shift, issuing_user, penalty_location):
        issuing_employee = frappe.get_value(&#34;Employee&#34;, {&#34;user_id&#34;: issuing_user})
        penalty = frappe.get_value(&#34;Penalty Type&#34;, {&#34;penalty_code&#34; : penalty_code})
        site, project = frappe.get_value(&#34;Operations Shift&#34;, shift, [&#34;site&#34;, &#34;project&#34;])
        site_location = frappe.get_value(&#34;Operations Site&#34;, site, &#34;site_location&#34;)

        employee_id, employee_name, designation = frappe.get_value(&#34;Employee&#34;, employee, [&#34;name&#34;, &#34;employee_name&#34;, &#34;designation&#34;])

        penalty_issuance = frappe.new_doc(&#34;Penalty Issuance&#34;)
        penalty_issuance.issuing_time = now_datetime()
        penalty_issuance.location = penalty_location
        penalty_issuance.penalty_location = &#34;Head Office&#34;
        penalty_issuance.penalty_occurence_time = date
        penalty_issuance.shift = shift
        penalty_issuance.site = site
        penalty_issuance.project = project
        penalty_issuance.site_location = site_location
        penalty_issuance.append(&#34;employees&#34;, {
                &#34;employee_id&#34;: employee_id,
                &#34;employee_name&#34;: employee_name,
                &#34;designation&#34;: designation,
        })
        penalty_issuance.append(&#34;penalty_issuance_details&#34;,{
                &#34;penalty_type&#34;: penalty,
                &#34;exact_notes&#34;: penalty
        })
        penalty_issuance.issuing_employee = issuing_employee
        # penalty_issuance.employee_name = self.lead_name
        penalty_issuance.flags.ignore_permissions = True
        penalty_issuance.insert()
        penalty_issuance.submit()
        frappe.msgprint(_(&#39;A penalty has been issued against {0}&#39;.format(employee_name)))</code></pre>
</details>
</dd>
<dt id="api.tasks.mark_auto_attendance"><code class="name flex">
<span>def <span class="ident">mark_auto_attendance</span></span>(<span>shift_type)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def mark_auto_attendance(shift_type):
        doc = frappe.get_doc(&#34;Shift Type&#34;, shift_type.name)
        doc.process_auto_attendance()</code></pre>
</details>
</dd>
<dt id="api.tasks.mark_daily_attendance"><code class="name flex">
<span>def <span class="ident">mark_daily_attendance</span></span>(<span>start_date, end_date)</span>
</code></dt>
<dd>
<div class="desc"><p>This method marks attendance for all employees</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def mark_daily_attendance(start_date, end_date):
        &#34;&#34;&#34;
                This method marks attendance for all employees
        &#34;&#34;&#34;
        try:
                errors = []
                absent_list = []
                owner = frappe.session.user
                creation = now()
                # get holiday for today
                holiday_today = get_holiday_today(start_date)
                # Get shift type and make hashmap
                shift_types = frappe.get_list(&#34;Shift Type&#34;, fields=&#34;*&#34;)
                shift_types_dict = {}
                for i in shift_types:
                        shift_types_dict[i.name] = i

                # get employee schedule
                employee_schedules = frappe.db.get_list(&#34;Employee Schedule&#34;, filters={&#39;date&#39;:start_date, &#39;employee_availability&#39;:&#39;Day Off&#39;}, fields=&#34;*&#34;)
                employee_schedule_dict = {}
                for i in employee_schedules:
                        employee_schedule_dict[i.employee] = i

                employees = frappe.get_list(&#34;Employee&#34;, fields=&#34;*&#34;)
                employees_data = {}
                for i in employees:
                        employees_data[i.name] = i

                employees_dict = {}

                # get open leaves
                open_leaves = frappe.db.sql(f&#34;&#34;&#34;
                        SELECT name, employee FROM `tabLeave Application`
                        WHERE &#39;{start_date}&#39; BETWEEN from_date AND to_date AND status=&#39;Open&#39;;
                &#34;&#34;&#34;, as_dict=1)
                # get attendance for the day
                attendance_list = frappe.get_list(&#34;Attendance&#34;, filters={&#34;attendance_date&#34;:start_date, &#39;status&#39;: [&#39;NOT IN&#39;, [&#39;On Leave&#39;, &#39;Work From Home&#39;, &#39;Day Off&#39;, &#39;Holiday&#39;, &#39;Present&#39;]]})
                attendance_dict = {}
                for i in attendance_list:
                        attendance_dict[i.employee] = i
                # present attendance
                present_attendance_list = frappe.get_list(&#34;Attendance&#34;, filters={&#34;attendance_date&#34;:start_date, &#39;status&#39;: [&#39;IN&#39;, [&#39;On Leave&#39;, &#39;Work From Home&#39;, &#39;Day Off&#39;, &#39;Holiday&#39;, &#39;Present&#39;]]})
                present_attendance_dict = {}
                for i in present_attendance_list:
                        present_attendance_dict[i.employee] = i
                # exempt leave applicants from attendance
                for i in open_leaves:
                        present_attendance_dict[i.employee] = i
                # Get shift assignment and make hashmap
                shift_assignments = frappe.db.sql(f&#34;&#34;&#34;
                        SELECT * FROM `tabShift Assignment` WHERE start_date=&#34;{start_date}&#34; AND end_date=&#34;{end_date}&#34; AND roster_type=&#39;Basic&#39;
                        AND docstatus=1 AND status=&#39;Active&#39;
                &#34;&#34;&#34;, as_dict=1)
                shift_assignments_dict = {}
                shift_assignments_list = [i.name for i in shift_assignments]

                for row in shift_assignments:
                        shift_assignments_dict[row.name] = row
                        if row.employee in employees:
                                if employees_dict.get(row.employee):
                                        employees_dict[row.employee][&#39;shift_assignments&#39;].append(row)
                                else:
                                        employees_dict[row.employee] = {&#39;shift_assignments&#39;:[row]}

                shift_assignments_tuple = str(tuple(shift_assignments_list)) #[:-2]+&#39;)&#39;

                # Get checkins and make hashmap
                in_checkins = frappe.get_list(&#34;Employee Checkin&#34;, filters={&#34;shift_assignment&#34;: [&#34;IN&#34;, shift_assignments_list], &#39;log_type&#39;: &#39;IN&#39;},
                        fields=&#34;name, owner, creation, modified, modified_by, docstatus, idx, employee, employee_name, log_type, late_entry, early_exit, time, date, skip_auto_attendance, shift_actual_start, shift_actual_end, shift_assignment, operations_shift, shift_type, shift_permission, actual_time, MIN(time) as time&#34;,
                        order_by=&#34;employee ASC&#34;, group_by=&#34;shift_assignment&#34;)
                out_checkins = frappe.get_list(&#34;Employee Checkin&#34;, filters={&#34;shift_assignment&#34;: [&#34;IN&#34;, shift_assignments_list], &#39;log_type&#39;: &#39;OUT&#39;},
                        fields=&#34;name, owner, creation, modified, modified_by, docstatus, idx, employee, employee_name, log_type, late_entry, early_exit, time, date, skip_auto_attendance, shift_actual_start, shift_actual_end, shift_assignment, operations_shift, shift_type, shift_permission, actual_time, MAX(time) as time&#34;,
                        order_by=&#34;employee DESC&#34;, group_by=&#34;shift_assignment&#34;)

                in_checkins_dict = {}
                for i in in_checkins:
                        in_checkins_dict[i.shift_assignment] = i

                out_checkins_dict = {}
                for i in out_checkins:
                        out_checkins_dict[i.shift_assignment] = i


                # create attendance object
                employee_checkin = []
                employee_attendance = {}
                checkin_no_out = []
                for k, v in in_checkins_dict.items():
                        try:
                                emp = employees_data.get(v.employee)
                                if attendance_dict.get(v.employee):
                                        name = attendance_dict.get(v.employee).name
                                else:
                                        name = f&#34;HR-ATT-{start_date}-{v.employee}&#34;
                                shift_type = shift_types_dict.get(v.shift_type)
                                shift_assignment = shift_assignments_dict.get(v.shift_assignment)
                                in_time = v.time

                                # check if late entry &gt; 4hrs
                                if ((in_time - shift_assignment.start_datetime).total_seconds() / (60*60)) &gt; 4:
                                        working_hours = 0
                                        employee_attendance[i.employee] = frappe._dict({
                                                &#39;name&#39;:f&#34;HR-ATT-{start_date}-{i.employee}&#34;, &#39;employee&#39;:i.employee, &#39;employee_name&#39;:emp.employee_name, &#39;working_hours&#39;:0, &#39;status&#39;:&#39;Absent&#39;,
                                                &#39;shift&#39;:i.shift_type, &#39;in_time&#39;:&#39;00:00:00&#39;, &#39;out_time&#39;:&#39;00:00:00&#39;, &#39;shift_assignment&#39;:v.shift_assignment, &#39;operations_shift&#39;:v.operations_shift,
                                                &#39;site&#39;:i.site, &#39;project&#39;:i.project, &#39;attendance_date&#39;: start_date, &#39;company&#39;:emp.company,
                                                &#39;department&#39;: emp.department, &#39;late_entry&#39;:0, &#39;early_exit&#39;:0, &#39;operations_role&#39;:i.operations_role, &#39;post_abbrv&#39;:i.post_abbrv,
                                                &#39;roster_type&#39;:i.roster_type, &#39;docstatus&#39;:1, &#39;owner&#39;:owner, &#39;modified_by&#39;:owner, &#39;creation&#39;:creation, &#39;modified&#39;:creation, &#34;comment&#34;:f&#34;Checked in 4hrs late at {in_time}&#34;
                                        })
                                        if not i.employee in absent_list:absent_list.append(i.employee)
                                # check if checkout exists
                                elif out_checkins_dict.get(k):
                                        check_out = out_checkins_dict.get(k)
                                        out_time = check_out.time
                                        working_hours = (out_time - in_time).total_seconds() / (60 * 60)
                                        employee_checkin.append({name:{&#39;in&#39;:v.name, &#39;out&#39;:check_out.name}}) # add checkin for update
                                        employee_attendance[v.employee] = frappe._dict({
                                                &#39;name&#39;:name, &#39;employee&#39;:v.employee, &#39;employee_name&#39;:emp.employee_name, &#39;working_hours&#39;:working_hours, &#39;status&#39;:&#39;Present&#39;,
                                                &#39;shift&#39;:v.shift_type, &#39;in_time&#39;:in_time, &#39;out_time&#39;:out_time, &#39;shift_assignment&#39;:v.shift_assignment, &#39;operations_shift&#39;:v.operations_shift,
                                                &#39;site&#39;:shift_assignment.site, &#39;project&#39;:shift_assignment.project, &#39;attendance_date&#39;: start_date, &#39;company&#39;:shift_assignment.company,
                                                &#39;department&#39;: emp.department, &#39;late_entry&#39;:v.late_entry, &#39;early_exit&#39;:check_out.early_exit, &#39;operations_role&#39;:shift_assignment.operations_role,
                                                &#39;post_abbrv&#39;:shift_assignment.post_abbrv,
                                                &#39;roster_type&#39;:shift_assignment.roster_type, &#39;docstatus&#39;:1, &#39;owner&#39;:owner, &#39;modified_by&#39;:owner, &#39;creation&#39;:creation, &#39;modified&#39;:creation, &#39;comment&#39;:&#34;&#34;
                                        })
                                else: # no checkout record found
                                        working_hours = (shift_assignment.end_datetime - in_time).total_seconds() / (60 * 60)
                                        employee_checkin.append({name:{&#39;in&#39;:v.name, &#39;out&#39;:v.name}}) # add checkin for update
                                        employee_attendance[v.employee] = frappe._dict({
                                                &#39;name&#39;:name, &#39;employee&#39;:v.employee, &#39;employee_name&#39;:emp.employee_name, &#39;working_hours&#39;:working_hours, &#39;status&#39;:&#39;Present&#39;,
                                                &#39;shift&#39;:v.shift_type, &#39;in_time&#39;:in_time, &#39;out_time&#39;:shift_assignment.end_datetime, &#39;shift_assignment&#39;:v.shift_assignment, &#39;operations_shift&#39;:v.operations_shift,
                                                &#39;site&#39;:shift_assignment.site, &#39;project&#39;:shift_assignment.project, &#39;attendance_date&#39;: start_date, &#39;company&#39;:shift_assignment.company,
                                                &#39;department&#39;: emp.department, &#39;late_entry&#39;:v.late_entry, &#39;early_exit&#39;:0, &#39;operations_role&#39;:shift_assignment.operations_role,
                                                &#39;post_abbrv&#39;:shift_assignment.post_abbrv,
                                                &#39;roster_type&#39;:shift_assignment.roster_type, &#39;docstatus&#39;:1, &#39;owner&#39;:owner, &#39;modified_by&#39;:owner, &#39;creation&#39;:creation, &#39;modified&#39;:creation, &#39;comment&#39;:&#34;Checkin but no checkout record found&#34;
                                        })
                                        # add employee to no checkout record found
                                        checkin_no_out.append({&#39;employee&#39;:v.employee, &#39;in&#39;:v.name, &#39;shift_assignment&#39;:v.shift_assignment})
                        except Exception as e:
                                errors.append(str(frappe.get_traceback()))
                # add absent, day off and holiday in shift assignment
                for i in shift_assignments:
                        try:
                                if not employee_attendance.get(i.employee):
                                        # check for day off
                                        comment = &#34;&#34;
                                        if employee_schedule_dict.get(i.employee):
                                                availability = &#39;Day Off&#39;
                                        elif holiday_today and holiday_today.get(employees_data[i.employee].holiday_list):
                                                availability = &#39;Holiday&#39;
                                                comment = str(holiday_today.get(employees_data[i.employee].holiday_list))
                                        else:
                                                availability = &#39;Absent&#39;

                                        emp = employees_data.get(i.employee)
                                        if not emp:
                                                emp = frappe._dict({&#39;department&#39;: &#39;&#39;, &#39;employee_name&#39;: &#39;&#39;})
                                        employee_attendance[i.employee] = frappe._dict({
                                                &#39;name&#39;:f&#34;HR-ATT-{start_date}-{i.employee}&#34;, &#39;employee&#39;:i.employee, &#39;employee_name&#39;:emp.employee_name, &#39;working_hours&#39;:0, &#39;status&#39;:availability,
                                                &#39;shift&#39;:i.shift_type, &#39;in_time&#39;:&#39;00:00:00&#39;, &#39;out_time&#39;:&#39;00:00:00&#39;, &#39;shift_assignment&#39;:i.name, &#39;operations_shift&#39;:i.shift,
                                                &#39;site&#39;:i.site, &#39;project&#39;:i.project, &#39;attendance_date&#39;: start_date, &#39;company&#39;:i.company,
                                                &#39;department&#39;: emp.department, &#39;late_entry&#39;:0, &#39;early_exit&#39;:0, &#39;operations_role&#39;:i.operations_role, &#39;post_abbrv&#39;:i.post_abbrv,
                                                &#39;roster_type&#39;:i.roster_type, &#39;docstatus&#39;:1, &#39;owner&#39;:owner, &#39;modified_by&#39;:owner, &#39;creation&#39;:creation, &#39;modified&#39;:creation,
                                                &#39;comment&#39;:comment
                                        })
                                        if (availability == &#39;Absent&#39;) and (not i.employee in absent_list):absent_list.append(i.employee)
                        except Exception as e:
                                errors.append(str(frappe.get_traceback()))

                # mark day off if non above is met
                for i in employee_schedules:
                        try:
                                if not employee_attendance.get(i.employee):
                                        emp = employees_data.get(i.employee)
                                        employee_attendance[i.employee] = frappe._dict({
                                                &#39;name&#39;:f&#34;HR-ATT-{start_date}-{i.employee}&#34;, &#39;employee&#39;:i.employee, &#39;employee_name&#39;:emp.employee_name, &#39;working_hours&#39;:0, &#39;status&#39;:&#39;Day Off&#39;,
                                                &#39;shift&#39;:i.shift_type, &#39;in_time&#39;:&#39;00:00:00&#39;, &#39;out_time&#39;:&#39;00:00:00&#39;, &#39;shift_assignment&#39;:&#39;&#39;, &#39;operations_shift&#39;:i.shift,
                                                &#39;site&#39;:i.site, &#39;project&#39;:i.project, &#39;attendance_date&#39;: start_date, &#39;company&#39;:emp.company,
                                                &#39;department&#39;: emp.department, &#39;late_entry&#39;:0, &#39;early_exit&#39;:0, &#39;operations_role&#39;:i.operations_role, &#39;post_abbrv&#39;:i.post_abbrv,
                                                &#39;roster_type&#39;:i.roster_type, &#39;docstatus&#39;:1, &#39;owner&#39;:owner, &#39;modified_by&#39;:owner, &#39;creation&#39;:creation, &#39;modified&#39;:creation, &#39;comment&#39;:f&#34;Employee Schedule - {i.name}&#34;
                                        })
                        except Exception as e:
                                errors.append(str(frappe.get_traceback()))


                # create attendance with sql injection
                if employee_attendance:
                        query = &#34;&#34;&#34;
                                INSERT INTO `tabAttendance` (`name`, `employee`, `employee_name`, `working_hours`, `status`, `shift`, `in_time`, `out_time`,
                                `shift_assignment`, `operations_shift`, `site`, `project`, `attendance_date`, `company`,
                                `department`, `late_entry`, `early_exit`, `operations_role`, `post_abbrv`, `roster_type`, `docstatus`, `modified_by`, `owner`,
                                `creation`, `modified`, `comment`)
                                VALUES

                        &#34;&#34;&#34;

                        for k, v in employee_attendance.items():
                                if not present_attendance_dict.get(v.employee):
                                        query+= f&#34;&#34;&#34;
                                        (
                                                &#34;{v.name}&#34;, &#34;{v.employee}&#34;, &#34;{v.employee_name}&#34;, {v.working_hours}, &#34;{v.status}&#34;, &#39;{v.shift}&#39;, &#39;{v.in_time}&#39;,
                                                &#39;{v.out_time}&#39;, &#34;{v.shift_assignment}&#34;, &#34;{v.operations_shift}&#34;, &#34;{v.site}&#34;, &#34;{v.project}&#34;, &#34;{v.attendance_date}&#34;, &#34;{v.company}&#34;,
                                                &#34;{v.department}&#34;, {v.late_entry}, {v.early_exit}, &#34;{v.operations_role}&#34;, &#34;{v.post_abbrv}&#34;, &#34;{v.roster_type}&#34;, {v.docstatus}, &#34;{v.owner}&#34;,
                                                &#34;{v.owner}&#34;, &#34;{v.creation}&#34;, &#34;{v.modified}&#34;, &#34;{v.comment}&#34;
                                        ),&#34;&#34;&#34;

                        query = query[:-1]
                        query += f&#34;&#34;&#34;
                                        ON DUPLICATE KEY UPDATE
                                        employee = VALUES(employee),
                                        employee_name = VALUES(employee_name),
                                        working_hours = VALUES(working_hours),
                                        status = VALUES(status),
                                        shift = VALUES(shift),
                                        in_time = VALUES(in_time),
                                        out_time = VALUES(out_time),
                                        shift_assignment = VALUES(shift_assignment),
                                        operations_shift = VALUES(operations_shift),
                                        site = VALUES(site),
                                        project = VALUES(project),
                                        attendance_date = VALUES(attendance_date),
                                        company = VALUES(company),
                                        department = VALUES(department),
                                        late_entry = VALUES(late_entry),
                                        early_exit = VALUES(early_exit),
                                        operations_role = VALUES(operations_role),
                                        roster_type = VALUES(roster_type),
                                        docstatus = VALUES(docstatus),
                                        modified_by = VALUES(modified_by),
                                        modified = VALUES(modified)
                                &#34;&#34;&#34;
                        try:
                                frappe.db.sql(query, values=[], as_dict=1)
                                frappe.db.commit()
                                # update checkin links
                                if employee_checkin:
                                        query = &#34;&#34;&#34;
                                                INSERT INTO `tabEmployee Checkin`
                                                (`name`, `attendance`)
                                                VALUES
                                        &#34;&#34;&#34;
                                        for i in employee_checkin:
                                                k = list(i.keys())[0]
                                                v = i[k]
                                                query += f&#34;&#34;&#34;
                                                        (&#34;{v[&#39;in&#39;]}&#34;, &#34;{k}&#34;),
                                                        (&#34;{v[&#39;out&#39;]}&#34;, &#34;{k}&#34;),&#34;&#34;&#34;
                                        query = query[:-1]
                                        query += f&#34;&#34;&#34;
                                                ON DUPLICATE KEY UPDATE
                                                attendance = VALUES(attendance)
                                        &#34;&#34;&#34;
                                        frappe.db.sql(query, values=[], as_dict=1)
                                        frappe.db.commit()
                        except Exception as e:
                                errors.append(frappe.get_traceback())

                # check for error
                if len(errors):
                        frappe.log_error(str(errors), &#34;Mark Attendance&#34;)
                #
                # remark absent attendance and holiday list
                if (start_date==end_date):
                        holiday_list_today = [k for k,v in get_holiday_today(start_date).items()]
                        holidays = []
                        for i in holiday_list_today:
                                holidays += frappe.db.sql(f&#34;&#34;&#34;
                                        SELECT name FROM `tabEmployee`
                                        WHERE status=&#39;Active&#39; AND holiday_list=&#34;{i}&#34;
                                        AND name not in (
                                                SELECT employee FROM `tabShift Assignment`
                                                WHERE start_date=&#39;{start_date}&#39;)
                                &#34;&#34;&#34;, as_dict=1)
                        if holidays:
                                absent_list = [i.name for i in holidays]+absent_list

                frappe.enqueue(&#34;one_fm.overrides.attendance.remark_absent_for_employees&#34;,
                        employees=absent_list, date=str(start_date), queue=&#39;long&#39;, timeout=6000)
                frappe.enqueue(&#34;one_fm.overrides.attendance.mark_overtime_attendance&#34;,
                        from_date=start_date, to_date=end_date, queue=&#39;long&#39;, timeout=6000)
        except Exception as e:
                frappe.log_error(frappe.get_traceback(), &#39;Mark Attendance&#39;)</code></pre>
</details>
</dd>
<dt id="api.tasks.mark_day_attendance"><code class="name flex">
<span>def <span class="ident">mark_day_attendance</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def mark_day_attendance():
        from one_fm.operations.doctype.shift_permission.shift_permission import approve_open_shift_permission
        start_date, end_date = add_days(getdate(), -1), add_days(getdate(), -1)
        approve_open_shift_permission(str(start_date), str(end_date))
        approve_open_employee_checkin_issue(str(start_date), str(end_date))
        frappe.enqueue(mark_daily_attendance, start_date=start_date, end_date=end_date, timeout=4000, queue=&#39;long&#39;)</code></pre>
</details>
</dd>
<dt id="api.tasks.mark_deadline_attendance"><code class="name flex">
<span>def <span class="ident">mark_deadline_attendance</span></span>(<span>shifts_list, now_time)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def mark_deadline_attendance(shifts_list, now_time):
        for shift in shifts_list:
                date = getdate()
                if shift.start_time &lt; shift.end_time and nowtime() &lt; cstr(shift.start_time):
                        date = getdate() - timedelta(days=1)

                if shift.deadline==1:
                        recipients = []
                        if shift.has_split_shift == 1 and (now_time == shift.start_time + ((shift.first_shift_end_time - shift.start_time)/2) or now_time == shift.second_shift_start_time + ((shift.end_time -shift.second_shift_start_time)/2)):
                                start_time_1 = datetime.datetime.strptime(cstr(date)+&#34; &#34;+cstr(shift.start_time - timedelta(minutes=cint(shift.begin_check_in_before_shift_start_time))), &#39;%Y-%m-%d %H:%M:%S&#39;)
                                start_time_2 = datetime.datetime.strptime(cstr(date)+&#34; &#34;+cstr(shift.second_shift_start_time - timedelta(minutes=cint(shift.begin_check_in_before_shift_start_time))), &#39;%Y-%m-%d %H:%M:%S&#39;)
                                recipients = frappe.db.sql(&#34;&#34;&#34;
                                        SELECT DISTINCT emp.name FROM `tabShift Assignment` tSA, `tabEmployee` emp
                                        WHERE
                                                tSA.employee = emp.name
                                        AND tSA.start_date=&#39;{date}&#39;
                                        AND tSA.shift_type=&#39;{shift_type}&#39;
                                        AND tSA.docstatus=1
                                        AND tSA.employee
                                        NOT IN(SELECT employee FROM `tabShift Permission` emp_sp
                                        WHERE
                                                emp_sp.employee=emp.name
                                        AND emp_sp.workflow_state=&#34;Approved&#34;
                                        AND emp_sp.shift_type=&#39;{shift_type}&#39;
                                        AND emp_sp.date=&#39;{date}&#39;
                                        AND emp_sp.permission_type=&#34;Arrive Late&#34;)
                                        AND tSA.employee
                                        NOT IN(SELECT employee FROM `tabAttendance Request` att_req
                                        WHERE
                                                att_req.employee=emp.name
                                        AND att_req.workflow_state=&#39;Approved&#39;
                                        AND att_req.reason=&#39;Work From Home&#39;
                                        AND CAST(&#39;{date} &#39; as date) BETWEEN att_req.from_date AND att_req.to_date)
                                        AND tSA.employee
                                        NOT IN(SELECT employee FROM `tabLeave Application` LA
                                        WHERE
                                                LA.employee=emp.name
                                        AND LA.workflow_state=&#39;Approved&#39;
                                        AND CAST(&#39;{date} &#39; as date) BETWEEN LA.from_date AND LA.to_date)
                                        AND tSA.employee
                                        NOT IN(SELECT employee FROM `tabEmployee Checkin` empChkin
                                        WHERE
                                                empChkin.log_type=&#34;IN&#34;
                                        AND empChkin.skip_auto_attendance=0
                                        AND date(empChkin.time)=&#39;{date}&#39;
                                        AND empChkin.time BETWEEN &#39;{start_time_1}&#39; and &#39;{now_time}&#39;
                                        OR empChkin.time BETWEEN &#39;{start_time_2}&#39; and &#39;{now_time}&#39;
                                        AND empChkin.shift_type=&#39;{shift_type}&#39;)
                                        AND tSA.start_date
                                        NOT IN(SELECT holiday_date from `tabHoliday` h
                                        WHERE
                                                h.parent = emp.holiday_list
                                        AND h.holiday_date = &#39;{date}&#39;)
                                &#34;&#34;&#34;.format(date=cstr(date), shift_type=shift.name, start_time_1 = start_time_1, start_time_2 = start_time_2, now_time = now_time), as_list=1)

                        elif now_time == shift.start_time + ((shift.end_time - shift.start_time)/2):
                                recipients = frappe.db.sql(&#34;&#34;&#34;
                                        SELECT DISTINCT emp.name FROM `tabShift Assignment` tSA, `tabEmployee` emp
                                        WHERE
                                                tSA.employee = emp.name
                                        AND tSA.start_date=&#39;{date}&#39;
                                        AND tSA.shift_type=&#39;{shift_type}&#39;
                                        AND tSA.docstatus=1
                                        AND tSA.employee
                                        NOT IN(SELECT employee FROM `tabShift Permission` emp_sp
                                        WHERE
                                                emp_sp.employee=emp.name
                                        AND emp_sp.workflow_state=&#34;Approved&#34;
                                        AND emp_sp.shift_type=&#39;{shift_type}&#39;
                                        AND emp_sp.date=&#39;{date}&#39;
                                        AND emp_sp.permission_type=&#34;Arrive Late&#34;)
                                        AND tSA.employee
                                        NOT IN(SELECT employee FROM `tabAttendance Request` att_req
                                        WHERE
                                                att_req.employee=emp.name
                                        AND att_req.workflow_state=&#39;Approved&#39;
                                        AND att_req.reason=&#39;Work From Home&#39;
                                        AND CAST(&#39;{date} &#39; as date) BETWEEN att_req.from_date AND att_req.to_date)
                                        AND tSA.employee
                                        NOT IN(SELECT employee FROM `tabLeave Application` LA
                                        WHERE
                                                LA.employee=emp.name
                                        AND LA.workflow_state=&#39;Approved&#39;
                                        AND CAST(&#39;{date} &#39; as date) BETWEEN LA.from_date AND LA.to_date)
                                        AND tSA.employee
                                        NOT IN(SELECT employee FROM `tabEmployee Checkin` empChkin
                                        WHERE
                                                empChkin.log_type=&#34;IN&#34;
                                        AND empChkin.skip_auto_attendance=0
                                        AND date(empChkin.time)=&#39;{date}&#39;
                                        AND empChkin.shift_type=&#39;{shift_type}&#39;)
                                        AND tSA.start_date
                                        NOT IN(SELECT holiday_date from `tabHoliday` h
                                        WHERE
                                                h.parent = emp.holiday_list
                                        AND h.holiday_date = &#39;{date}&#39;)
                                &#34;&#34;&#34;.format(date=cstr(date), shift_type=shift.name), as_list=1)

                        if len(recipients) &gt; 0:
                                employees = [recipient[0] for recipient in recipients if recipient[0]]

                                for employee in employees:
                                        mark_attendance(employee=employee, attendance_date=date, status=&#39;Absent&#39;, shift=shift.name)

                        frappe.db.commit()</code></pre>
</details>
</dd>
<dt id="api.tasks.mark_night_attendance"><code class="name flex">
<span>def <span class="ident">mark_night_attendance</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def mark_night_attendance():
        from one_fm.operations.doctype.shift_permission.shift_permission import approve_open_shift_permission
        start_date = add_days(getdate(), -1)
        end_date =  getdate()
        approve_open_shift_permission(str(start_date), str(end_date))
        approve_open_employee_checkin_issue(str(start_date), str(end_date))
        frappe.enqueue(mark_daily_attendance, start_date=start_date, end_date=end_date, timeout=4000, queue=&#39;long&#39;)</code></pre>
</details>
</dd>
<dt id="api.tasks.notify_checkin_checkout_final_reminder"><code class="name flex">
<span>def <span class="ident">notify_checkin_checkout_final_reminder</span></span>(<span>recipients, log_type, notification_title, notification_subject, is_after_grace_checkin=0)</span>
</code></dt>
<dd>
<div class="desc"><p>params:
recipients: Dictionary consist of user ID and Emplloyee ID eg: [{'user_id': 's.shaikh@armor-services.com', 'name': 'HR-EMP-00001'}]
log_type: In or Out</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@frappe.whitelist()
def notify_checkin_checkout_final_reminder(recipients, log_type, notification_title, notification_subject,  is_after_grace_checkin=0):
        &#34;&#34;&#34;
        params:
        recipients: Dictionary consist of user ID and Emplloyee ID eg: [{&#39;user_id&#39;: &#39;s.shaikh@armor-services.com&#39;, &#39;name&#39;: &#39;HR-EMP-00001&#39;}]
        log_type: In or Out
        &#34;&#34;&#34;
        #defining the subject and message
        notification_category = &#34;Attendance&#34;

        checkin_message_body = &#34;&#34;&#34;
                                        &lt;a class=&#34;btn btn-success&#34; href=&#34;/app/face-recognition&#34;&gt;Check In&lt;/a&gt;&amp;nbsp;
                                        &lt;br/&gt;
                                        Submit a Shift Permission if you are planing to arrive late or forgot to checkin
                                        &lt;a class=&#34;btn btn-primary&#34; href=&#34;/app/shift-permission/new-shift-permission-1?log_type=IN&amp;&amp;permission_type=Arrive Late&#34;&gt;Submit Shift Permission&lt;/a&gt;&amp;nbsp;
                                        &lt;br/&gt;
                                        Submit a Employee Checkin Issue if there are issues in checkin
                                        &lt;a class=&#34;btn btn-secondary&#34; href=&#34;/app/employee-checkin-issue/new-employee-checkin-issue-1?log_type=IN&#34;&gt;Submit Employee Checkin Issue&lt;/a&gt;&amp;nbsp;
                                        &lt;br/&gt;
                                        &lt;h3&gt;{0}&lt;/h3&gt;
                                        &#34;&#34;&#34;
        checkin_message = _(checkin_message_body.format(&#34;DON&#39;T FORGET TO CHECKIN&#34;))

        if is_after_grace_checkin:
                checkin_message = _(checkin_message_body.format(&#34;IF YOU DO NOT CHECK-IN WITHIN THE NEXT 3 HOURS, YOU WOULD BE MARKED AS ABSENT&#34;))

        checkout_message = _(&#34;&#34;&#34;
                &lt;a class=&#34;btn btn-danger&#34; href=&#34;/app/face-recognition&#34;&gt;Check Out&lt;/a&gt;
                &lt;br/&gt;
                Submit a Shift Permission if you are planing to leave early or forget to checkout
                &lt;a class=&#34;btn btn-primary&#34; href=&#34;/app/shift-permission/new-shift-permission-1?log_type=OUT&amp;&amp;permission_type=Leave Early&#34;&#34;&gt;Submit Shift Permission&lt;/a&gt;&amp;nbsp;
                &lt;br/&gt;
                Submit a Employee Checkin Issue if there are issues in checkout
                &lt;a class=&#34;btn btn-secondary&#34; href=&#34;/app/employee-checkin-issue/new-employee-checkin-issue-1?log_type=OUT&#34;&gt;Submit Employee Checkin Issue&lt;/a&gt;&amp;nbsp;
                &#34;&#34;&#34;)

        user_id_list = []

        #eg: recipient: {&#39;user_id&#39;: &#39;s.shaikh@armor-services.com&#39;, &#39;name&#39;: &#39;HR-EMP-00001&#39;}
        for recipient in recipients:
                # Append the list of user ID to send notification through email.
                user_id_list.append(recipient.user_id)

                # Get Employee ID and User Role for the given recipient
                employee_id = recipient.name
                user_roles = frappe.get_roles(recipient.user_id)

                #cutomizing buttons according to log type.
                # check if employee yet to have record for attendance
                if log_type==&#34;IN&#34;:
                        #arrive late button is true only if the employee has the user role &#34;Head Office Employee&#34;.
                        if &#34;Head Office Employee&#34; in user_roles:
                                push_notification_rest_api_for_checkin(employee_id, notification_title, notification_subject, checkin=True,arriveLate=True,checkout=False)
                        else:
                                push_notification_rest_api_for_checkin(employee_id, notification_title, notification_subject, checkin=True,arriveLate=False,checkout=False)
                if log_type==&#34;OUT&#34;:
                        push_notification_rest_api_for_checkin(employee_id, notification_title, notification_subject, checkin=False,arriveLate=False,checkout=True)


        # send notification mail to list of employee using user_id
        if log_type == &#34;IN&#34;:
                send_notification(notification_title, notification_subject, checkin_message,notification_category,user_id_list)
        elif log_type == &#34;OUT&#34;:
                send_notification(notification_title, notification_subject, checkout_message, notification_category, user_id_list)</code></pre>
</details>
</dd>
<dt id="api.tasks.overtime_shift_assignment"><code class="name flex">
<span>def <span class="ident">overtime_shift_assignment</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"><p>This method is to generate Shift Assignment for Employee Scheduling
with roster type 'Over_Time'. It first looks up for Shift Assignment
of the employee for the day if he has any. Change the Status to "Inactive"
and proceeds with creating New shift Assignments with Roster Type OverTime.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def overtime_shift_assignment():
        &#34;&#34;&#34;
        This method is to generate Shift Assignment for Employee Scheduling
        with roster type &#39;Over_Time&#39;. It first looks up for Shift Assignment
        of the employee for the day if he has any. Change the Status to &#34;Inactive&#34;
        and proceeds with creating New shift Assignments with Roster Type OverTime.
        &#34;&#34;&#34;
        date = cstr(getdate())
        now_time = now_datetime().strftime(&#34;%H:%M:00&#34;)
        roster = frappe.get_all(&#34;Employee Schedule&#34;, {&#34;date&#34;: date, &#34;employee_availability&#34;: &#34;Working&#34; , &#34;roster_type&#34;: &#34;Over-Time&#34;}, [&#34;*&#34;])
        frappe.enqueue(process_overtime_shift,roster=roster, date=date, time=now_time, is_async=True, queue=&#39;long&#39;)</code></pre>
</details>
</dd>
<dt id="api.tasks.process_attendance"><code class="name flex">
<span>def <span class="ident">process_attendance</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@frappe.whitelist()
def process_attendance():
        now_time = now_datetime().strftime(&#34;%y-%m-%d %H:%M:00&#34;)
        shift_types = frappe.get_all(&#34;Shift Type&#34;, {&#34;last_sync_of_checkin&#34;: now_time})
        for shift_type in shift_types:
                frappe.enqueue(mark_auto_attendance, shift_type, worker=&#39;long&#39;)</code></pre>
</details>
</dd>
<dt id="api.tasks.process_overtime_shift"><code class="name flex">
<span>def <span class="ident">process_overtime_shift</span></span>(<span>roster, date, time)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def process_overtime_shift(roster, date, time):
        for schedule in roster:
                #Check for employee&#39;s shift assignment of the day, if he has any.
                try:
                        shift_assignment = frappe.get_doc(&#34;Shift Assignment&#34;, {&#34;employee&#34;:schedule.employee, &#34;start_date&#34;: date},[&#34;name&#34;,&#34;shift_type&#34;])
                        if shift_assignment:
                                shift_end_time = frappe.get_value(&#34;Shift Type&#34;,shift_assignment.shift_type, &#34;end_time&#34;)
                                #check if the given shift has ended
                                # Set status inactive before creating new shift
                                if str(shift_end_time) == str(time):
                                        frappe.set_value(&#34;Shift Assignment&#34;, shift_assignment.name,&#39;status&#39;, &#34;Inactive&#34;)
                                        create_overtime_shift_assignment(schedule, date)
                        else:
                                create_overtime_shift_assignment(schedule, date)
                except Exception as e:
                        pass</code></pre>
</details>
</dd>
<dt id="api.tasks.run_checkin_reminder"><code class="name flex">
<span>def <span class="ident">run_checkin_reminder</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def run_checkin_reminder():
        # execute first checkin reminder

        try:
                res = fetch_employees_not_in_checkin()
                if res:
                        initiate_checkin_notification(res)
        except Exception as e:
                frappe.log_error(frappe.get_traceback(), &#39;Checkin Notification&#39;)</code></pre>
</details>
</dd>
<dt id="api.tasks.schedule_final_notification"><code class="name flex">
<span>def <span class="ident">schedule_final_notification</span></span>(<span>shifts_list, now_time)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def schedule_final_notification(shifts_list, now_time):
        notification_title = _(&#34;Final Reminder&#34;)
        notification_subject_in =  _(&#34;Please checkin within the next 3 hours or you will be marked absent.&#34;)
        notification_subject_out =  _(&#34;Please checkout in the next five minutes.&#34;)


        for shift in shifts_list:
                date = getdate()
                if shift.start_time &lt; shift.end_time and nowtime() &lt; cstr(shift.start_time):
                        date = getdate() - timedelta(days=1)
                # shift_start is equal to now time - notification reminder in mins
                # Employee won&#39;t receive checkin notification when accepted Arrive Late shift permission is present
                if (strfdelta(shift.start_time, &#39;%H:%M:%S&#39;) == cstr((get_datetime(now_time) - timedelta(minutes=cint(shift.notification_reminder_after_shift_start))).time())) or (shift.has_split_shift == 1 and strfdelta(shift.second_shift_start_time, &#39;%H:%M:%S&#39;) == cstr((get_datetime(now_time) - timedelta(minutes=cint(shift.notification_reminder_after_shift_start))).time())):
                        recipients = checkin_checkout_query(date=cstr(date), shift_type=shift.name, log_type=&#34;IN&#34;)

                        if len(recipients) &gt; 0:
                                notify_checkin_checkout_final_reminder(recipients=recipients,log_type=&#34;IN&#34;, notification_title= notification_title, notification_subject=notification_subject_in, is_after_grace_checkin=1)

                # shift_end is equal to now time - notification reminder in mins
                # Employee won&#39;t receive checkout notification when accepted Leave Early shift permission is present
                if (strfdelta(shift.end_time, &#39;%H:%M:%S&#39;) == cstr((get_datetime(now_time)- timedelta(minutes=cint(shift.notification_reminder_after_shift_end))).time())) or (shift.has_split_shift == 1 and strfdelta(shift.first_shift_end_time, &#39;%H:%M:%S&#39;) == cstr((get_datetime(now_time) - timedelta(minutes=cint(shift.notification_reminder_after_shift_end))).time())):
                        recipients = checkin_checkout_query(date=cstr(date), shift_type=shift.name, log_type=&#34;OUT&#34;)

                        if len(recipients) &gt; 0:
                                notify_checkin_checkout_final_reminder(recipients=recipients, log_type=&#34;OUT&#34;, notification_title=notification_title, notification_subject=notification_subject_out)</code></pre>
</details>
</dd>
<dt id="api.tasks.schedule_initial_reminder"><code class="name flex">
<span>def <span class="ident">schedule_initial_reminder</span></span>(<span>shifts_list, now_time)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def schedule_initial_reminder(shifts_list, now_time):
        notification_title = _(&#34;Checkin/Checkout reminder&#34;)
        notification_subject_in = _(&#34;Don&#39;t forget to Checkin!&#34;)
        notification_subject_out = _(&#34;Don&#39;t forget to CheckOut!&#34;)

        for shift in shifts_list:
                date = getdate()
                if shift.start_time &lt; shift.end_time and nowtime() &lt; cstr(shift.start_time):
                        date = getdate() - timedelta(days=1)

                # Current time == shift start time =&gt; Checkin
                if strfdelta(shift.start_time, &#39;%H:%M:%S&#39;) == cstr((get_datetime(now_time)).time()):
                        recipients = checkin_checkout_query(date=cstr(date), shift_type=shift.name, log_type=&#34;IN&#34;)
                        if len(recipients) &gt; 0:
                                notify_checkin_checkout_final_reminder(recipients=recipients,log_type=&#34;IN&#34;, notification_title= notification_title, notification_subject=notification_subject_in)

                # current time == shift end time =&gt; Checkout
                if strfdelta(shift.end_time, &#39;%H:%M:%S&#39;) == cstr((get_datetime(now_time)).time()):
                        recipients = checkin_checkout_query(date=cstr(date), shift_type=shift.name, log_type=&#34;OUT&#34;)

                        if len(recipients) &gt; 0:
                                notify_checkin_checkout_final_reminder(recipients=recipients,log_type=&#34;OUT&#34;, notification_title= notification_title, notification_subject=notification_subject_out)</code></pre>
</details>
</dd>
<dt id="api.tasks.send_checkin_hourly_reminder"><code class="name flex">
<span>def <span class="ident">send_checkin_hourly_reminder</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@frappe.whitelist()
def send_checkin_hourly_reminder():
        now_time = now_datetime().strftime(&#34;%Y-%m-%d %H:%M&#34;)
        shifts_list = get_active_shifts(now_time)

        title = &#34;Hourly Reminder&#34;
        category = &#34;Attendance&#34;
        #Send notifications to employees assigned to a shift for hourly checkin
        for shift in shifts_list:
                if strfdelta(shift.start_time, &#39;%H:%M:%S&#39;) != cstr(get_datetime(now_time).time()) and strfdelta(shift.end_time, &#39;%H:%M:%S&#39;) != cstr(get_datetime(now_time).time()):
                        date = getdate() if shift.start_time &lt; shift.end_time else (getdate() - timedelta(days=1))
                        recipients = frappe.db.sql(&#34;&#34;&#34;
                                SELECT DISTINCT emp.user_id FROM `tabShift Assignment` tSA, `tabEmployee` emp
                                WHERE
                                        tSA.employee = emp.name
                                AND tSA.start_date=&#39;{date}&#39;
                                AND tSA.shift_type=&#39;{shift_type}&#39;
                                AND tSA.docstatus=1
                        &#34;&#34;&#34;.format(date=cstr(date), shift_type=shift.name), as_list=1)
                        recipients = [recipient[0] for recipient in recipients if recipient[0]]

                        subject = _(&#34;Hourly Reminder: Please checkin&#34;)
                        message = _(&#39;&lt;a class=&#34;btn btn-warning&#34; href=&#34;/app/face-recognition&#34;&gt;Hourly Check In&lt;/a&gt;&#39;)
                        send_notification(title, subject, message, category, recipients)</code></pre>
</details>
</dd>
<dt id="api.tasks.send_notification"><code class="name flex">
<span>def <span class="ident">send_notification</span></span>(<span>title, subject, message, category, recipients)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@frappe.whitelist()
def send_notification(title, subject, message, category, recipients):
        for user in recipients:
                notification = frappe.new_doc(&#34;Notification Log&#34;)
                notification.title = title
                notification.subject = subject
                notification.email_content = message
                notification.document_type = &#34;Notification Log&#34;
                notification.for_user = user
                notification.document_name = &#34; &#34;
                notification.category = category
                notification.one_fm_mobile_app = 1
                notification.save(ignore_permissions=True)
                notification.document_name = notification.name
                notification.save(ignore_permissions=True)
                frappe.db.commit()</code></pre>
</details>
</dd>
<dt id="api.tasks.strfdelta"><code class="name flex">
<span>def <span class="ident">strfdelta</span></span>(<span>tdelta, fmt)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def strfdelta(tdelta, fmt):
        d = {&#34;D&#34;: tdelta.days}
        hours, rem = divmod(tdelta.seconds, 3600)
        minutes, seconds = divmod(rem, 60)
        d[&#34;H&#34;] = &#39;{:02d}&#39;.format(hours)
        d[&#34;M&#34;] = &#39;{:02d}&#39;.format(minutes)
        d[&#34;S&#34;] = &#39;{:02d}&#39;.format(seconds)
        t = DeltaTemplate(fmt)
        return t.substitute(**d)</code></pre>
</details>
</dd>
<dt id="api.tasks.supervisor_reminder"><code class="name flex">
<span>def <span class="ident">supervisor_reminder</span></span>(<span>shift, today_datetime, now_time)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def supervisor_reminder(shift, today_datetime, now_time):
        title = &#34;Checkin Report&#34;
        category = &#34;Attendance&#34;
        date = getdate()
        if shift.start_time &lt; shift.end_time and nowtime() &lt; cstr(shift.start_time):
                date = getdate() - timedelta(days=1)

        if (strfdelta(shift.start_time, &#39;%H:%M:%S&#39;) == cstr((get_datetime(now_time) - timedelta(minutes=cint(shift.supervisor_reminder_shift_start))).time())) or (shift.has_split_shift == 1 and strfdelta(shift.second_shift_start_time, &#39;%H:%M:%S&#39;) == cstr((get_datetime(now_time) - timedelta(minutes=cint(shift.supervisor_reminder_shift_start))).time())):
                checkin_time = today_datetime + &#34; &#34; + strfdelta(shift.start_time, &#39;%H:%M:%S&#39;)
                recipients = checkin_checkout_query(date=cstr(date), shift_type=shift.name, log_type=&#34;IN&#34;)

                if len(recipients) &gt; 0:
                        for recipient in recipients:
                                action_user, Role = get_action_user(recipient.name,recipient.shift)
                                #for_user = get_employee_user_id(recipient.reports_to) if get_employee_user_id(recipient.reports_to) else get_notification_user(op_shift)
                                subject = _(&#34;{employee} has not checked in yet.&#34;.format(employee=recipient.employee_name))
                                action_message = _(&#34;&#34;&#34;
                                Submit a Shift Permission for the employee to give an excuse and not need to penalize
                                &lt;a class=&#34;btn btn-primary&#34; href=&#34;/app/shift-permission/new-shift-permission-1&#34;&gt;Submit Shift Permission&lt;/a&gt;&amp;nbsp;
                                &lt;br/&gt;&lt;br/&gt;
                                Issue penalty for the employee
                                &lt;a class=&#39;btn btn-primary btn-danger no-punch-in&#39; id=&#39;{employee}_{date}_{shift}&#39; href=&#34;/app/penalty-issuance/new-penalty-issuance-1&#34;&gt;Issue Penalty&lt;/a&gt;
                                &#34;&#34;&#34;).format(shift=recipient.shift, date=cstr(now_time), employee=recipient.name, time=checkin_time)
                                if action_user is not None:
                                        send_notification(title, subject, action_message, category, [action_user])

                                notify_message = _(&#34;&#34;&#34;Note that {employee} from Shift {shift} has Not Checked in yet.&#34;&#34;&#34;).format(employee=recipient.employee_name, shift=recipient.shift)
                                if Role:
                                        notify_user = get_notification_user(recipient.name,recipient.shift, Role)
                                        if notify_user is not None:
                                                send_notification(title, subject, notify_message, category, notify_user)

        &#34;&#34;&#34;
                Send notification to supervisor of those who haven&#39;t checked in and don&#39;t have accepted shift permission
                with permission type Leave Early/Forget to Checkout/Checkout Issue
        &#34;&#34;&#34;
        if (strfdelta(shift.end_time, &#39;%H:%M:%S&#39;) == cstr((get_datetime(now_time) - timedelta(minutes=cint(shift.supervisor_reminder_start_ends))).time())) or (shift.has_split_shift == 1 and strfdelta(shift.first_shift_end_time, &#39;%H:%M:%S&#39;) == cstr((get_datetime(now_time) - timedelta(minutes=cint(shift.supervisor_reminder_end_start))).time())):
                checkout_time = today_datetime + &#34; &#34; + strfdelta(shift.end_time, &#39;%H:%M:%S&#39;)

                recipients = recipients = checkin_checkout_query(date=cstr(date), shift_type=shift.name, log_type=&#34;OUT&#34;)

                if len(recipients) &gt; 0:
                        for recipient in recipients:
                                action_user, Role = get_action_user(recipient.name,recipient.shift)
                                #for_user = get_employee_user_id(recipient.reports_to) if get_employee_user_id(recipient.reports_to) else get_notification_user(op_shift)
                                subject = _(&#39;{employee} has not checked out yet.&#39;.format(employee=recipient.employee_name))
                                action_message = _(&#34;&#34;&#34;
                                        Submit a Shift Permission for the employee to give an excuse and not need to penalize
                                        &lt;a class=&#34;btn btn-primary&#34; href=&#34;/app/shift-permission/new-shift-permission-1&#34;&gt;Submit Shift Permission&lt;/a&gt;&amp;nbsp;
                                        &lt;br/&gt;&lt;br/&gt;
                                        Issue penalty for the employee
                                        &lt;a class=&#39;btn btn-primary btn-danger no-punch-in&#39; id=&#39;{employee}_{date}_{shift}&#39; href=&#34;/app/penalty-issuance/new-penalty-issuance-1&#34;&gt;Issue Penalty&lt;/a&gt;
                                        &#34;&#34;&#34;).format(shift=recipient.shift, date=cstr(now_time), employee=recipient.name, time=checkout_time)
                                if action_user is not None:
                                                send_notification(title, subject, action_message, category, [action_user])

                                notify_message = _(&#34;&#34;&#34;Note that {employee} from Shift {shift} has Not Checked Out yet.&#34;&#34;&#34;).format(employee=recipient.employee_name, shift=recipient.shift)
                                if Role:
                                                notify_user = get_notification_user(recipient.name,recipient.shift, Role)
                                                if notify_user is not None:
                                                        send_notification(title, subject, notify_message, category, notify_user)</code></pre>
</details>
</dd>
<dt id="api.tasks.update_shift_type"><code class="name flex">
<span>def <span class="ident">update_shift_type</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def update_shift_type():
        today_datetime = now_datetime()
        minute = today_datetime.strftime(&#34;%M&#34;)
        if 0 &lt;= int(minute)-15 &lt; 15:
                now_time = today_datetime.strftime(&#34;%H:15:00&#34;)
        elif 0 &lt;= int(minute)-30 &lt; 15:
                now_time = today_datetime.strftime(&#34;%H:30:00&#34;)
        elif 0 &lt;= int(minute)-45 &lt; 15:
                now_time = today_datetime.strftime(&#34;%H:45:00&#34;)
        else:
                now_time = today_datetime.strftime(&#34;%H:00:00&#34;)
        shift_types = frappe.get_all(&#34;Shift Type&#34;, {&#34;end_time&#34;: now_time},[&#34;name&#34;, &#34;allow_check_out_after_shift_end_time&#34;])
        for shift_type in shift_types:
                last_sync_of_checkin = add_to_date(today_datetime, minutes=cint(shift_type.allow_check_out_after_shift_end_time)+15, as_datetime=True)
                doc = frappe.get_doc(&#34;Shift Type&#34;, shift_type.name)
                doc.last_sync_of_checkin = last_sync_of_checkin
                doc.save()
                frappe.db.commit()</code></pre>
</details>
</dd>
<dt id="api.tasks.validate_am_shift_assignment"><code class="name flex">
<span>def <span class="ident">validate_am_shift_assignment</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def validate_am_shift_assignment():
        date = cstr(getdate())
        end_previous_shifts(&#34;PM&#34;)
        roster = frappe.db.sql(&#34;&#34;&#34;
                        SELECT * from `tabEmployee Schedule` ES
                        WHERE
                        ES.date = &#39;{date}&#39;
                        AND ES.employee_availability = &#34;Working&#34;
                        AND ES.roster_type = &#34;Basic&#34;
                        AND ES.shift_type IN(
                                SELECT name from `tabShift Type` st
                                WHERE st.start_time &gt;= &#39;01:00:00&#39;
                                AND  st.start_time &lt; &#39;13:00:00&#39;)
                        AND ES.employee
                        NOT IN (Select employee from `tabShift Assignment` tSA
                        WHERE
                                tSA.employee = ES.employee
                                AND tSA.start_date=&#39;{date}&#39;
                                AND tSA.roster_type = &#34;Basic&#34;
                                AND tSA.shift_type IN(
                                        SELECT name from `tabShift Type` st
                                        WHERE st.start_time &gt;= &#39;01:00:00&#39;
                                        AND  st.start_time &lt; &#39;13:00:00&#39; ))
                        AND ES.employee
                        NOT IN (Select employee from `tabEmployee` E
                        WHERE
                                E.name = ES.employee
                                AND E.status = &#34;Left&#34;)
        &#34;&#34;&#34;.format(date=cstr(date)), as_dict=1)

        non_shift = fetch_non_shift(date, &#34;PM&#34;)
        if non_shift:
                roster.extend(non_shift)

        # remove approved leaves for today
        todays_leaves = get_today_leaves(str(date))
        roster = [i for i in roster if not i.employee in todays_leaves]

        if len(roster)&gt;0:
                sender = frappe.get_value(&#34;Email Account&#34;, filters = {&#34;default_outgoing&#34;: 1}, fieldname = &#34;email_id&#34;) or None
                recipient = frappe.get_value(&#34;Email Account&#34;, {&#34;name&#34;:&#34;Support&#34;}, [&#34;email_id&#34;])
                msg = frappe.render_template(&#39;one_fm/templates/emails/missing_shift_assignment.html&#39;, context={&#34;rosters&#34;: roster})
                sendemail(sender=sender, recipients= recipient, content=msg, subject=&#34;Missed Shift Assignments List&#34;, delay=False)
                frappe.enqueue(create_shift_assignment, roster = roster, date = date, time=&#39;AM&#39;, is_async=True, queue=&#39;long&#39;)</code></pre>
</details>
</dd>
<dt id="api.tasks.validate_pm_shift_assignment"><code class="name flex">
<span>def <span class="ident">validate_pm_shift_assignment</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def validate_pm_shift_assignment():
        date = cstr(getdate())
        end_previous_shifts(&#34;PM&#34;)
        roster = frappe.db.sql(&#34;&#34;&#34;
                        SELECT * from `tabEmployee Schedule` ES
                        WHERE
                        ES.date = &#39;{date}&#39;
                        AND ES.employee_availability = &#34;Working&#34;
                        AND ES.roster_type = &#34;Basic&#34;
                        AND ES.shift_type IN(
                                SELECT name from `tabShift Type` st
                                WHERE st.start_time &lt; &#39;01:00:00&#39; OR st.start_time &gt;= &#39;13:00:00&#39;
                                )
                        AND ES.employee
                        NOT IN (Select employee from `tabShift Assignment` tSA
                        WHERE
                                tSA.employee = ES.employee
                                AND tSA.start_date=&#39;{date}&#39;
                                AND tSA.roster_type = &#34;Basic&#34;
                                AND tSA.shift_type IN(
                                        SELECT name from `tabShift Type` st
                                        WHERE st.start_time &lt; &#39;01:00:00&#39; OR st.start_time &gt;= &#39;13:00:00&#39;))
                        AND ES.employee
                        NOT IN (Select employee from `tabEmployee` E
                        WHERE
                                E.name = ES.employee
                                AND E.status = &#34;Left&#34;)
        &#34;&#34;&#34;.format(date=cstr(date)), as_dict=1)
        non_shift = fetch_non_shift(date, &#34;PM&#34;)
        if non_shift:
                roster.extend(non_shift)

        # remove approved leaves for today
        todays_leaves = get_today_leaves(str(date))
        roster = [i for i in roster if not i.employee in todays_leaves]

        if len(roster)&gt;0:
                sender = frappe.get_value(&#34;Email Account&#34;, filters = {&#34;default_outgoing&#34;: 1}, fieldname = &#34;email_id&#34;) or None
                recipient = frappe.get_value(&#34;Email Account&#34;, {&#34;name&#34;:&#34;Support&#34;}, [&#34;email_id&#34;])
                msg = frappe.render_template(&#39;one_fm/templates/emails/missing_shift_assignment.html&#39;, context={&#34;rosters&#34;: roster})
                sendemail(sender=sender, recipients= recipient, content=msg, subject=&#34;Missed Shift Assignments List&#34;, delay=False)
                frappe.enqueue(create_shift_assignment, roster = roster, date = date, time=&#39;PM&#39;, is_async=True, queue=&#39;long&#39;)</code></pre>
</details>
</dd>
</dl>
</section>
<section>
<h2 class="section-title" id="header-classes">Classes</h2>
<dl>
<dt id="api.tasks.DeltaTemplate"><code class="flex name class">
<span>class <span class="ident">DeltaTemplate</span></span>
<span>(</span><span>template)</span>
</code></dt>
<dd>
<div class="desc"><p>A string class for supporting $-substitutions.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class DeltaTemplate(Template):
        delimiter = &#34;%&#34;</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li>string.Template</li>
</ul>
<h3>Class variables</h3>
<dl>
<dt id="api.tasks.DeltaTemplate.delimiter"><code class="name">var <span class="ident">delimiter</span></code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="api.tasks.DeltaTemplate.pattern"><code class="name">var <span class="ident">pattern</span></code></dt>
<dd>
<div class="desc"></div>
</dd>
</dl>
</dd>
</dl>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="api" href="index.html">api</a></code></li>
</ul>
</li>
<li><h3><a href="#header-functions">Functions</a></h3>
<ul class="">
<li><code><a title="api.tasks.assign_am_shift" href="#api.tasks.assign_am_shift">assign_am_shift</a></code></li>
<li><code><a title="api.tasks.assign_pm_shift" href="#api.tasks.assign_pm_shift">assign_pm_shift</a></code></li>
<li><code><a title="api.tasks.automatic_checkout" href="#api.tasks.automatic_checkout">automatic_checkout</a></code></li>
<li><code><a title="api.tasks.calculate_penalty_amount" href="#api.tasks.calculate_penalty_amount">calculate_penalty_amount</a></code></li>
<li><code><a title="api.tasks.checkin_checkout_final_reminder" href="#api.tasks.checkin_checkout_final_reminder">checkin_checkout_final_reminder</a></code></li>
<li><code><a title="api.tasks.checkin_checkout_initial_reminder" href="#api.tasks.checkin_checkout_initial_reminder">checkin_checkout_initial_reminder</a></code></li>
<li><code><a title="api.tasks.checkin_checkout_query" href="#api.tasks.checkin_checkout_query">checkin_checkout_query</a></code></li>
<li><code><a title="api.tasks.checkin_checkout_supervisor_reminder" href="#api.tasks.checkin_checkout_supervisor_reminder">checkin_checkout_supervisor_reminder</a></code></li>
<li><code><a title="api.tasks.checkin_deadline" href="#api.tasks.checkin_deadline">checkin_deadline</a></code></li>
<li><code><a title="api.tasks.create_additional_salary" href="#api.tasks.create_additional_salary">create_additional_salary</a></code></li>
<li><code><a title="api.tasks.create_overtime_shift_assignment" href="#api.tasks.create_overtime_shift_assignment">create_overtime_shift_assignment</a></code></li>
<li><code><a title="api.tasks.create_penalty_deduction" href="#api.tasks.create_penalty_deduction">create_penalty_deduction</a></code></li>
<li><code><a title="api.tasks.create_shift_assignment" href="#api.tasks.create_shift_assignment">create_shift_assignment</a></code></li>
<li><code><a title="api.tasks.end_previous_shifts" href="#api.tasks.end_previous_shifts">end_previous_shifts</a></code></li>
<li><code><a title="api.tasks.fetch_employees_not_in_checkin" href="#api.tasks.fetch_employees_not_in_checkin">fetch_employees_not_in_checkin</a></code></li>
<li><code><a title="api.tasks.fetch_non_shift" href="#api.tasks.fetch_non_shift">fetch_non_shift</a></code></li>
<li><code><a title="api.tasks.generate_payroll" href="#api.tasks.generate_payroll">generate_payroll</a></code></li>
<li><code><a title="api.tasks.generate_penalties" href="#api.tasks.generate_penalties">generate_penalties</a></code></li>
<li><code><a title="api.tasks.generate_site_allowance" href="#api.tasks.generate_site_allowance">generate_site_allowance</a></code></li>
<li><code><a title="api.tasks.get_action_user" href="#api.tasks.get_action_user">get_action_user</a></code></li>
<li><code><a title="api.tasks.get_active_shifts" href="#api.tasks.get_active_shifts">get_active_shifts</a></code></li>
<li><code><a title="api.tasks.get_current_schedules" href="#api.tasks.get_current_schedules">get_current_schedules</a></code></li>
<li><code><a title="api.tasks.get_location" href="#api.tasks.get_location">get_location</a></code></li>
<li><code><a title="api.tasks.get_notification_user" href="#api.tasks.get_notification_user">get_notification_user</a></code></li>
<li><code><a title="api.tasks.get_shift_type" href="#api.tasks.get_shift_type">get_shift_type</a></code></li>
<li><code><a title="api.tasks.has_checkin_record" href="#api.tasks.has_checkin_record">has_checkin_record</a></code></li>
<li><code><a title="api.tasks.initiate_checkin_notification" href="#api.tasks.initiate_checkin_notification">initiate_checkin_notification</a></code></li>
<li><code><a title="api.tasks.issue_penalties" href="#api.tasks.issue_penalties">issue_penalties</a></code></li>
<li><code><a title="api.tasks.issue_penalty" href="#api.tasks.issue_penalty">issue_penalty</a></code></li>
<li><code><a title="api.tasks.mark_auto_attendance" href="#api.tasks.mark_auto_attendance">mark_auto_attendance</a></code></li>
<li><code><a title="api.tasks.mark_daily_attendance" href="#api.tasks.mark_daily_attendance">mark_daily_attendance</a></code></li>
<li><code><a title="api.tasks.mark_day_attendance" href="#api.tasks.mark_day_attendance">mark_day_attendance</a></code></li>
<li><code><a title="api.tasks.mark_deadline_attendance" href="#api.tasks.mark_deadline_attendance">mark_deadline_attendance</a></code></li>
<li><code><a title="api.tasks.mark_night_attendance" href="#api.tasks.mark_night_attendance">mark_night_attendance</a></code></li>
<li><code><a title="api.tasks.notify_checkin_checkout_final_reminder" href="#api.tasks.notify_checkin_checkout_final_reminder">notify_checkin_checkout_final_reminder</a></code></li>
<li><code><a title="api.tasks.overtime_shift_assignment" href="#api.tasks.overtime_shift_assignment">overtime_shift_assignment</a></code></li>
<li><code><a title="api.tasks.process_attendance" href="#api.tasks.process_attendance">process_attendance</a></code></li>
<li><code><a title="api.tasks.process_overtime_shift" href="#api.tasks.process_overtime_shift">process_overtime_shift</a></code></li>
<li><code><a title="api.tasks.run_checkin_reminder" href="#api.tasks.run_checkin_reminder">run_checkin_reminder</a></code></li>
<li><code><a title="api.tasks.schedule_final_notification" href="#api.tasks.schedule_final_notification">schedule_final_notification</a></code></li>
<li><code><a title="api.tasks.schedule_initial_reminder" href="#api.tasks.schedule_initial_reminder">schedule_initial_reminder</a></code></li>
<li><code><a title="api.tasks.send_checkin_hourly_reminder" href="#api.tasks.send_checkin_hourly_reminder">send_checkin_hourly_reminder</a></code></li>
<li><code><a title="api.tasks.send_notification" href="#api.tasks.send_notification">send_notification</a></code></li>
<li><code><a title="api.tasks.strfdelta" href="#api.tasks.strfdelta">strfdelta</a></code></li>
<li><code><a title="api.tasks.supervisor_reminder" href="#api.tasks.supervisor_reminder">supervisor_reminder</a></code></li>
<li><code><a title="api.tasks.update_shift_type" href="#api.tasks.update_shift_type">update_shift_type</a></code></li>
<li><code><a title="api.tasks.validate_am_shift_assignment" href="#api.tasks.validate_am_shift_assignment">validate_am_shift_assignment</a></code></li>
<li><code><a title="api.tasks.validate_pm_shift_assignment" href="#api.tasks.validate_pm_shift_assignment">validate_pm_shift_assignment</a></code></li>
</ul>
</li>
<li><h3><a href="#header-classes">Classes</a></h3>
<ul>
<li>
<h4><code><a title="api.tasks.DeltaTemplate" href="#api.tasks.DeltaTemplate">DeltaTemplate</a></code></h4>
<ul class="">
<li><code><a title="api.tasks.DeltaTemplate.delimiter" href="#api.tasks.DeltaTemplate.delimiter">delimiter</a></code></li>
<li><code><a title="api.tasks.DeltaTemplate.pattern" href="#api.tasks.DeltaTemplate.pattern">pattern</a></code></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc" title="pdoc: Python API documentation generator"><cite>pdoc</cite> 0.10.0</a>.</p>
</footer>
</body>
</html>