<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.10.0" />
<title>api.v2.legal API documentation</title>
<meta name="description" content="" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>api.v2.legal</code></h1>
</header>
<section id="section-intro">
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">import frappe, base64, json, grpc
from frappe.utils import cint
from one_fm.legal.doctype.penalty_issuance.penalty_issuance import get_filtered_employees
from one_fm.legal.doctype.penalty.penalty import send_email_to_legal
from frappe import _
from one_fm.proto import facial_recognition_pb2_grpc, facial_recognition_pb2
from one_fm.api.v1.utils import response
from one_fm.utils import check_path, create_path

@frappe.whitelist()
def get_employee_list(shift: str = None, penalty_occurence_time: str = None) -&gt; dict:

    if not shift:
        return response(&#34;Bad Request&#34;, 400, None, &#34;shift required.&#34;)

    if not penalty_occurence_time:
        return response(&#34;Bad Request&#34;, 400, None, &#34;penalty_ocurrence_time required.&#34;)

    if not isinstance(shift, str):
        return response(&#34;Bad Request&#34;, 400, None, &#34;shift must be of type str.&#34;)

    if not isinstance(penalty_occurence_time, str):
        return response(&#34;Bad Request&#34;, 400, None, &#34;penalty_ocurrence_time must be of type str.&#34;)

    try:
        result = get_filtered_employees(shift, penalty_occurence_time, as_dict=1)
        return response(&#34;Success&#34;, 200, result)
    except Exception as error:
        return response(&#34;Internal Server Error&#34;, 500, None, error)


@frappe.whitelist()
def get_penalty_types():
    &#34;&#34;&#34; This method gets the list of penalty types. &#34;&#34;&#34;
    try:
        result = frappe.db.sql(&#34;&#34;&#34;SELECT name, penalty_name_arabic FROM `tabPenalty Type` &#34;&#34;&#34;, as_dict=1)
        return response(&#34;Success&#34;, 200, result)
    except Exception as error:
        return response(&#34;Internal Server Error&#34;, 500, None, error)


@frappe.whitelist()
def get_all_shifts():
    try:
        result = frappe.db.sql(&#34;&#34;&#34;SELECT osh.name, osh.site, osh.project, ost.site_location 
                        FROM `tabOperations Shift` osh, `tabOperations Site` ost  
                        WHERE osh.site=ost.name
                        ORDER BY name ASC &#34;&#34;&#34;, as_dict=1)

        return response(&#34;Success&#34;, 200, result)
    except Exception as error:
        return response(&#34;Internal Server Error&#34;, 500, None, error)


@frappe.whitelist()
def issue_penalty(penalty_category, issuing_time, issuing_location, penalty_location, penalty_occurence_time,company_damage, customer_property_damage, asset_damage, other_damages, shift=None, site=None, project=None, site_location=None, penalty_employees=[], penalty_details=[]):
        try:
                employee, employee_name, designation = frappe.get_value(&#34;Employee&#34;, {&#34;user_id&#34;: frappe.session.user}, [&#34;name&#34;,&#34;employee_name&#34;, &#34;designation&#34;])

                penalty_issuance = frappe.new_doc(&#34;Penalty Issuance&#34;)
                penalty_issuance.penalty_category = penalty_category
                
                penalty_issuance.issuing_time = issuing_time
                penalty_issuance.location = issuing_location
                penalty_issuance.penalty_location = penalty_location
                penalty_issuance.penalty_occurence_time = penalty_occurence_time

                penalty_issuance.issuing_employee = employee
                penalty_issuance.employee_name = employee_name
                penalty_issuance.designation = designation
                
                penalty_issuance.customer_property_damage = cint(customer_property_damage)
                penalty_issuance.company_damage = cint(company_damage)
                penalty_issuance.other_damages = cint(other_damages)
                penalty_issuance.asset_damage = cint(asset_damage)
                employees = json.loads(penalty_employees)
                for employee in employees:
                        penalty_issuance.append(&#39;employees&#39;, {&#39;employee_id&#39;:employee})

                penalty_issuance_details = json.loads(penalty_details)
                # check and make path for attachments
                path_name = frappe.utils.cstr(frappe.local.site)+&#34;/public/files/Legal&#34;
                if not check_path(path_name):
                        create_path(path_name)

                for detail in penalty_issuance_details:
                        if detail.get(&#34;attachments&#34;) and detail.get(&#34;attachment_name&#34;):
                                filename = detail[&#34;attachment_name&#34;]
                                attach = detail[&#34;attachments&#34;]
                                content = base64.b64decode(attach)

                                OUTPUT_IMAGE_PATH = path_name+&#34;/&#34;+filename
                                fh = open(OUTPUT_IMAGE_PATH, &#34;wb&#34;)
                                fh.write(content)
                                fh.close()
                                Attachment_file=&#34;/files/Legal/&#34;+filename
                                detail.update({&#39;attachments&#39;: Attachment_file})

                        detail.pop(&#34;attachment_name&#34;)
                        penalty_issuance.append(&#39;penalty_issuance_details&#39;, detail)

                if penalty_category == &#34;Performace&#34;:
                        penalty_issuance.shift = shift
                        penalty_issuance.site = site
                        penalty_issuance.project = project
                        penalty_issuance.site_location = site_location


                penalty_issuance.insert()
                penalty_issuance.submit()
                return response(&#34;Success&#34;, 201, penalty_issuance)

        except Exception as error:
                frappe.log_error(error, &#39;Penalty Issance Error&#39;)
                return response(&#34;Internal Server Error&#34;, 500, None, error)@frappe.whitelist()


@frappe.whitelist()
def get_penalties(employee_id: str = None, role: str = None) -&gt; dict:

        if not employee_id:
                return response(&#34;Bad Request&#34;, 400, None, &#34;employee_id required.&#34;)

        if not isinstance(employee_id, str):
                return response(&#34;Bad Request&#34;, 400, None, &#34;employee_id must be of type str.&#34;)

        if role:
                if not isinstance(role, str):
                        return response(&#34;Bad Request&#34;, 400, None ,&#34;role must be of type str.&#34;)
        try:
                employee = frappe.db.get_value(&#34;Employee&#34;, {&#34;employee_id&#34;: employee_id})

                if not employee:
                        return response(&#34;Resource not found&#34;, 404, None, &#34;No employee found with {employee_id}&#34;.format(employee_id=employee_id))

                if role and role == &#34;Issuance&#34;:
                        result = frappe.get_list(&#34;Penalty&#34;, filters={&#34;issuer_employee&#34;: employee}, fields=[&#34;name&#34;, &#34;penalty_issuance_time&#34;, &#34;workflow_state&#34;], order_by=&#34;modified desc&#34;)
                        if len(result) &gt; 0:
                                return response(&#34;Success&#34;, 200, result)
                        else:
                                return response(&#34;Resource not found&#34;, 404, None, &#34;No penalties found for {employee} with role as {role}&#34;.format(employee=employee, role=role))
                else:
                        result = frappe.get_list(&#34;Penalty&#34;, filters={&#34;recipient_employee&#34;: employee}, fields=[&#34;name&#34;, &#34;penalty_issuance_time&#34;, &#34;workflow_state&#34;], order_by=&#34;modified desc&#34;)
                        if len(result) &gt; 0:
                                return response(&#34;Success&#34;, 200, result)
                        else:
                                return response(&#34;Resource not found&#34;, 404, None, &#34;No penalties found for {employee}&#34;.format(employee=employee))
        
        except Exception as error:
                return response(&#34;Internal Server Error&#34;, 500, None, error)

@frappe.whitelist()
def get_penalty_details(penalty_name: str = None) -&gt; dict:
        &#34;&#34;&#34;This method gets the details of a specific penalty provided the name of the penalty document.

        Args:
                penalty_name (str): Name of the penalty document.

        Returns:
                dict: {
            message (str): Brief message indicating the response,
                        status_code (int): Status code of response.
            data (dict): Penalty deatils.
            error (str): Any error handled.
                }
        &#34;&#34;&#34;
        if not penalty_name:
                return response(&#34;Bad Request&#34;, 400, None, &#34;penalty_name required.&#34;)

        if not isinstance(penalty_name, str):
                return response(&#34;Bad Request&#34;, 400, None, &#34;penalty_name must be of type str.&#34;)

        try:
                penalty_doc = frappe.get_doc(&#34;Penalty&#34;, {&#34;name&#34;: penalty_name})
                if not penalty_doc:
                        return response(&#34;Resource not found&#34;, 404, None, &#34;No penalty of name {penalty_doc} found.&#34;.format(penalty_doc=penalty_doc))

                return response(&#34;Success&#34;, 200, penalty_doc.as_dict())
        
        except Exception as error:
                return response(&#34;Internal Server Error&#34;, 500, None, error)

@frappe.whitelist()
def accept_penalty(employee_id: str = None, file: str = None, docname: str = None) -&gt; dict:
        &#34;&#34;&#34;     This is an API to accept penalty. To Accept Penalty, one needs to pass the face recognition test.
                Image file in base64 format is passed through face regonition test. And, employee is given 3 tries.
                If face recognition is true, the penalty gets accepted. 
                If Face recognition fails even after 3 tries, the image is sent to legal mangager for investigation. 

        Args:
                file (str): Base64 url of captured image.
                docname (str): Name of the penalty doctype

        Returns: 
                dict: {
                        message (str): Brief message indicating the response,
                        status_code (int): Status code of response.
            data (dict): penalty accepted document as dictionary,
            error (str): Any error handled.
                }
        &#34;&#34;&#34;
        if not file:
                return response(&#34;Bad Request&#34;, 400, None, &#34;base64 encoded file required.&#34;)

        if not docname:
                return response(&#34;Bad Request&#34;, 400, None, &#34;docname required.&#34;)

        if not isinstance(file, str):
                return response(&#34;Bad Request&#34;, 400, None, &#34;file must be base64 encoded type str.&#34;)

        if not isinstance(docname, str):
                return response(&#34;Bad Request&#34;, 400, None, &#34;docname must be of type str.&#34;)
        
        try:
                penalty_doc = frappe.get_doc(&#34;Penalty&#34;, docname)

                if not penalty_doc:
                        return response(&#34;Resource not found&#34;, 404, None, &#34;No penalty of name {penalty_doc} found.&#34;.format(penalty_doc=penalty_doc))

                penalty_doc.retries = cint(penalty_doc.retries) - 1
                # setup channel
                face_recognition_service_url = frappe.local.conf.face_recognition_service_url
                channel = grpc.secure_channel(face_recognition_service_url, grpc.ssl_channel_credentials())
                # setup stub
                stub = facial_recognition_pb2_grpc.FaceRecognitionServiceStub(channel)

                # request body
                req = facial_recognition_pb2.FaceRecognitionRequest(
                        username = frappe.session.user,
                        media_type = &#34;image&#34;,
                        media_content = file,
                )
                # Call service stub and get response
                res = stub.FaceRecognition(req)
                if res.verification == &#34;OK&#34;:
                        if cint(penalty_doc.retries) == 0:
                                penalty_doc.verified = 0
                                send_email_to_legal(penalty_doc)
                        else:
                                penalty_doc.verified = 1                
                                penalty_doc.workflow_state = &#34;Penalty Accepted&#34;
                        penalty_doc.save(ignore_permissions=True)
                        # upload image if available
                        frappe.db.commit()
                        return response(&#34;Success&#34;, 201, penalty_doc.as_dict())
                
                else:
                        return response(&#34;Unauthorized&#34;, 401, None, &#34;Face not recognized. Please try again.&#34;)

        except Exception as error:
                return response(&#34;Internal Server Error&#34;, 500, None, error)

@frappe.whitelist()
def reject_penalty(rejection_reason: str = None, docname: str = None):
        &#34;&#34;&#34; This method rejects a penalty given a reason and penalty document name.
        Args:
                rejection_reason (str): Basis and/or reasoning due to which the employee is rejecting the issuance of penalty.
                docname (str): Name of the penalty doctype.

        Returns: 
                dict: {
                        message (str): Brief message indicating the response,
                        status_code (int): Status code of response.
                        data (dict): penalty rejected document as dictionary,
                        error (str): Any error handled.
                }
        &#34;&#34;&#34;

        if not rejection_reason:
                return response(&#34;Bad Request&#34;, 400, None, &#34;rejection_reason required.&#34;)

        if not docname:
                return response(&#34;Bad Request&#34;, 400, None, &#34;docname required.&#34;)

        if not isinstance(rejection_reason, str):
                return response(&#34;Bad Request&#34;, 400, None, &#34;rejection_reason must be of type str.&#34;)

        if not isinstance(docname, str):
                return response(&#34;Bad Request&#34;, 400, None, &#34;docname must be of type str.&#34;)

        try:
                penalty_doc = frappe.get_doc(&#34;Penalty&#34;, docname)

                if not penalty_doc:
                        return response(&#34;Resource not found&#34;, 404, None, &#34;No penalty of name {penalty_doc} found.&#34;.format(penalty_doc=penalty_doc))

                if penalty_doc.workflow_state == &#39;Penalty Issued&#39;:
                        penalty_doc.reason_for_rejection = rejection_reason
                        penalty_doc.workflow_state = &#34;Penalty Rejected&#34;
                        penalty_doc.save(ignore_permissions=True)
                        frappe.db.commit()
                        
                        return response(&#34;Success&#34;, 201, penalty_doc.as_dict())
                else:
                        return response(&#34;Bad Request&#34;, 400, None, &#34;Penalty has not yet reached workflow state of &#39;Penalty Issued&#39;.&#34;)
        
        except Exception as error:
                return response(&#34;Internal Server Error&#34;, 500, None, error)</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="api.v2.legal.accept_penalty"><code class="name flex">
<span>def <span class="ident">accept_penalty</span></span>(<span>employee_id: str = None, file: str = None, docname: str = None) ‑> dict</span>
</code></dt>
<dd>
<div class="desc"><p>This is an API to accept penalty. To Accept Penalty, one needs to pass the face recognition test.
Image file in base64 format is passed through face regonition test. And, employee is given 3 tries.
If face recognition is true, the penalty gets accepted.
If Face recognition fails even after 3 tries, the image is sent to legal mangager for investigation. </p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>file</code></strong> :&ensp;<code>str</code></dt>
<dd>Base64 url of captured image.</dd>
<dt><strong><code>docname</code></strong> :&ensp;<code>str</code></dt>
<dd>Name of the penalty doctype</dd>
</dl>
<p>Returns:
dict: {
message (str): Brief message indicating the response,
status_code (int): Status code of response.
data (dict): penalty accepted document as dictionary,
error (str): Any error handled.
}</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@frappe.whitelist()
def accept_penalty(employee_id: str = None, file: str = None, docname: str = None) -&gt; dict:
        &#34;&#34;&#34;     This is an API to accept penalty. To Accept Penalty, one needs to pass the face recognition test.
                Image file in base64 format is passed through face regonition test. And, employee is given 3 tries.
                If face recognition is true, the penalty gets accepted. 
                If Face recognition fails even after 3 tries, the image is sent to legal mangager for investigation. 

        Args:
                file (str): Base64 url of captured image.
                docname (str): Name of the penalty doctype

        Returns: 
                dict: {
                        message (str): Brief message indicating the response,
                        status_code (int): Status code of response.
            data (dict): penalty accepted document as dictionary,
            error (str): Any error handled.
                }
        &#34;&#34;&#34;
        if not file:
                return response(&#34;Bad Request&#34;, 400, None, &#34;base64 encoded file required.&#34;)

        if not docname:
                return response(&#34;Bad Request&#34;, 400, None, &#34;docname required.&#34;)

        if not isinstance(file, str):
                return response(&#34;Bad Request&#34;, 400, None, &#34;file must be base64 encoded type str.&#34;)

        if not isinstance(docname, str):
                return response(&#34;Bad Request&#34;, 400, None, &#34;docname must be of type str.&#34;)
        
        try:
                penalty_doc = frappe.get_doc(&#34;Penalty&#34;, docname)

                if not penalty_doc:
                        return response(&#34;Resource not found&#34;, 404, None, &#34;No penalty of name {penalty_doc} found.&#34;.format(penalty_doc=penalty_doc))

                penalty_doc.retries = cint(penalty_doc.retries) - 1
                # setup channel
                face_recognition_service_url = frappe.local.conf.face_recognition_service_url
                channel = grpc.secure_channel(face_recognition_service_url, grpc.ssl_channel_credentials())
                # setup stub
                stub = facial_recognition_pb2_grpc.FaceRecognitionServiceStub(channel)

                # request body
                req = facial_recognition_pb2.FaceRecognitionRequest(
                        username = frappe.session.user,
                        media_type = &#34;image&#34;,
                        media_content = file,
                )
                # Call service stub and get response
                res = stub.FaceRecognition(req)
                if res.verification == &#34;OK&#34;:
                        if cint(penalty_doc.retries) == 0:
                                penalty_doc.verified = 0
                                send_email_to_legal(penalty_doc)
                        else:
                                penalty_doc.verified = 1                
                                penalty_doc.workflow_state = &#34;Penalty Accepted&#34;
                        penalty_doc.save(ignore_permissions=True)
                        # upload image if available
                        frappe.db.commit()
                        return response(&#34;Success&#34;, 201, penalty_doc.as_dict())
                
                else:
                        return response(&#34;Unauthorized&#34;, 401, None, &#34;Face not recognized. Please try again.&#34;)

        except Exception as error:
                return response(&#34;Internal Server Error&#34;, 500, None, error)</code></pre>
</details>
</dd>
<dt id="api.v2.legal.get_all_shifts"><code class="name flex">
<span>def <span class="ident">get_all_shifts</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@frappe.whitelist()
def get_all_shifts():
    try:
        result = frappe.db.sql(&#34;&#34;&#34;SELECT osh.name, osh.site, osh.project, ost.site_location 
                        FROM `tabOperations Shift` osh, `tabOperations Site` ost  
                        WHERE osh.site=ost.name
                        ORDER BY name ASC &#34;&#34;&#34;, as_dict=1)

        return response(&#34;Success&#34;, 200, result)
    except Exception as error:
        return response(&#34;Internal Server Error&#34;, 500, None, error)</code></pre>
</details>
</dd>
<dt id="api.v2.legal.get_employee_list"><code class="name flex">
<span>def <span class="ident">get_employee_list</span></span>(<span>shift: str = None, penalty_occurence_time: str = None) ‑> dict</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@frappe.whitelist()
def get_employee_list(shift: str = None, penalty_occurence_time: str = None) -&gt; dict:

    if not shift:
        return response(&#34;Bad Request&#34;, 400, None, &#34;shift required.&#34;)

    if not penalty_occurence_time:
        return response(&#34;Bad Request&#34;, 400, None, &#34;penalty_ocurrence_time required.&#34;)

    if not isinstance(shift, str):
        return response(&#34;Bad Request&#34;, 400, None, &#34;shift must be of type str.&#34;)

    if not isinstance(penalty_occurence_time, str):
        return response(&#34;Bad Request&#34;, 400, None, &#34;penalty_ocurrence_time must be of type str.&#34;)

    try:
        result = get_filtered_employees(shift, penalty_occurence_time, as_dict=1)
        return response(&#34;Success&#34;, 200, result)
    except Exception as error:
        return response(&#34;Internal Server Error&#34;, 500, None, error)</code></pre>
</details>
</dd>
<dt id="api.v2.legal.get_penalties"><code class="name flex">
<span>def <span class="ident">get_penalties</span></span>(<span>employee_id: str = None, role: str = None) ‑> dict</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@frappe.whitelist()
def get_penalties(employee_id: str = None, role: str = None) -&gt; dict:

        if not employee_id:
                return response(&#34;Bad Request&#34;, 400, None, &#34;employee_id required.&#34;)

        if not isinstance(employee_id, str):
                return response(&#34;Bad Request&#34;, 400, None, &#34;employee_id must be of type str.&#34;)

        if role:
                if not isinstance(role, str):
                        return response(&#34;Bad Request&#34;, 400, None ,&#34;role must be of type str.&#34;)
        try:
                employee = frappe.db.get_value(&#34;Employee&#34;, {&#34;employee_id&#34;: employee_id})

                if not employee:
                        return response(&#34;Resource not found&#34;, 404, None, &#34;No employee found with {employee_id}&#34;.format(employee_id=employee_id))

                if role and role == &#34;Issuance&#34;:
                        result = frappe.get_list(&#34;Penalty&#34;, filters={&#34;issuer_employee&#34;: employee}, fields=[&#34;name&#34;, &#34;penalty_issuance_time&#34;, &#34;workflow_state&#34;], order_by=&#34;modified desc&#34;)
                        if len(result) &gt; 0:
                                return response(&#34;Success&#34;, 200, result)
                        else:
                                return response(&#34;Resource not found&#34;, 404, None, &#34;No penalties found for {employee} with role as {role}&#34;.format(employee=employee, role=role))
                else:
                        result = frappe.get_list(&#34;Penalty&#34;, filters={&#34;recipient_employee&#34;: employee}, fields=[&#34;name&#34;, &#34;penalty_issuance_time&#34;, &#34;workflow_state&#34;], order_by=&#34;modified desc&#34;)
                        if len(result) &gt; 0:
                                return response(&#34;Success&#34;, 200, result)
                        else:
                                return response(&#34;Resource not found&#34;, 404, None, &#34;No penalties found for {employee}&#34;.format(employee=employee))
        
        except Exception as error:
                return response(&#34;Internal Server Error&#34;, 500, None, error)</code></pre>
</details>
</dd>
<dt id="api.v2.legal.get_penalty_details"><code class="name flex">
<span>def <span class="ident">get_penalty_details</span></span>(<span>penalty_name: str = None) ‑> dict</span>
</code></dt>
<dd>
<div class="desc"><p>This method gets the details of a specific penalty provided the name of the penalty document.</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>penalty_name</code></strong> :&ensp;<code>str</code></dt>
<dd>Name of the penalty document.</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>
dict</code></dt>
<dd>{</dd>
</dl>
<p>message (str): Brief message indicating the response,
status_code (int): Status code of response.
data (dict): Penalty deatils.
error (str): Any error handled.
}</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@frappe.whitelist()
def get_penalty_details(penalty_name: str = None) -&gt; dict:
        &#34;&#34;&#34;This method gets the details of a specific penalty provided the name of the penalty document.

        Args:
                penalty_name (str): Name of the penalty document.

        Returns:
                dict: {
            message (str): Brief message indicating the response,
                        status_code (int): Status code of response.
            data (dict): Penalty deatils.
            error (str): Any error handled.
                }
        &#34;&#34;&#34;
        if not penalty_name:
                return response(&#34;Bad Request&#34;, 400, None, &#34;penalty_name required.&#34;)

        if not isinstance(penalty_name, str):
                return response(&#34;Bad Request&#34;, 400, None, &#34;penalty_name must be of type str.&#34;)

        try:
                penalty_doc = frappe.get_doc(&#34;Penalty&#34;, {&#34;name&#34;: penalty_name})
                if not penalty_doc:
                        return response(&#34;Resource not found&#34;, 404, None, &#34;No penalty of name {penalty_doc} found.&#34;.format(penalty_doc=penalty_doc))

                return response(&#34;Success&#34;, 200, penalty_doc.as_dict())
        
        except Exception as error:
                return response(&#34;Internal Server Error&#34;, 500, None, error)</code></pre>
</details>
</dd>
<dt id="api.v2.legal.get_penalty_types"><code class="name flex">
<span>def <span class="ident">get_penalty_types</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"><p>This method gets the list of penalty types.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@frappe.whitelist()
def get_penalty_types():
    &#34;&#34;&#34; This method gets the list of penalty types. &#34;&#34;&#34;
    try:
        result = frappe.db.sql(&#34;&#34;&#34;SELECT name, penalty_name_arabic FROM `tabPenalty Type` &#34;&#34;&#34;, as_dict=1)
        return response(&#34;Success&#34;, 200, result)
    except Exception as error:
        return response(&#34;Internal Server Error&#34;, 500, None, error)</code></pre>
</details>
</dd>
<dt id="api.v2.legal.issue_penalty"><code class="name flex">
<span>def <span class="ident">issue_penalty</span></span>(<span>penalty_category, issuing_time, issuing_location, penalty_location, penalty_occurence_time, company_damage, customer_property_damage, asset_damage, other_damages, shift=None, site=None, project=None, site_location=None, penalty_employees=[], penalty_details=[])</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@frappe.whitelist()
def issue_penalty(penalty_category, issuing_time, issuing_location, penalty_location, penalty_occurence_time,company_damage, customer_property_damage, asset_damage, other_damages, shift=None, site=None, project=None, site_location=None, penalty_employees=[], penalty_details=[]):
        try:
                employee, employee_name, designation = frappe.get_value(&#34;Employee&#34;, {&#34;user_id&#34;: frappe.session.user}, [&#34;name&#34;,&#34;employee_name&#34;, &#34;designation&#34;])

                penalty_issuance = frappe.new_doc(&#34;Penalty Issuance&#34;)
                penalty_issuance.penalty_category = penalty_category
                
                penalty_issuance.issuing_time = issuing_time
                penalty_issuance.location = issuing_location
                penalty_issuance.penalty_location = penalty_location
                penalty_issuance.penalty_occurence_time = penalty_occurence_time

                penalty_issuance.issuing_employee = employee
                penalty_issuance.employee_name = employee_name
                penalty_issuance.designation = designation
                
                penalty_issuance.customer_property_damage = cint(customer_property_damage)
                penalty_issuance.company_damage = cint(company_damage)
                penalty_issuance.other_damages = cint(other_damages)
                penalty_issuance.asset_damage = cint(asset_damage)
                employees = json.loads(penalty_employees)
                for employee in employees:
                        penalty_issuance.append(&#39;employees&#39;, {&#39;employee_id&#39;:employee})

                penalty_issuance_details = json.loads(penalty_details)
                # check and make path for attachments
                path_name = frappe.utils.cstr(frappe.local.site)+&#34;/public/files/Legal&#34;
                if not check_path(path_name):
                        create_path(path_name)

                for detail in penalty_issuance_details:
                        if detail.get(&#34;attachments&#34;) and detail.get(&#34;attachment_name&#34;):
                                filename = detail[&#34;attachment_name&#34;]
                                attach = detail[&#34;attachments&#34;]
                                content = base64.b64decode(attach)

                                OUTPUT_IMAGE_PATH = path_name+&#34;/&#34;+filename
                                fh = open(OUTPUT_IMAGE_PATH, &#34;wb&#34;)
                                fh.write(content)
                                fh.close()
                                Attachment_file=&#34;/files/Legal/&#34;+filename
                                detail.update({&#39;attachments&#39;: Attachment_file})

                        detail.pop(&#34;attachment_name&#34;)
                        penalty_issuance.append(&#39;penalty_issuance_details&#39;, detail)

                if penalty_category == &#34;Performace&#34;:
                        penalty_issuance.shift = shift
                        penalty_issuance.site = site
                        penalty_issuance.project = project
                        penalty_issuance.site_location = site_location


                penalty_issuance.insert()
                penalty_issuance.submit()
                return response(&#34;Success&#34;, 201, penalty_issuance)

        except Exception as error:
                frappe.log_error(error, &#39;Penalty Issance Error&#39;)
                return response(&#34;Internal Server Error&#34;, 500, None, error)@frappe.whitelist()</code></pre>
</details>
</dd>
<dt id="api.v2.legal.reject_penalty"><code class="name flex">
<span>def <span class="ident">reject_penalty</span></span>(<span>rejection_reason: str = None, docname: str = None)</span>
</code></dt>
<dd>
<div class="desc"><p>This method rejects a penalty given a reason and penalty document name.</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>rejection_reason</code></strong> :&ensp;<code>str</code></dt>
<dd>Basis and/or reasoning due to which the employee is rejecting the issuance of penalty.</dd>
<dt><strong><code>docname</code></strong> :&ensp;<code>str</code></dt>
<dd>Name of the penalty doctype.</dd>
</dl>
<p>Returns:
dict: {
message (str): Brief message indicating the response,
status_code (int): Status code of response.
data (dict): penalty rejected document as dictionary,
error (str): Any error handled.
}</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@frappe.whitelist()
def reject_penalty(rejection_reason: str = None, docname: str = None):
        &#34;&#34;&#34; This method rejects a penalty given a reason and penalty document name.
        Args:
                rejection_reason (str): Basis and/or reasoning due to which the employee is rejecting the issuance of penalty.
                docname (str): Name of the penalty doctype.

        Returns: 
                dict: {
                        message (str): Brief message indicating the response,
                        status_code (int): Status code of response.
                        data (dict): penalty rejected document as dictionary,
                        error (str): Any error handled.
                }
        &#34;&#34;&#34;

        if not rejection_reason:
                return response(&#34;Bad Request&#34;, 400, None, &#34;rejection_reason required.&#34;)

        if not docname:
                return response(&#34;Bad Request&#34;, 400, None, &#34;docname required.&#34;)

        if not isinstance(rejection_reason, str):
                return response(&#34;Bad Request&#34;, 400, None, &#34;rejection_reason must be of type str.&#34;)

        if not isinstance(docname, str):
                return response(&#34;Bad Request&#34;, 400, None, &#34;docname must be of type str.&#34;)

        try:
                penalty_doc = frappe.get_doc(&#34;Penalty&#34;, docname)

                if not penalty_doc:
                        return response(&#34;Resource not found&#34;, 404, None, &#34;No penalty of name {penalty_doc} found.&#34;.format(penalty_doc=penalty_doc))

                if penalty_doc.workflow_state == &#39;Penalty Issued&#39;:
                        penalty_doc.reason_for_rejection = rejection_reason
                        penalty_doc.workflow_state = &#34;Penalty Rejected&#34;
                        penalty_doc.save(ignore_permissions=True)
                        frappe.db.commit()
                        
                        return response(&#34;Success&#34;, 201, penalty_doc.as_dict())
                else:
                        return response(&#34;Bad Request&#34;, 400, None, &#34;Penalty has not yet reached workflow state of &#39;Penalty Issued&#39;.&#34;)
        
        except Exception as error:
                return response(&#34;Internal Server Error&#34;, 500, None, error)</code></pre>
</details>
</dd>
</dl>
</section>
<section>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="api.v2" href="index.html">api.v2</a></code></li>
</ul>
</li>
<li><h3><a href="#header-functions">Functions</a></h3>
<ul class="two-column">
<li><code><a title="api.v2.legal.accept_penalty" href="#api.v2.legal.accept_penalty">accept_penalty</a></code></li>
<li><code><a title="api.v2.legal.get_all_shifts" href="#api.v2.legal.get_all_shifts">get_all_shifts</a></code></li>
<li><code><a title="api.v2.legal.get_employee_list" href="#api.v2.legal.get_employee_list">get_employee_list</a></code></li>
<li><code><a title="api.v2.legal.get_penalties" href="#api.v2.legal.get_penalties">get_penalties</a></code></li>
<li><code><a title="api.v2.legal.get_penalty_details" href="#api.v2.legal.get_penalty_details">get_penalty_details</a></code></li>
<li><code><a title="api.v2.legal.get_penalty_types" href="#api.v2.legal.get_penalty_types">get_penalty_types</a></code></li>
<li><code><a title="api.v2.legal.issue_penalty" href="#api.v2.legal.issue_penalty">issue_penalty</a></code></li>
<li><code><a title="api.v2.legal.reject_penalty" href="#api.v2.legal.reject_penalty">reject_penalty</a></code></li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc" title="pdoc: Python API documentation generator"><cite>pdoc</cite> 0.10.0</a>.</p>
</footer>
</body>
</html>